<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Wellness Intelligence Lab â€” Shah Hayaat</title>
  <meta name="description" content="Shah Hayaat Digital Wellness Intelligence Lab â€” 18 browser-based assessment modules measuring cognitive performance, respiratory health, stress resilience, motor stability and more. Zero data stored.">
  <meta name="robots" content="index, follow">
  <link rel="icon" href="https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/logo.jpg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
/* ============================================================
   SHAH HAYAAT â€” WELLNESS LAB  v1.0
   Part 1: Foundation, Disclaimer, Header, Welcome, Gender
   ============================================================ */

/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; font-size: 16px; }
img  { max-width: 100%; height: auto; display: block; }
a    { color: inherit; text-decoration: none; }
ul   { list-style: none; }
button, input, select, textarea { font-family: inherit; }

/* â”€â”€ Lab Design Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  /* Core palette â€” deep scientific dark */
  --ink:         #04080A;
  --ink-2:       #0A1214;
  --ink-3:       #101B1E;
  --ink-4:       #172028;
  --surface:     #1A2730;
  --border:      rgba(56, 180, 140, 0.16);
  --border-h:    rgba(56, 180, 140, 0.42);

  /* Accent: bio-luminescent teal-green */
  --lab:         #38B48C;
  --lab-bright:  #4EEDB8;
  --lab-dim:     rgba(56, 180, 140, 0.18);
  --lab-glow:    0 0 28px rgba(56,180,140,0.22), 0 0 60px rgba(56,180,140,0.08);

  /* Gold â€” Shah Hayaat brand */
  --gold:        #C9960C;
  --gold-bright: #F0B929;
  --gold-dim:    rgba(201,150,12,0.16);

  /* Status colours */
  --red:         #E85555;
  --amber:       #F0A020;
  --green-ok:    #3EBA7C;

  /* Text */
  --text:        #D6EAE4;
  --text-mid:    rgba(214,234,228,0.62);
  --text-muted:  rgba(214,234,228,0.35);

  /* Typography */
  --font-head:   'Cormorant Garamond', Georgia, serif;
  --font-body:   'DM Sans', system-ui, sans-serif;
  --font-mono:   'JetBrains Mono', 'Courier New', monospace;

  /* Motion */
  --ease:        cubic-bezier(0.4, 0, 0.2, 1);
  --t:           0.3s;
  --radius:      16px;
  --radius-sm:   10px;
  --radius-xs:   6px;
}

/* â”€â”€ Page Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
html, body {
  min-height: 100%;
  background: var(--ink);
  color: var(--text);
  font-family: var(--font-body);
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* Subtle scan-line texture overlay */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(56,180,140,0.012) 2px,
      rgba(56,180,140,0.012) 4px
    );
}

/* â”€â”€ Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 1.5rem;
  position: relative; z-index: 1;
}
.lab-container--wide { max-width: 1100px; }

/* â”€â”€ Typography â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-h1 {
  font-family: var(--font-head);
  font-size: clamp(2.4rem, 6vw, 4rem);
  font-weight: 700;
  line-height: 1.1;
  letter-spacing: -0.01em;
  color: var(--text);
}
.lab-h2 {
  font-family: var(--font-head);
  font-size: clamp(1.6rem, 4vw, 2.4rem);
  font-weight: 700;
  line-height: 1.2;
  color: var(--text);
}
.lab-h3 {
  font-family: var(--font-head);
  font-size: clamp(1.1rem, 2.5vw, 1.5rem);
  font-weight: 600;
  color: var(--text);
  line-height: 1.3;
}
.lab-p {
  font-size: clamp(0.9rem, 1.8vw, 1.02rem);
  color: var(--text-mid);
  line-height: 1.78;
}
.mono {
  font-family: var(--font-mono);
  letter-spacing: 0.02em;
}

/* â”€â”€ Tag/Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-tag {
  display: inline-flex; align-items: center; gap: 0.4rem;
  font-family: var(--font-mono);
  font-size: 0.66rem; font-weight: 500;
  letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--lab);
  background: var(--lab-dim);
  border: 1px solid var(--border-h);
  border-radius: 50px;
  padding: 0.3rem 0.85rem;
}
.lab-tag--gold { color: var(--gold-bright); background: var(--gold-dim); border-color: rgba(201,150,12,0.3); }
.lab-tag--red  { color: var(--red); background: rgba(232,85,85,0.1); border-color: rgba(232,85,85,0.3); }

/* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-divider {
  width: 100%; height: 1px;
  background: linear-gradient(90deg, transparent, var(--border-h), transparent);
}

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-card {
  background: var(--ink-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: clamp(1.8rem, 4vw, 2.8rem);
  position: relative; overflow: hidden;
}
.lab-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--lab), transparent);
  opacity: 0.4;
}
.lab-card--glow {
  box-shadow: var(--lab-glow);
}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
  font-family: var(--font-body); font-weight: 600; font-size: 0.9rem;
  padding: 0.82rem 2rem; border-radius: 50px;
  border: 2px solid transparent; cursor: pointer;
  transition: all var(--t) var(--ease);
  white-space: nowrap; position: relative; overflow: hidden;
}
.lab-btn::after {
  content: ''; position: absolute; inset: 0; border-radius: 50px;
  background: rgba(255,255,255,0); transition: background 0.2s;
}
.lab-btn:hover::after { background: rgba(255,255,255,0.06); }

.lab-btn--primary {
  background: linear-gradient(135deg, var(--lab), var(--lab-bright));
  color: var(--ink); box-shadow: 0 4px 20px rgba(56,180,140,0.32);
}
.lab-btn--primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 32px rgba(56,180,140,0.48);
}
.lab-btn--ghost {
  background: transparent;
  border-color: var(--border-h);
  color: var(--text-mid);
}
.lab-btn--ghost:hover { border-color: var(--lab); color: var(--text); }

.lab-btn--gold {
  background: linear-gradient(135deg, var(--gold), var(--gold-bright));
  color: var(--ink); box-shadow: 0 4px 20px rgba(201,150,12,0.32);
}
.lab-btn--gold:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 32px rgba(201,150,12,0.48);
}
.lab-btn--lg { padding: 1.05rem 2.5rem; font-size: 1rem; }
.lab-btn--sm { padding: 0.52rem 1.3rem; font-size: 0.82rem; }
.lab-btn--full { width: 100%; }
.lab-btn:disabled { opacity: 0.38; cursor: not-allowed; pointer-events: none; }

.lab-btn-row {
  display: flex; flex-wrap: wrap; gap: 0.85rem; align-items: center;
  margin-top: 2rem;
}

/* â”€â”€ Form Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-field { margin-bottom: 1.25rem; }
.lab-label {
  display: block;
  font-family: var(--font-mono); font-size: 0.68rem; font-weight: 500;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--text-muted); margin-bottom: 0.5rem;
}
.lab-input, .lab-select {
  width: 100%; padding: 0.78rem 1.1rem;
  background: var(--ink-4); border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text);
  font-family: var(--font-body); font-size: 0.97rem;
  outline: none; transition: border-color var(--t); -webkit-appearance: none;
}
.lab-input:focus, .lab-select:focus {
  border-color: var(--lab);
  box-shadow: 0 0 0 3px rgba(56,180,140,0.14);
}
.lab-select option { background: var(--ink-3); }

.lab-grid-2 {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
}
@media(max-width: 480px) { .lab-grid-2 { grid-template-columns: 1fr; } }

/* â”€â”€ Range Slider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-range {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 5px;
  background: var(--surface); border-radius: 3px; outline: none;
  border: 1px solid var(--border); cursor: pointer;
}
.lab-range::-webkit-slider-thumb {
  -webkit-appearance: none; width: 20px; height: 20px;
  background: linear-gradient(135deg, var(--lab), var(--lab-bright));
  border-radius: 50%; cursor: pointer;
  box-shadow: 0 0 10px rgba(56,180,140,0.5);
}
.lab-range-labels {
  display: flex; justify-content: space-between;
  font-family: var(--font-mono); font-size: 0.66rem;
  color: var(--text-muted); margin-top: 0.4rem;
}

/* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-progress {
  margin-bottom: 2.5rem; position: relative; z-index: 1;
}
.lab-progress-meta {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 0.55rem;
}
.lab-progress-meta span {
  font-family: var(--font-mono); font-size: 0.68rem;
  color: var(--text-muted);
}
.lab-progress-meta .lab-progress-label { color: var(--lab); }
.lab-progress-track {
  height: 3px; background: var(--ink-4);
  border-radius: 2px; overflow: hidden;
  border: 1px solid var(--border);
}
.lab-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--lab), var(--lab-bright));
  border-radius: 2px;
  transition: width 0.7s var(--ease);
  position: relative;
}
.lab-progress-fill::after {
  content: '';
  position: absolute; right: 0; top: 50%; transform: translateY(-50%);
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--lab-bright);
  box-shadow: 0 0 10px var(--lab-bright);
}

/* â”€â”€ Score Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-score-row {
  display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 1.25rem 0;
}
.lab-score-badge {
  background: var(--ink-4); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 0.65rem 1rem;
  min-width: 90px;
}
.lab-score-badge .val {
  font-family: var(--font-mono); font-size: 1.15rem; font-weight: 600;
  color: var(--lab); display: block; line-height: 1;
}
.lab-score-badge .lbl {
  font-family: var(--font-mono); font-size: 0.62rem;
  color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 0.08em; margin-top: 0.22rem; display: block;
}

/* â”€â”€ Step Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-step-head { margin-bottom: 1.8rem; }
.lab-step-head .lab-tag { margin-bottom: 1rem; }
.lab-step-head h2 { margin-bottom: 0.55rem; }
.lab-step-head .lab-p { max-width: 580px; }

/* â”€â”€ Notification Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-notice {
  display: flex; align-items: flex-start; gap: 0.85rem;
  padding: 1rem 1.25rem;
  background: var(--ink-4); border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.87rem; line-height: 1.65;
}
.lab-notice .notice-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 0.1rem; }
.lab-notice strong { color: var(--text); font-weight: 600; }
.lab-notice p { color: var(--text-mid); margin: 0; }

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes lab-fade-up {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes lab-fade-in {
  from { opacity: 0; }
  to   { opacity: 1; }
}
@keyframes lab-pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50%       { opacity: 0.6; transform: scale(0.97); }
}
@keyframes lab-glow-pulse {
  0%, 100% { box-shadow: 0 0 20px rgba(56,180,140,0.2); }
  50%       { box-shadow: 0 0 40px rgba(56,180,140,0.45); }
}
@keyframes lab-scan {
  0%   { transform: translateY(-100%); }
  100% { transform: translateY(100vh); }
}
@keyframes lab-blink {
  0%, 100% { opacity: 1; }
  50%       { opacity: 0; }
}
@keyframes lab-slide-in {
  from { opacity: 0; transform: translateX(-16px); }
  to   { opacity: 1; transform: translateX(0); }
}
@keyframes lab-pop {
  from { opacity: 0; transform: scale(0.94); }
  to   { opacity: 1; transform: scale(1); }
}
@keyframes disclaimer-pulse-red {
  0%, 100% { border-bottom-color: rgba(232,85,85,0.5); }
  50%       { border-bottom-color: rgba(232,85,85,1); }
}

.animate-fade-up { animation: lab-fade-up 0.5s var(--ease) both; }
.animate-fade-up.d1 { animation-delay: 0.1s; }
.animate-fade-up.d2 { animation-delay: 0.2s; }
.animate-fade-up.d3 { animation-delay: 0.3s; }
.animate-fade-up.d4 { animation-delay: 0.4s; }
.animate-pop { animation: lab-pop 0.42s var(--ease) both; }

/* ============================================================
   DISCLAIMER BANNER
   ============================================================ */
#labDisclaimer {
  position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
  background: #050808;
  border-bottom: 2px solid rgba(232,85,85,0.6);
  animation: disclaimer-pulse-red 2.5s ease-in-out infinite;
}
.disclaimer-slides { height: 52px; position: relative; overflow: hidden; }

.disclaimer-slide {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  gap: 0.6rem; padding: 0 1.5rem;
  font-family: var(--font-mono);
  font-size: clamp(0.62rem, 1.6vw, 0.8rem);
  font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase;
  text-align: center;
  opacity: 0;
  transform: translateY(8px);
  transition: opacity 0.7s ease, transform 0.7s ease;
  pointer-events: none;
}
.disclaimer-slide.ds-active {
  opacity: 1; transform: translateY(0);
}
.disclaimer-slide.ds-0 { color: var(--red); }
.disclaimer-slide.ds-1 { color: var(--lab-bright); }
.disclaimer-slide.ds-2 { color: var(--gold-bright); }

.disclaimer-slide .ds-icon {
  font-size: 1rem; flex-shrink: 0;
}

.disclaimer-dots {
  display: flex; justify-content: center; align-items: center;
  gap: 5px; padding: 0 0 7px;
}
.disclaimer-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: rgba(255,255,255,0.15);
  transition: background 0.4s, transform 0.3s;
}
.disclaimer-dot.dd-active {
  background: var(--red); transform: scale(1.4);
}

/* ============================================================
   SITE HEADER
   ============================================================ */
#labHeader {
  position: sticky; top: 52px; z-index: 900;
  background: rgba(4,8,10,0.9);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-bottom: 1px solid var(--border);
  padding: 0.9rem 0;
  transition: padding var(--t) var(--ease);
}
.lab-header-inner {
  max-width: 1200px; margin: 0 auto; padding: 0 1.5rem;
  display: flex; align-items: center; justify-content: space-between; gap: 1rem;
}

/* Logo */
.lab-logo {
  display: flex; align-items: center; gap: 0.85rem;
  text-decoration: none; flex-shrink: 0;
}
.lab-logo-img {
  width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
  border: 2px solid var(--lab); box-shadow: 0 0 12px rgba(56,180,140,0.35);
}
.lab-logo-text {
  font-family: var(--font-head); font-size: 1.1rem; font-weight: 700;
  color: var(--text); line-height: 1.1;
}
.lab-logo-text em { font-style: normal; color: var(--gold-bright); }
.lab-logo-sub {
  font-family: var(--font-mono); font-size: 0.6rem;
  color: var(--lab); letter-spacing: 0.12em; text-transform: uppercase;
  margin-top: 0.12rem;
}

/* Status indicator */
.lab-status-pill {
  display: flex; align-items: center; gap: 0.5rem;
  font-family: var(--font-mono); font-size: 0.66rem;
  color: var(--text-muted); letter-spacing: 0.06em;
  text-transform: uppercase;
}
.lab-status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--lab-bright);
  animation: lab-pulse 2s ease-in-out infinite;
  box-shadow: 0 0 6px var(--lab-bright);
}
.lab-status-dot.idle { background: var(--amber); box-shadow: 0 0 6px var(--amber); animation: none; }

/* Back button */
.lab-nav-btn {
  display: flex; align-items: center; gap: 0.4rem;
  font-family: var(--font-body); font-size: 0.82rem; font-weight: 500;
  color: var(--text-muted); background: none;
  border: 1px solid var(--border);
  border-radius: 50px; padding: 0.45rem 1.1rem;
  cursor: pointer; transition: all 0.22s; text-decoration: none;
}
.lab-nav-btn:hover { color: var(--text); border-color: var(--lab); }

/* ============================================================
   WELCOME â€” HERO SECTION
   ============================================================ */
#labWelcome { position: relative; z-index: 1; }

.lab-hero {
  padding: clamp(4rem, 10vw, 7rem) 0 clamp(3rem, 7vw, 5rem);
  position: relative; overflow: hidden;
}

/* Radial gradient background glow */
.lab-hero::before {
  content: '';
  position: absolute;
  top: -60px; left: 50%; transform: translateX(-50%);
  width: 800px; height: 500px;
  background: radial-gradient(ellipse, rgba(56,180,140,0.07) 0%, transparent 70%);
  pointer-events: none;
}

/* Animated corner brackets */
.lab-hero::after {
  content: '';
  position: absolute; top: 2rem; right: 2rem;
  width: 60px; height: 60px;
  border-top: 2px solid var(--lab);
  border-right: 2px solid var(--lab);
  opacity: 0.3;
}

.lab-hero-inner {
  position: relative; z-index: 1;
}

.lab-hero-eyebrow {
  display: flex; align-items: center; gap: 0.75rem;
  margin-bottom: 1.8rem;
  animation: lab-fade-up 0.6s var(--ease) both;
}

.lab-hero-title {
  font-family: var(--font-head);
  font-size: clamp(2.8rem, 7vw, 5.2rem);
  font-weight: 700; line-height: 1.05;
  letter-spacing: -0.02em; margin-bottom: 1.4rem;
  animation: lab-fade-up 0.6s var(--ease) 0.1s both;
}
.lab-hero-title .accent { color: var(--lab); display: block; }
.lab-hero-title .accent-gold { color: var(--gold-bright); }

.lab-hero-desc {
  font-size: clamp(0.95rem, 2vw, 1.1rem);
  color: var(--text-mid); line-height: 1.78;
  max-width: 560px; margin-bottom: 2.5rem;
  animation: lab-fade-up 0.6s var(--ease) 0.2s both;
}

.lab-hero-btns {
  animation: lab-fade-up 0.6s var(--ease) 0.3s both;
}

/* Module pills strip */
.lab-modules-strip {
  padding: 2.5rem 0;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  animation: lab-fade-up 0.6s var(--ease) 0.4s both;
}
.lab-modules-strip-label {
  font-family: var(--font-mono); font-size: 0.62rem;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.12em;
  margin-bottom: 1rem;
}
.lab-pills {
  display: flex; flex-wrap: wrap; gap: 0.5rem;
}
.lab-pill {
  display: inline-flex; align-items: center; gap: 0.35rem;
  padding: 0.32rem 0.85rem;
  background: var(--ink-3); border: 1px solid var(--border);
  border-radius: 50px;
  font-family: var(--font-mono); font-size: 0.68rem;
  color: var(--text-muted); white-space: nowrap;
  transition: all 0.2s;
}
.lab-pill:hover { border-color: var(--lab); color: var(--lab); }
.lab-pill .pill-icon { font-size: 0.85rem; }

/* Stat row */
.lab-stats-row {
  display: flex; flex-wrap: wrap; gap: 1rem;
  padding: 2.5rem 0;
  animation: lab-fade-up 0.6s var(--ease) 0.5s both;
}
.lab-stat-item {
  flex: 1; min-width: 110px;
  background: var(--ink-3); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 1.2rem;
  text-align: center;
}
.lab-stat-num {
  font-family: var(--font-mono); font-size: 2rem; font-weight: 600;
  color: var(--lab); line-height: 1; display: block; margin-bottom: 0.3rem;
}
.lab-stat-lbl {
  font-family: var(--font-mono); font-size: 0.62rem;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;
}

/* ============================================================
   INSTRUCTIONS CARD
   ============================================================ */
#labInstructions {
  padding-bottom: clamp(3rem, 6vw, 5rem);
  position: relative; z-index: 1;
}

.instructions-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 1rem; margin-bottom: 2rem;
}
@media(max-width: 600px) { .instructions-grid { grid-template-columns: 1fr; } }

.instruction-item {
  display: flex; align-items: flex-start; gap: 1rem;
  padding: 1.15rem;
  background: var(--ink-4); border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  transition: border-color var(--t);
}
.instruction-item:hover { border-color: var(--lab); }
.instruction-item .i-icon {
  width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
  background: var(--lab-dim); border: 1px solid var(--border-h);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
}
.instruction-item .i-body strong {
  display: block; font-size: 0.88rem; font-weight: 600;
  color: var(--text); margin-bottom: 0.2rem;
}
.instruction-item .i-body p {
  font-size: 0.8rem; color: var(--text-mid); line-height: 1.55; margin: 0;
}

/* ============================================================
   GENDER SELECTION
   ============================================================ */
#labGender { display: none; position: relative; z-index: 1; }

.gender-select-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 1rem; max-width: 420px;
}
@media(max-width: 480px) { .gender-select-grid { grid-template-columns: 1fr; } }

.gender-card {
  background: var(--ink-4); border: 2px solid var(--border);
  border-radius: var(--radius); padding: 2rem 1.5rem;
  text-align: center; cursor: pointer;
  transition: all var(--t) var(--ease);
  position: relative; overflow: hidden;
}
.gender-card::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(56,180,140,0), rgba(56,180,140,0.06));
  opacity: 0; transition: opacity var(--t);
}
.gender-card:hover { border-color: var(--border-h); transform: translateY(-4px); }
.gender-card:hover::before { opacity: 1; }
.gender-card.selected {
  border-color: var(--lab);
  box-shadow: 0 0 0 3px rgba(56,180,140,0.15), var(--lab-glow);
  animation: lab-glow-pulse 2s ease-in-out infinite;
}
.gender-card.selected::before { opacity: 1; }

.gender-icon { font-size: 2.8rem; margin-bottom: 0.85rem; display: block; }
.gender-title {
  font-family: var(--font-head); font-size: 1.1rem; font-weight: 700;
  color: var(--text); margin-bottom: 0.3rem;
}
.gender-note {
  font-family: var(--font-mono); font-size: 0.62rem;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em;
}
.gender-card.selected .gender-title { color: var(--lab-bright); }
.gender-card.selected .gender-note { color: var(--lab); }

/* Selected checkmark */
.gender-check {
  position: absolute; top: 0.75rem; right: 0.75rem;
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--lab); border: 2px solid var(--lab);
  display: none; align-items: center; justify-content: center;
  font-size: 0.7rem; color: var(--ink); font-weight: 700;
}
.gender-card.selected .gender-check { display: flex; }

/* Female note */
.female-modules-note {
  margin-top: 1.5rem; padding: 1rem 1.25rem;
  background: var(--gold-dim); border: 1px solid rgba(201,150,12,0.25);
  border-radius: var(--radius-sm);
  display: none; align-items: flex-start; gap: 0.7rem;
}
.female-modules-note.show { display: flex; }
.female-modules-note p {
  font-size: 0.82rem; color: rgba(240,185,41,0.85); line-height: 1.6; margin: 0;
}

/* ============================================================
   PLACEHOLDER â€” Module View
   (Will be filled in by Parts 2, 3, 4)
   ============================================================ */
#labModules {
  display: none;
  min-height: 60vh;
  position: relative; z-index: 1;
  padding: clamp(2rem, 5vw, 4rem) 0;
}

/* Generic module step card wrapper */
.lab-module-wrap {
  animation: lab-fade-up 0.42s var(--ease) both;
}

/* ============================================================
   FOOTER STRIP
   ============================================================ */
.lab-footer-strip {
  border-top: 1px solid var(--border);
  padding: 1.5rem 0;
  text-align: center;
  position: relative; z-index: 1;
}
.lab-footer-strip p {
  font-family: var(--font-mono); font-size: 0.64rem;
  color: var(--text-muted); letter-spacing: 0.06em;
  line-height: 1.7;
}
.lab-footer-strip a { color: var(--lab); }

/* ============================================================
   SCROLL-BASED HEADER SHRINK
   ============================================================ */
body.lab-scrolled #labHeader { padding: 0.55rem 0; }

/* ============================================================
   RESPONSIVE OVERRIDES
   ============================================================ */
@media(max-width: 640px) {
  .lab-hero-title { letter-spacing: -0.01em; }
  .lab-btn--lg { padding: 0.9rem 1.8rem; width: 100%; max-width: 320px; }
  .lab-stats-row { gap: 0.75rem; }
  .lab-stat-num { font-size: 1.6rem; }
}

/* ============================================================
   ACCESSIBILITY
   ============================================================ */
:focus-visible {
  outline: 2px solid var(--lab);
  outline-offset: 3px;
  border-radius: 4px;
}
.sr-only {
  position: absolute; width: 1px; height: 1px;
  padding: 0; margin: -1px; overflow: hidden;
  clip: rect(0,0,0,0); white-space: nowrap; border: 0;
}

  </style>
</head>
<body>

<!-- ============================================================
     DISCLAIMER BANNER (Fixed, always visible)
     ============================================================ -->
<div id="labDisclaimer" role="complementary" aria-label="Important disclaimers">
  <div class="disclaimer-slides">

    <div class="disclaimer-slide ds-0 ds-active" id="ds-0" aria-live="polite">
      <span class="ds-icon">âš </span>
      THIS PLATFORM PROVIDES WELLNESS INDICATORS ONLY &mdash; NOT A MEDICAL DIAGNOSTIC TOOL
    </div>

    <div class="disclaimer-slide ds-1" id="ds-1">
      <span class="ds-icon">ğŸ”</span>
      WE DO NOT STORE, SAVE OR TRANSMIT ANY PERSONAL DATA &mdash; ALL CALCULATIONS RUN LOCALLY IN YOUR BROWSER
    </div>

    <div class="disclaimer-slide ds-2" id="ds-2">
      <span class="ds-icon">ğŸ©º</span>
      FOR ANY MEDICAL CONCERNS, ALWAYS CONSULT A QUALIFIED HEALTHCARE PROFESSIONAL
    </div>

  </div>
  <div class="disclaimer-dots" aria-hidden="true">
    <div class="disclaimer-dot dd-active" id="dd-0"></div>
    <div class="disclaimer-dot" id="dd-1"></div>
    <div class="disclaimer-dot" id="dd-2"></div>
  </div>
</div>

<!-- Top padding for fixed disclaimer -->
<div style="height:52px" aria-hidden="true"></div>


<!-- ============================================================
     SITE HEADER
     ============================================================ -->
<header id="labHeader" role="banner">
  <div class="lab-header-inner">

    <!-- Logo -->
    <a href="index.html" class="lab-logo" aria-label="Shah Hayaat â€” back to main site">
      <img src="https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/logo.jpg"
           alt="Shah Hayaat" class="lab-logo-img" loading="eager">
      <div>
        <div class="lab-logo-text">Shah <em>Hayaat</em></div>
        <div class="lab-logo-sub">Digital Wellness Lab</div>
      </div>
    </a>

    <!-- Centre status -->
    <div class="lab-status-pill" id="headerStatus" aria-live="polite">
      <div class="lab-status-dot idle" id="headerDot"></div>
      <span id="headerStatusText">Ready</span>
    </div>

    <!-- Back link -->
    <a href="index.html" class="lab-nav-btn" aria-label="Return to Shah Hayaat website">
      â† Back to Site
    </a>

  </div>
</header>


<!-- ============================================================
     WELCOME SCREEN
     ============================================================ -->
<section id="labWelcome" role="main" aria-labelledby="welcomeTitle">

  <!-- Hero -->
  <div class="lab-hero">
    <div class="lab-container">
      <div class="lab-hero-inner">

        <div class="lab-hero-eyebrow">
          <div class="lab-tag">ğŸ§ª 18 Wellness Modules</div>
          <div class="lab-tag lab-tag--gold">âš¡ Browser-Only Â· Zero Data</div>
        </div>

        <h1 class="lab-hero-title" id="welcomeTitle">
          Digital Wellness
          <span class="accent">Intelligence Lab</span>
        </h1>

        <p class="lab-hero-desc">
          An advanced browser-based wellness assessment platform.
          18 activity modules measuring cognitive performance, respiratory
          health, stress resilience, motor stability and lifestyle patterns â€”
          all computed locally on your device. Nothing stored. Nothing transmitted.
        </p>

        <div class="lab-hero-btns lab-btn-row" style="margin-top:0">
          <button class="lab-btn lab-btn--primary lab-btn--lg"
                  onclick="LAB.showInstructions()"
                  aria-label="Begin assessment">
            Begin Assessment â†’
          </button>
          <a href="#labModuleList" class="lab-btn lab-btn--ghost">
            View All Modules
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="lab-container">
    <div class="lab-stats-row" role="list" aria-label="Assessment statistics">
      <div class="lab-stat-item" role="listitem">
        <span class="lab-stat-num">18</span>
        <span class="lab-stat-lbl">Modules</span>
      </div>
      <div class="lab-stat-item" role="listitem">
        <span class="lab-stat-num">~15</span>
        <span class="lab-stat-lbl">Minutes</span>
      </div>
      <div class="lab-stat-item" role="listitem">
        <span class="lab-stat-num">6</span>
        <span class="lab-stat-lbl">Health Scores</span>
      </div>
      <div class="lab-stat-item" role="listitem">
        <span class="lab-stat-num">0</span>
        <span class="lab-stat-lbl">Data Stored</span>
      </div>
      <div class="lab-stat-item" role="listitem">
        <span class="lab-stat-num">100%</span>
        <span class="lab-stat-lbl">Private</span>
      </div>
    </div>
  </div>

  <!-- Module list -->
  <div class="lab-container" style="padding-bottom:3rem" id="labModuleList">
    <div class="lab-modules-strip">
      <p class="lab-modules-strip-label">Assessment modules included</p>
      <div class="lab-pills" role="list" aria-label="Module list">
        <div class="lab-pill" role="listitem"><span class="pill-icon">âš¡</span> Reaction Speed</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ“‰</span> Fatigue Drift</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ§©</span> Working Memory</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ‘</span> Attention Focus</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸŒ¬</span> Breath Sync</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">â±</span> COâ‚‚ Tolerance</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">â™»ï¸</span> Recovery</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ”¥</span> Cognition Under Pressure</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ”·</span> Pattern Overload</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ“±</span> Stability Hold</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">âœ‹</span> Micro Tremor</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">ğŸ’¤</span> Sleep Efficiency</div>
        <div class="lab-pill" role="listitem"><span class="pill-icon">âš–ï¸</span> Lifestyle Load</div>
        <div class="lab-pill lab-pill--female" role="listitem" style="border-color:rgba(201,150,12,0.3);color:rgba(240,185,41,0.7)"><span class="pill-icon">ğŸŒ¸</span> Hormonal Rhythm</div>
        <div class="lab-pill lab-pill--female" role="listitem" style="border-color:rgba(201,150,12,0.3);color:rgba(240,185,41,0.7)"><span class="pill-icon">âš¡</span> Energy &amp; Iron</div>
        <div class="lab-pill lab-pill--female" role="listitem" style="border-color:rgba(201,150,12,0.3);color:rgba(240,185,41,0.7)"><span class="pill-icon">âœ¨</span> Hormonal Skin</div>
        <div class="lab-pill lab-pill--female" role="listitem" style="border-color:rgba(201,150,12,0.3);color:rgba(240,185,41,0.7)"><span class="pill-icon">ğŸŒ™</span> Sleep-Cycle</div>
        <div class="lab-pill lab-pill--female" role="listitem" style="border-color:rgba(201,150,12,0.3);color:rgba(240,185,41,0.7)"><span class="pill-icon">ğŸŒ¸</span> Pelvic Comfort</div>
        <span style="font-family:var(--font-mono);font-size:0.62rem;color:var(--text-muted);align-self:center;padding:0 0.4rem">
          &nbsp; ğŸŒ¸ = Female-specific
        </span>
      </div>
    </div>
  </div>

</section>


<!-- ============================================================
     INSTRUCTIONS CARD
     ============================================================ -->
<section id="labInstructions" style="display:none" role="region" aria-labelledby="instrTitle">
  <div class="lab-container" style="padding: clamp(2.5rem,6vw,4.5rem) 1.5rem">

    <div class="lab-card lab-card--glow animate-pop">

      <div class="lab-step-head">
        <div class="lab-tag">ğŸ“‹ Before You Begin</div>
        <h2 class="lab-h2" id="instrTitle" style="margin-top:1rem;margin-bottom:0.6rem">
          What to Expect
        </h2>
        <p class="lab-p">
          Read these notes once â€” they'll help you get the most accurate results
          and understand what each module is measuring.
        </p>
      </div>

      <div class="instructions-grid">

        <div class="instruction-item animate-fade-up d1">
          <div class="i-icon">ğŸ”</div>
          <div class="i-body">
            <strong>Zero Data Storage</strong>
            <p>No information leaves your device. No server calls, no cookies, no tracking. Everything runs in browser memory only.</p>
          </div>
        </div>

        <div class="instruction-item animate-fade-up d2">
          <div class="i-icon">ğŸ“±</div>
          <div class="i-body">
            <strong>Mobile Recommended</strong>
            <p>The motor stability module uses your device's motion sensor. For best results, use a smartphone.</p>
          </div>
        </div>

        <div class="instruction-item animate-fade-up d2">
          <div class="i-icon">âš•ï¸</div>
          <div class="i-body">
            <strong>Wellness Indicators Only</strong>
            <p>Results are not medical diagnoses. They are activity-based wellness indicators. Consult a doctor for medical concerns.</p>
          </div>
        </div>

        <div class="instruction-item animate-fade-up d3">
          <div class="i-icon">ğŸ¯</div>
          <div class="i-body">
            <strong>Be Honest &amp; Relaxed</strong>
            <p>For activity tests, find a quiet spot and focus. For questionnaires, answer based on your genuine average â€” not your best day.</p>
          </div>
        </div>

        <div class="instruction-item animate-fade-up d3">
          <div class="i-icon">â±</div>
          <div class="i-body">
            <strong>~15 Minutes Total</strong>
            <p>The complete assessment takes 12â€“18 minutes. You can see your full report at the end with a downloadable PDF.</p>
          </div>
        </div>

        <div class="instruction-item animate-fade-up d4">
          <div class="i-icon">ğŸ“„</div>
          <div class="i-body">
            <strong>Downloadable Report</strong>
            <p>A professional PDF report is generated locally at the end â€” Shah Hayaat branding, scores, wellness tips and product suggestions.</p>
          </div>
        </div>

      </div>

      <!-- Legal notice -->
      <div class="lab-notice" style="margin-bottom:2rem" role="note">
        <div class="notice-icon">âš–ï¸</div>
        <p>
          <strong>Legal &amp; Ethical Note: </strong>
          This platform does not diagnose medical conditions, does not make disease claims and does not store or transmit personal health data.
          It is a wellness indicator tool only. All calculations are performed exclusively within your browser session.
          Results are deleted when you close or refresh the page.
        </p>
      </div>

      <div class="lab-btn-row">
        <button class="lab-btn lab-btn--primary lab-btn--lg"
                onclick="LAB.showGender()"
                aria-label="Proceed to gender selection">
          I Understand â€” Continue â†’
        </button>
        <button class="lab-btn lab-btn--ghost"
                onclick="LAB.showWelcome()"
                aria-label="Go back to welcome screen">
          â† Back
        </button>
      </div>

    </div>
  </div>
</section>


<!-- ============================================================
     GENDER SELECTION
     ============================================================ -->
<section id="labGender" role="region" aria-labelledby="genderTitle">
  <div class="lab-container" style="padding: clamp(2.5rem,6vw,4.5rem) 1.5rem">

    <div class="lab-card lab-card--glow animate-pop">

      <div class="lab-step-head">
        <div class="lab-tag">ğŸ‘¤ Setup</div>
        <h2 class="lab-h2" id="genderTitle" style="margin-top:1rem;margin-bottom:0.6rem">
          Biological Sex
        </h2>
        <p class="lab-p">
          Your selection activates the relevant assessment modules.
          The female option adds 5 additional hormonal wellness modules (modules 14â€“18).
          This is used <em>only</em> to personalise your assessment
          â€” it is never stored or transmitted.
        </p>
      </div>

      <div class="gender-select-grid" role="group" aria-label="Select biological sex">

        <div class="gender-card"
             id="genderMale"
             role="radio" aria-checked="false" tabindex="0"
             onclick="LAB.selectGender('male')"
             onkeydown="if(event.key==='Enter'||event.key===' ') LAB.selectGender('male')">
          <div class="gender-check" aria-hidden="true">âœ“</div>
          <span class="gender-icon">â™‚</span>
          <div class="gender-title">Male</div>
          <div class="gender-note">13 core modules</div>
        </div>

        <div class="gender-card"
             id="genderFemale"
             role="radio" aria-checked="false" tabindex="0"
             onclick="LAB.selectGender('female')"
             onkeydown="if(event.key==='Enter'||event.key===' ') LAB.selectGender('female')">
          <div class="gender-check" aria-hidden="true">âœ“</div>
          <span class="gender-icon">â™€</span>
          <div class="gender-title">Female</div>
          <div class="gender-note">13 + 5 female modules</div>
        </div>

      </div>

      <!-- Female extra info -->
      <div class="female-modules-note" id="femaleNote" role="note">
        <span style="font-size:1.1rem;flex-shrink:0">ğŸŒ¸</span>
        <p>
          <strong style="color:var(--gold-bright)">5 Additional Female Modules Activated: </strong>
          Hormonal Rhythm, Energy &amp; Iron, Hormonal Skin Impact, Sleep-Cycle Disruption
          and Pelvic Comfort Indicator. All responses remain private and local.
        </p>
      </div>

      <div class="lab-btn-row">
        <button class="lab-btn lab-btn--primary lab-btn--lg"
                id="genderContinueBtn"
                onclick="LAB.startModules()"
                disabled
                aria-label="Start assessment">
          Start Assessment â†’
        </button>
        <button class="lab-btn lab-btn--ghost"
                onclick="LAB.showInstructions()"
                aria-label="Back to instructions">
          â† Back
        </button>
      </div>

    </div>
  </div>
</section>


<!-- ============================================================
     MODULE AREA
     (Parts 2, 3, 4 will inject module HTML here)
     ============================================================ -->
<section id="labModules" role="region" aria-label="Assessment modules">
  <div class="lab-container">

    <!-- Progress bar (shown during assessment) -->
    <div class="lab-progress" id="labProgressBar" style="display:none" role="status" aria-label="Assessment progress">
      <div class="lab-progress-meta">
        <span id="progressStep" class="mono">MODULE 0 / 0</span>
        <span id="progressLabel" class="lab-progress-label mono">â€”</span>
      </div>
      <div class="lab-progress-track">
        <div class="lab-progress-fill" id="progressFill" style="width:0%"></div>
      </div>
    </div>

    <!-- Module content injected here by Parts 2-4 -->
    <div id="moduleContent" aria-live="polite"></div>

  </div>
</section>


<!-- ============================================================
     FOOTER STRIP
     ============================================================ -->
<footer class="lab-footer-strip" role="contentinfo">
  <p>
    Shah Hayaat Digital Wellness Intelligence Lab &nbsp;|&nbsp;
    All calculations are performed locally in your browser. Zero data stored or transmitted. &nbsp;|&nbsp;
    <a href="disclaimer.html" target="_blank" rel="noopener">Medical Disclaimer</a> &nbsp;Â·&nbsp;
    <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a> &nbsp;Â·&nbsp;
    <a href="index.html">â† Main Site</a>
  </p>
</footer>


<!-- ============================================================
     JAVASCRIPT â€” PART 1: Foundation + Navigation Engine
     ============================================================ -->
<script>
'use strict';

/* â”€â”€ Global State Object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LAB = {

  /* â”€â”€ State â”€â”€ */
  gender:       null,
  moduleIndex:  0,
  moduleQueue:  [],
  scores: {
    cognitive:   null,
    respiratory: null,
    stress:      null,
    stability:   null,
    lifestyle:   null,
    hormonal:    null,   // female only
  },
  raw: {},   // raw sub-scores and measurements

  /* â”€â”€ Constants â”€â”€ */
  GH: 'https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/',

  /* â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  el(id)        { return document.getElementById(id); },
  qs(sel, ctx)  { return (ctx||document).querySelector(sel); },
  qsa(sel, ctx) { return [...(ctx||document).querySelectorAll(sel)]; },

  /* â”€â”€ Section visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  _sections: ['labWelcome','labInstructions','labGender','labModules'],

  showOnly(id) {
    this._sections.forEach(s => {
      const el = this.el(s);
      if (!el) return;
      el.style.display = (s === id) ? 'block' : 'none';
    });
    // Smooth scroll to header
    this.el('labHeader')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  },

  /* â”€â”€ Navigation flows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  showWelcome() {
    this.showOnly('labWelcome');
    this.setStatus('idle', 'Ready');
    this.el('labProgressBar').style.display = 'none';
  },

  showInstructions() {
    this.showOnly('labInstructions');
    this.setStatus('idle', 'Setup');
  },

  showGender() {
    this.showOnly('labGender');
    this.setStatus('idle', 'Setup');
  },

  /* â”€â”€ Gender selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  selectGender(g) {
    this.gender = g;

    // Visual update
    ['male','female'].forEach(x => {
      const card = this.el('gender'+x.charAt(0).toUpperCase()+x.slice(1));
      if (!card) return;
      const isSelected = x === g;
      card.classList.toggle('selected', isSelected);
      card.setAttribute('aria-checked', String(isSelected));
    });

    // Show female note
    const note = this.el('femaleNote');
    if (note) note.classList.toggle('show', g === 'female');

    // Enable continue button
    const btn = this.el('genderContinueBtn');
    if (btn) btn.disabled = false;
  },

  /* â”€â”€ Module Queue Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  startModules() {
    if (!this.gender) return;

    // Core 13 modules â€” functions registered in Parts 2 & 3
    this.moduleQueue = [
      'mod_reactionSpeed',       // Part 2 â€” Cognitive
      'mod_reactionFatigue',     // Part 2 â€” Cognitive
      'mod_workingMemory',       // Part 2 â€” Cognitive
      'mod_sustainedAttention',  // Part 2 â€” Cognitive
      'mod_breathSync',          // Part 3 â€” Respiratory
      'mod_co2Tolerance',        // Part 3 â€” Respiratory
      'mod_recovery',            // Part 3 â€” Respiratory
      'mod_cognitiveUnderPressure', // Part 3 â€” Stress
      'mod_patternOverload',     // Part 3 â€” Stress
      'mod_stabilityHold',       // Part 3 â€” Motor
      'mod_microTremor',         // Part 3 â€” Motor
      'mod_sleepEfficiency',     // Part 3 â€” Lifestyle
      'mod_lifestyleLoad',       // Part 3 â€” Lifestyle
    ];

    // Add female modules if selected
    if (this.gender === 'female') {
      this.moduleQueue.push(
        'mod_hormonalRhythm',    // Part 4 â€” Female
        'mod_energyIron',        // Part 4 â€” Female
        'mod_hormonalSkin',      // Part 4 â€” Female
        'mod_sleepCycle',        // Part 4 â€” Female
        'mod_pelvicComfort'      // Part 4 â€” Female
      );
    }

    this.moduleIndex = 0;
    this.showOnly('labModules');
    this.el('labProgressBar').style.display = 'block';
    this.nextModule();
  },

  /* â”€â”€ Module runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  nextModule() {
    if (this.moduleIndex >= this.moduleQueue.length) {
      // All done â€” show dashboard (Part 4 registers this)
      if (typeof LAB.showDashboard === 'function') {
        LAB.showDashboard();
      } else {
        // Fallback placeholder until Part 4 is added
        this.el('moduleContent').innerHTML = `
          <div class="lab-card" style="text-align:center;padding:4rem 2rem">
            <div style="font-size:3rem;margin-bottom:1rem">âœ…</div>
            <h2 class="lab-h2" style="margin-bottom:0.75rem">Assessment Complete</h2>
            <p class="lab-p" style="margin:0 auto;max-width:420px;margin-bottom:2rem">
              All modules finished. Dashboard and PDF report coming in Part 4.
            </p>
            <button class="lab-btn lab-btn--primary" onclick="LAB.showWelcome()">
              â†º Restart
            </button>
          </div>`;
      }
      return;
    }

    const modName = this.moduleQueue[this.moduleIndex];
    this.updateProgress();

    // Look up the module function
    const fn = window[modName] || this[modName];
    if (typeof fn === 'function') {
      fn.call(this);
    } else {
      // Module not yet implemented (Parts 2/3/4 not loaded)
      this._placeholderModule(modName);
    }
  },

  _placeholderModule(name) {
    // Temp placeholder shown when Part 2/3/4 not added yet
    const label = name
      .replace('mod_','')
      .replace(/([A-Z])/g, ' $1')
      .replace(/^./, s => s.toUpperCase());

    this.el('moduleContent').innerHTML = `
      <div class="lab-card lab-card--glow lab-module-wrap">
        <div class="lab-step-head">
          <div class="lab-tag">ğŸ”§ Coming in Part ${this._getModulePart(name)}</div>
          <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">${label}</h2>
          <p class="lab-p">This module will be implemented in the next part of the build.</p>
        </div>
        <div class="lab-notice" style="margin-bottom:2rem">
          <div class="notice-icon">â„¹ï¸</div>
          <p>Module <strong>${name}</strong> is queued. The full implementation arrives in Part ${this._getModulePart(name)} of this project.</p>
        </div>
        <div class="lab-btn-row">
          <button class="lab-btn lab-btn--primary" onclick="LAB.skipModule()">
            Skip (Test Navigation) â†’
          </button>
        </div>
      </div>`;
  },

  _getModulePart(name) {
    const p2 = ['mod_reactionSpeed','mod_reactionFatigue','mod_workingMemory','mod_sustainedAttention'];
    const p3 = ['mod_breathSync','mod_co2Tolerance','mod_recovery','mod_cognitiveUnderPressure','mod_patternOverload','mod_stabilityHold','mod_microTremor','mod_sleepEfficiency','mod_lifestyleLoad'];
    if (p2.includes(name)) return 2;
    if (p3.includes(name)) return 3;
    return 4;
  },

  skipModule() {
    // Dev helper: skip placeholder to test navigation
    this.moduleIndex++;
    this.nextModule();
  },

  /* â”€â”€ Progress bar update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  updateProgress() {
    const total  = this.moduleQueue.length;
    const current = this.moduleIndex + 1;
    const pct    = Math.round(((current-1) / total) * 100);

    const labels = {
      mod_reactionSpeed:          'ğŸ§  Reaction Speed',
      mod_reactionFatigue:        'ğŸ§  Fatigue Drift',
      mod_workingMemory:          'ğŸ§© Working Memory',
      mod_sustainedAttention:     'ğŸ‘ Attention Focus',
      mod_breathSync:             'ğŸŒ¬ Breath Sync',
      mod_co2Tolerance:           'â± COâ‚‚ Tolerance',
      mod_recovery:               'â™»ï¸ Recovery',
      mod_cognitiveUnderPressure: 'ğŸ”¥ Cognition Under Pressure',
      mod_patternOverload:        'ğŸ”· Pattern Overload',
      mod_stabilityHold:          'ğŸ“± Stability Hold',
      mod_microTremor:            'âœ‹ Micro Tremor',
      mod_sleepEfficiency:        'ğŸ’¤ Sleep Efficiency',
      mod_lifestyleLoad:          'âš–ï¸ Lifestyle Load',
      mod_hormonalRhythm:         'ğŸŒ¸ Hormonal Rhythm',
      mod_energyIron:             'âš¡ Energy & Iron',
      mod_hormonalSkin:           'âœ¨ Hormonal Skin',
      mod_sleepCycle:             'ğŸŒ™ Sleep-Cycle',
      mod_pelvicComfort:          'ğŸŒ¸ Pelvic Comfort',
    };

    const modName = this.moduleQueue[this.moduleIndex] || '';
    const label   = labels[modName] || modName;

    const stepEl  = this.el('progressStep');
    const labelEl = this.el('progressLabel');
    const fillEl  = this.el('progressFill');

    if (stepEl)  stepEl.textContent  = `MODULE ${current} / ${total}`;
    if (labelEl) labelEl.textContent = label;
    if (fillEl)  fillEl.style.width  = pct + '%';

    // Header status
    this.setStatus('active', label);
  },

  /* â”€â”€ Header status helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  setStatus(state, text) {
    const dot  = this.el('headerDot');
    const span = this.el('headerStatusText');
    if (dot)  dot.className  = 'lab-status-dot' + (state === 'active' ? '' : ' idle');
    if (span) span.textContent = text;
  },

  /* â”€â”€ Score utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  avg(arr)  { return arr.length ? arr.reduce((a,b) => a+b, 0) / arr.length : 0; },
  clamp(v,min,max) { return Math.max(min, Math.min(max, v)); },
  stdev(arr) {
    const m = this.avg(arr);
    return Math.sqrt(this.avg(arr.map(x => (x - m) ** 2)));
  },

  scoreColor(s) {
    if (s >= 80) return '#3EBA7C';
    if (s >= 55) return '#F0A020';
    return '#E85555';
  },
  scoreLabel(s) {
    if (s >= 80) return 'Excellent';
    if (s >= 65) return 'Good';
    if (s >= 50) return 'Moderate';
    if (s >= 35) return 'Needs Attention';
    return 'Low';
  },

  /* â”€â”€ Render module content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  renderModule(html) {
    const el = this.el('moduleContent');
    if (el) {
      el.innerHTML = html;
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  },

  /* â”€â”€ Progress helper (for modules to call) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  progressHTML() {
    // Returns empty string â€” progress is in the fixed bar above
    return '';
  },

};

/* â”€â”€ Window event helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Scroll-based header shrink
window.addEventListener('scroll', () => {
  document.body.classList.toggle('lab-scrolled', window.scrollY > 40);
}, { passive: true });


/* â”€â”€ Disclaimer Banner Rotator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function initDisclaimer() {
  const TOTAL = 3;
  let current = 0;

  setInterval(() => {
    // Deactivate current
    const prevSlide = document.getElementById('ds-' + current);
    const prevDot   = document.getElementById('dd-' + current);
    if (prevSlide) prevSlide.classList.remove('ds-active');
    if (prevDot)   prevDot.classList.remove('dd-active');

    current = (current + 1) % TOTAL;

    // Activate next
    const nextSlide = document.getElementById('ds-' + current);
    const nextDot   = document.getElementById('dd-' + current);
    if (nextSlide) nextSlide.classList.add('ds-active');
    if (nextDot)   nextDot.classList.add('dd-active');

    // Dot 0 colour matches current slide colour
    const dot0 = document.getElementById('dd-0');
    const colours = ['var(--red)', 'var(--lab-bright)', 'var(--gold-bright)'];
    document.querySelectorAll('.disclaimer-dot').forEach((d,i) => {
      d.style.background = '';
    });
    if (nextDot) nextDot.style.background = colours[current];

  }, 5000);
})();


/* â”€â”€ Expose LAB globally â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.LAB = LAB;

// Auto-hide footer lab-page padding
document.documentElement.style.setProperty('--disclaimer-h', '52px');
</script>


<!-- ============================================================
     PART 2 CSS â€” Cognitive Module UI Components
     ============================================================ -->
<style>

/* â”€â”€ Reaction Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rx-zone {
  width: 100%; border-radius: var(--radius);
  height: 200px; display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 0.5rem;
  cursor: pointer; user-select: none;
  border: 2px solid var(--border);
  transition: background 0.12s, border-color 0.12s;
  position: relative; overflow: hidden;
}
.rx-zone::after {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(circle at center, rgba(255,255,255,0.04) 0%, transparent 70%);
  pointer-events: none;
}
.rx-zone .rz-label {
  font-family: var(--font-mono); font-size: clamp(1rem, 3vw, 1.4rem);
  font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
  transition: color 0.12s;
}
.rx-zone .rz-sub {
  font-family: var(--font-mono); font-size: 0.68rem;
  letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.55;
}

/* States */
.rx-zone.rz-wait {
  background: rgba(10,18,20,0.6);
  border-color: var(--border);
}
.rx-zone.rz-wait .rz-label { color: var(--text-muted); }

.rx-zone.rz-ready {
  background: rgba(56,180,140,0.12);
  border-color: var(--lab);
  box-shadow: 0 0 0 4px rgba(56,180,140,0.12), 0 0 40px rgba(56,180,140,0.2);
  animation: rx-flash 0.15s ease;
}
.rx-zone.rz-ready .rz-label { color: var(--lab-bright); }

.rx-zone.rz-early {
  background: rgba(240,160,32,0.1);
  border-color: var(--amber);
}
.rx-zone.rz-early .rz-label { color: var(--amber); }

.rx-zone.rz-result {
  background: rgba(56,180,140,0.06);
  border-color: rgba(56,180,140,0.4);
  cursor: default;
}

@keyframes rx-flash {
  from { box-shadow: 0 0 0 8px rgba(56,180,140,0.35), 0 0 80px rgba(56,180,140,0.4); }
  to   { box-shadow: 0 0 0 4px rgba(56,180,140,0.12), 0 0 40px rgba(56,180,140,0.2); }
}

/* â”€â”€ Reaction History Dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rx-history {
  display: flex; align-items: flex-end; gap: 5px;
  height: 48px; margin: 0.75rem 0;
}
.rx-bar {
  flex: 1; border-radius: 3px 3px 0 0;
  min-height: 4px; max-height: 48px;
  transition: height 0.4s var(--ease), background 0.3s;
  position: relative;
}
.rx-bar::after {
  content: attr(data-ms);
  position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%);
  font-family: var(--font-mono); font-size: 0.55rem; color: var(--text-muted);
  white-space: nowrap;
}

/* â”€â”€ Timer Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-timer {
  font-family: var(--font-mono); font-size: clamp(2.8rem, 8vw, 4.5rem);
  font-weight: 600; line-height: 1; text-align: center;
  color: var(--lab-bright); letter-spacing: 0.04em;
  text-shadow: 0 0 30px rgba(78,237,184,0.35);
  display: block; margin: 1rem 0;
  transition: color 0.3s, text-shadow 0.3s;
}
.lab-timer.t-warn  {
  color: var(--amber);
  text-shadow: 0 0 30px rgba(240,160,32,0.35);
}
.lab-timer.t-crit  {
  color: var(--red);
  text-shadow: 0 0 30px rgba(232,85,85,0.45);
  animation: lab-pulse 0.6s ease-in-out infinite;
}

/* â”€â”€ Memory Matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mem-wrap { display: flex; justify-content: center; margin: 1.5rem 0; }

.mem-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px; width: 100%; max-width: 340px;
}

.mem-cell {
  aspect-ratio: 1;
  background: var(--ink-4);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.18s var(--ease);
  position: relative; overflow: hidden;
  display: flex; align-items: center; justify-content: center;
}
.mem-cell::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 50%, rgba(56,180,140,0.15) 0%, transparent 70%);
  opacity: 0; transition: opacity 0.18s;
}
.mem-cell:hover:not(.mc-disabled) {
  border-color: var(--border-h);
  transform: scale(1.04);
}
.mem-cell:hover:not(.mc-disabled)::before { opacity: 1; }

/* Cell states */
.mem-cell.mc-lit {
  background: var(--lab);
  border-color: var(--lab-bright);
  box-shadow: 0 0 20px rgba(56,180,140,0.55);
  transform: scale(1.06);
}
.mem-cell.mc-selected {
  background: rgba(56,189,248,0.18);
  border-color: #38BDF8;
  box-shadow: 0 0 14px rgba(56,189,248,0.3);
}
.mem-cell.mc-correct {
  background: rgba(62,186,124,0.2);
  border-color: var(--green-ok);
}
.mem-cell.mc-wrong {
  background: rgba(232,85,85,0.18);
  border-color: var(--red);
  box-shadow: 0 0 14px rgba(232,85,85,0.3);
  animation: rx-flash-wrong 0.3s ease;
}
.mem-cell.mc-disabled { cursor: default; }

@keyframes rx-flash-wrong {
  0%,100% { transform: scale(1); }
  50%      { transform: scale(0.95); }
}

/* Memory span indicator */
.mem-span-row {
  display: flex; align-items: center; justify-content: center;
  gap: 0.5rem; margin-bottom: 1rem;
}
.mem-span-pip {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--surface); border: 1px solid var(--border);
  transition: all 0.3s;
}
.mem-span-pip.active {
  background: var(--lab); border-color: var(--lab-bright);
  box-shadow: 0 0 8px rgba(56,180,140,0.5);
}
.mem-status {
  text-align: center;
  font-family: var(--font-mono); font-size: 0.76rem;
  color: var(--text-muted); letter-spacing: 0.06em;
  min-height: 1.4em; margin: 0.6rem 0;
}

/* â”€â”€ Attention Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.att-arena {
  display: flex; align-items: center; justify-content: center;
  min-height: 200px; margin: 1rem 0; position: relative;
}
.att-circle {
  width: 150px; height: 150px; border-radius: 50%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 0.2rem;
  cursor: pointer; user-select: none;
  border: 3px solid var(--border);
  background: var(--ink-4);
  transition: all 0.15s var(--ease);
  position: relative; overflow: hidden;
}
.att-circle::before {
  content: '';
  position: absolute; inset: 0; border-radius: 50%;
  background: radial-gradient(circle at 40% 35%, rgba(255,255,255,0.08) 0%, transparent 60%);
}
.att-circle .att-shape { font-size: 3.2rem; line-height: 1; }
.att-circle .att-hint  {
  font-family: var(--font-mono); font-size: 0.6rem;
  color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase;
}

/* Attention states */
.att-circle.att-green {
  border-color: var(--lab);
  background: rgba(56,180,140,0.12);
  box-shadow: 0 0 30px rgba(56,180,140,0.28);
  animation: att-pop 0.18s ease;
}
.att-circle.att-red {
  border-color: var(--red);
  background: rgba(232,85,85,0.12);
  box-shadow: 0 0 30px rgba(232,85,85,0.22);
  animation: att-pop 0.18s ease;
}
.att-circle.att-idle {
  border-color: var(--border); background: var(--ink-4);
}
.att-circle.att-hit {
  background: rgba(56,180,140,0.25);
  transform: scale(1.08);
}
.att-circle.att-fa {
  background: rgba(232,85,85,0.25);
  animation: att-shake 0.3s ease;
}
@keyframes att-pop {
  from { transform: scale(0.88); }
  to   { transform: scale(1); }
}
@keyframes att-shake {
  0%,100% { transform: translateX(0); }
  25%      { transform: translateX(-6px); }
  75%      { transform: translateX(6px); }
}

/* Attention streak bar */
.att-streak {
  display: flex; gap: 4px; justify-content: center;
  flex-wrap: wrap; margin: 0.75rem 0; min-height: 20px;
}
.att-streak-dot {
  width: 10px; height: 10px; border-radius: 50%;
  transition: all 0.2s;
}
.att-streak-dot.sd-hit { background: var(--lab); box-shadow: 0 0 4px var(--lab); }
.att-streak-dot.sd-fa  { background: var(--red); }
.att-streak-dot.sd-miss{ background: var(--amber); }

/* â”€â”€ Feedback Flash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feedback-flash {
  position: fixed; inset: 0; z-index: 8000;
  pointer-events: none; opacity: 0;
  transition: opacity 0.12s;
}
.feedback-flash.ff-green { background: rgba(56,180,140,0.07); }
.feedback-flash.ff-red   { background: rgba(232,85,85,0.08); }
.feedback-flash.ff-show  { opacity: 1; }

/* â”€â”€ Fatigue Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fatigue-chart-wrap {
  background: var(--ink-4); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 1rem;
  margin: 1rem 0;
}
.fatigue-chart-inner {
  display: flex; align-items: flex-end; gap: 3px;
  height: 60px; overflow: hidden;
}
.fatigue-bar {
  flex: 1; border-radius: 2px 2px 0 0;
  min-height: 3px; max-height: 60px;
  transition: height 0.4s var(--ease);
}

/* â”€â”€ Module Section Wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-module-wrap {
  animation: lab-fade-up 0.42s var(--ease) both;
}

/* â”€â”€ Cognitive Score Summary Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cog-summary {
  background: var(--ink-4); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 1.5rem 1.8rem;
  margin-bottom: 2rem;
}
.cog-summary-title {
  font-family: var(--font-mono); font-size: 0.66rem;
  color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 0.1em; margin-bottom: 1rem;
}
.cog-score-big {
  font-family: var(--font-mono); font-size: 3rem; font-weight: 600;
  line-height: 1; color: var(--lab-bright);
  text-shadow: 0 0 20px rgba(78,237,184,0.3);
}
.cog-score-label {
  font-family: var(--font-mono); font-size: 0.72rem;
  color: var(--text-muted); margin-top: 0.3rem;
}

</style>

<!-- ============================================================
     PART 2 JAVASCRIPT â€” 4 Cognitive Modules
     ============================================================ -->
<script>
'use strict';

/* ============================================================
   HELPERS SHARED ACROSS ALL COGNITIVE MODULES
   ============================================================ */

/* Flash the screen briefly (hit = green, miss = red) */
function _flashFeedback(type) {
  let flash = document.getElementById('_feedbackFlash');
  if (!flash) {
    flash = document.createElement('div');
    flash.id = '_feedbackFlash';
    flash.className = 'feedback-flash';
    document.body.appendChild(flash);
  }
  flash.className = 'feedback-flash ' + (type === 'hit' ? 'ff-green' : 'ff-red');
  requestAnimationFrame(() => {
    flash.classList.add('ff-show');
    setTimeout(() => flash.classList.remove('ff-show'), 120);
  });
}

/* Generate reaction bar HTML for the history chart */
function _rxBarsHTML(times) {
  if (!times.length) return '';
  const max = Math.max(...times, 600);
  return times.map((t, i) => {
    const h = Math.max(4, Math.round((t / max) * 48));
    const col = t < 250 ? 'var(--lab)'
              : t < 400 ? 'var(--amber)'
              : 'var(--red)';
    return `<div class="rx-bar" style="height:${h}px;background:${col}" data-ms="${t}" title="${t}ms"></div>`;
  }).join('');
}

/* Standard module card wrapper */
function _moduleCard(tagText, modNum, total, title, desc, bodyHTML) {
  return `
  <div class="lab-module-wrap">
    <div class="lab-card lab-card--glow">
      <div class="lab-step-head">
        <div class="lab-tag">ğŸ§  Cognitive Â· Module ${modNum} of ${total}</div>
        <div class="lab-tag" style="margin-left:0.4rem">${tagText}</div>
        <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">${title}</h2>
        <p class="lab-p">${desc}</p>
      </div>
      ${bodyHTML}
    </div>
  </div>`;
}

/* ============================================================
   MODULE 1 â€” ADAPTIVE REACTION SPEED TEST
   10 rounds, measures avg / best / worst / variability
   ============================================================ */
window.mod_reactionSpeed = function() {

  const ROUNDS = 10;
  const state = {
    round:    0,
    times:    [],
    waiting:  false,
    startT:   0,
    locked:   false,   // prevents spam during "wait" phase
  };
  let _timer = null;

  LAB.renderModule(_moduleCard(
    'âš¡ Reaction Speed', LAB.moduleIndex + 1, LAB.moduleQueue.length,
    'Adaptive Reaction Speed',
    'When the zone turns <strong style="color:var(--lab-bright)">green</strong>, tap it immediately. 10 rounds. Do not tap during the wait phase â€” patience counts.',
    `
    <div id="rxZone" class="rx-zone rz-wait" onclick="_rxTap()" role="button"
         aria-label="Reaction zone â€” tap when green" tabindex="0"
         onkeydown="if(event.key==='Enter'||event.key===' ') _rxTap()">
      <span class="rz-label" id="rxLabel">Get Readyâ€¦</span>
      <span class="rz-sub" id="rxSub">Tap when it turns green</span>
    </div>

    <div class="rx-history" id="rxHistory" aria-label="Reaction times" role="img"></div>

    <div class="lab-score-row">
      <div class="lab-score-badge">
        <span class="val" id="rxRound">0 / ${ROUNDS}</span>
        <span class="lbl">Round</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="rxLast">â€”</span>
        <span class="lbl">Last (ms)</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="rxBest">â€”</span>
        <span class="lbl">Best (ms)</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="rxAvg">â€”</span>
        <span class="lbl">Avg (ms)</span>
      </div>
    </div>

    <div class="lab-notice" id="rxNotice" role="status">
      <div class="notice-icon">ğŸ’¡</div>
      <p>Keep your finger near the zone. Focus entirely on the colour change â€” nothing else.</p>
    </div>
    `
  ));

  // Kick off after a beat
  setTimeout(_rxSchedule, 1000);

  /* Schedule the next go-signal */
  function _rxSchedule() {
    const zone = document.getElementById('rxZone');
    if (!zone) return;

    _rxSetState('wait', 'Waitâ€¦', '');
    state.waiting = false;
    state.locked  = false;

    // Random delay 1.1s â€“ 3.5s
    const delay = 1100 + Math.random() * 2400;
    _timer = setTimeout(() => {
      if (!document.getElementById('rxZone')) return; // module gone
      _rxSetState('ready', 'TAP!', 'Hit it!');
      state.waiting = true;
      state.startT  = performance.now();
    }, delay);
  }

  function _rxSetState(cls, label, sub) {
    const z = document.getElementById('rxZone');
    const l = document.getElementById('rxLabel');
    const s = document.getElementById('rxSub');
    if (!z) return;
    z.className = 'rx-zone rz-' + cls;
    if (l) l.textContent = label;
    if (s) s.textContent = sub;
  }

  window._rxTap = function() {
    if (state.locked) return;

    if (!state.waiting) {
      // Tapped too early
      clearTimeout(_timer);
      state.locked = true;
      _rxSetState('early', 'Too Early!', 'Wait for greenâ€¦');
      _flashFeedback('miss');
      setTimeout(_rxSchedule, 1400);
      return;
    }

    // Valid tap
    const rt = Math.round(performance.now() - state.startT);
    state.times.push(rt);
    state.round++;
    state.waiting = false;
    state.locked  = true;

    // Update UI
    const el = id => document.getElementById(id);
    el('rxRound').textContent = `${state.round} / ${ROUNDS}`;
    el('rxLast').textContent  = rt + 'ms';
    el('rxBest').textContent  = Math.min(...state.times) + 'ms';
    el('rxAvg').textContent   = Math.round(LAB.avg(state.times)) + 'ms';

    // Update history bars
    const hist = el('rxHistory');
    if (hist) hist.innerHTML = _rxBarsHTML(state.times);

    // Colour feedback
    const col = rt < 250 ? '#3EBA7C' : rt < 400 ? '#F0A020' : '#E85555';
    _rxSetState('result', 'âœ“ ' + rt + 'ms', rt < 250 ? 'Excellent!' : rt < 400 ? 'Good' : 'Slow');
    const zone = document.getElementById('rxZone');
    if (zone) zone.style.borderColor = col;

    _flashFeedback('hit');

    // Notice update
    const notice = el('rxNotice');
    if (notice && rt < 220) {
      notice.innerHTML = '<div class="notice-icon">ğŸš€</div><p>Outstanding reaction â€” under 220ms is elite territory.</p>';
    }

    if (state.round >= ROUNDS) {
      // Done â€” save score and advance
      setTimeout(() => _rxSave(state), 800);
    } else {
      setTimeout(_rxSchedule, 900);
    }
  };

  function _rxSave(state) {
    const t   = state.times;
    const m   = LAB.avg(t);
    const sd  = LAB.stdev(t);
    const best = Math.min(...t);

    // Scoring function:
    // avg<220â†’100, 220-300â†’90, 300-420â†’75, 420-600â†’55, >600â†’35
    // Penalise high variability (sd)
    let sc = m < 220 ? 100 : m < 300 ? 90 : m < 420 ? 75 : m < 600 ? 55 : 35;
    sc = LAB.clamp(Math.round(sc - (sd / 18)), 20, 100);

    LAB.raw.reactionTimes = t;
    LAB.raw.reactionAvg   = Math.round(m);
    LAB.raw.reactionBest  = best;
    LAB.raw.reactionSD    = Math.round(sd);
    LAB.raw.reactionScore = sc;

    LAB.moduleIndex++;
    LAB.nextModule();
  }
};


/* ============================================================
   MODULE 2 â€” REACTION FATIGUE DRIFT TEST
   30-second sustained tapping. Measures fatigue slope.
   ============================================================ */
window.mod_reactionFatigue = function() {

  const DURATION = 30; // seconds
  const state = {
    active:   false,
    elapsed:  0,
    waiting:  false,
    startT:   0,
    taps:     [],     // { elapsed, rt }
  };
  let _countdown = null;
  let _tapTimer  = null;

  LAB.renderModule(_moduleCard(
    'ğŸ“‰ Fatigue Drift', LAB.moduleIndex + 1, LAB.moduleQueue.length,
    'Reaction Fatigue Drift',
    'A 30-second continuous reaction test. Tap the zone each time it turns green. We measure whether reactions slow as mental fatigue builds over time.',
    `
    <span class="lab-timer" id="fatigueTimer">30</span>

    <div id="fatigueZone" class="rx-zone rz-wait"
         onclick="_fatigueTap()"
         style="height:160px;cursor:default"
         role="button" aria-label="Fatigue test zone" tabindex="0"
         onkeydown="if(event.key==='Enter'||event.key===' ') _fatigueTap()">
      <span class="rz-label" id="fatigueLabel">Press Start</span>
      <span class="rz-sub">30-second test</span>
    </div>

    <!-- Live fatigue bar chart -->
    <div class="fatigue-chart-wrap" id="fatigueChart" style="display:none">
      <div style="font-family:var(--font-mono);font-size:0.62rem;color:var(--text-muted);
                  letter-spacing:0.08em;text-transform:uppercase;margin-bottom:0.5rem">
        Reaction timeline â†’
      </div>
      <div class="fatigue-chart-inner" id="fatigueChartInner"></div>
    </div>

    <div class="lab-score-row">
      <div class="lab-score-badge">
        <span class="val" id="fatTaps">0</span>
        <span class="lbl">Taps</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="fatAvg">â€”</span>
        <span class="lbl">Avg (ms)</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="fatDrift">â€”</span>
        <span class="lbl">Drift</span>
      </div>
    </div>

    <div class="lab-btn-row">
      <button class="lab-btn lab-btn--primary" id="fatigueStartBtn"
              onclick="_fatigueStart()">
        â–¶ Start 30s Test
      </button>
    </div>
    `
  ));

  window._fatigueStart = function() {
    const startBtn = document.getElementById('fatigueStartBtn');
    if (startBtn) startBtn.style.display = 'none';

    const zone = document.getElementById('fatigueZone');
    if (zone) zone.style.cursor = 'pointer';

    state.active  = true;
    state.elapsed = 0;

    // Countdown ticker
    _countdown = setInterval(() => {
      state.elapsed++;
      const rem = DURATION - state.elapsed;
      const timerEl = document.getElementById('fatigueTimer');
      if (timerEl) {
        timerEl.textContent = rem;
        timerEl.className   = 'lab-timer' +
          (rem <= 5 ? ' t-crit' : rem <= 12 ? ' t-warn' : '');
      }
      if (state.elapsed >= DURATION) {
        clearInterval(_countdown);
        clearTimeout(_tapTimer);
        _fatigueSave(state);
      }
    }, 1000);

    _fatigueSchedule();
  };

  function _fatigueSchedule() {
    if (!state.active || !document.getElementById('fatigueZone')) return;
    const label = document.getElementById('fatigueLabel');
    const zone  = document.getElementById('fatigueZone');
    if (!zone) return;

    zone.className   = 'rx-zone rz-wait';
    if (label) label.textContent = 'Waitâ€¦';
    state.waiting = false;

    const delay = 700 + Math.random() * 1800;
    _tapTimer = setTimeout(() => {
      if (!document.getElementById('fatigueZone')) return;
      const z2 = document.getElementById('fatigueZone');
      const l2 = document.getElementById('fatigueLabel');
      if (!z2) return;
      z2.className   = 'rx-zone rz-ready';
      if (l2) l2.textContent = 'TAP!';
      state.waiting = true;
      state.startT  = performance.now();
    }, delay);
  }

  window._fatigueTap = function() {
    if (!state.active || !state.waiting) return;

    const rt = Math.round(performance.now() - state.startT);
    state.taps.push({ elapsed: state.elapsed, rt });
    state.waiting = false;

    const zone  = document.getElementById('fatigueZone');
    const label = document.getElementById('fatigueLabel');
    if (zone)  zone.className   = 'rx-zone rz-result';
    if (label) label.textContent = 'âœ“ ' + rt + 'ms';

    // Update stats
    const allRts = state.taps.map(t => t.rt);
    const elTaps  = document.getElementById('fatTaps');
    const elAvg   = document.getElementById('fatAvg');
    const elDrift = document.getElementById('fatDrift');
    if (elTaps)  elTaps.textContent  = state.taps.length;
    if (elAvg)   elAvg.textContent   = Math.round(LAB.avg(allRts)) + 'ms';

    // Drift: compare first-half avg vs second-half avg
    if (state.taps.length >= 6) {
      const half  = Math.floor(state.taps.length / 2);
      const early = state.taps.slice(0, half).map(t => t.rt);
      const late  = state.taps.slice(half).map(t => t.rt);
      const drift = Math.round(LAB.avg(late) - LAB.avg(early));
      if (elDrift) {
        elDrift.textContent = (drift > 0 ? '+' : '') + drift + 'ms';
        elDrift.style.color = drift > 40 ? 'var(--red)' : drift > 15 ? 'var(--amber)' : 'var(--lab)';
      }
    } else {
      if (elDrift) elDrift.textContent = 'Measuringâ€¦';
    }

    // Update live fatigue chart
    const chart = document.getElementById('fatigueChart');
    const inner = document.getElementById('fatigueChartInner');
    if (chart) chart.style.display = 'block';
    if (inner && allRts.length) {
      const max = Math.max(...allRts, 500);
      inner.innerHTML = allRts.map((r, i) => {
        const h   = Math.max(3, Math.round((r / max) * 60));
        const col = i < allRts.length / 2 ? 'var(--lab)' : 'var(--amber)';
        return `<div class="fatigue-bar" style="height:${h}px;background:${col}" title="${r}ms"></div>`;
      }).join('');
    }

    _flashFeedback('hit');
    clearTimeout(_tapTimer);
    setTimeout(_fatigueSchedule, 350);
  };

  function _fatigueSave(state) {
    const taps  = state.taps;
    let score   = 70;

    if (taps.length >= 4) {
      const half  = Math.floor(taps.length / 2);
      const early = taps.slice(0, half).map(t => t.rt);
      const late  = taps.slice(half).map(t => t.rt);
      const drift = LAB.avg(late) - LAB.avg(early);
      // Score: low drift = good, high drift = fatigue present
      // drift < 0 = improved (great), 0-30 = good, 30-80 = moderate, >80 = poor
      score = LAB.clamp(Math.round(85 - (drift / 4)), 20, 100);
      LAB.raw.fatigueDrift = Math.round(drift);
    }

    LAB.raw.fatigueTaps  = taps.length;
    LAB.raw.fatigueScore = score;

    LAB.moduleIndex++;
    LAB.nextModule();
  }
};


/* ============================================================
   MODULE 3 â€” WORKING MEMORY MATRIX
   3Ã—3 grid, expanding sequence, up to 9 cells
   ============================================================ */
window.mod_workingMemory = function() {

  const state = {
    seq:      [],
    userSeq:  [],
    span:     3,       // current sequence length
    phase:    'idle',  // 'show' | 'input' | 'idle'
    round:    0,
    maxSpan:  0,
    errors:   0,
    totalRounds: 7,
  };

  LAB.renderModule(_moduleCard(
    'ğŸ§© Working Memory', LAB.moduleIndex + 1, LAB.moduleQueue.length,
    'Working Memory Matrix',
    'Watch the cells light up in sequence â€” then tap them back in the <strong>exact same order</strong>. The sequence grows longer each round.',
    `
    <!-- Span indicator pips -->
    <div class="mem-span-row" id="memSpanRow" aria-label="Current sequence length">
      ${Array.from({length:9},(_,i)=>`<div class="mem-span-pip" id="msp-${i}"></div>`).join('')}
    </div>

    <div class="mem-wrap">
      <div class="mem-grid" id="memGrid" role="group" aria-label="Memory grid">
        ${Array.from({length:9},(_,i)=>`
          <div class="mem-cell mc-disabled"
               id="mc-${i}"
               role="button" tabindex="-1"
               aria-label="Cell ${i+1}"
               onclick="_memTap(${i})"
               onkeydown="if(event.key==='Enter'||event.key===' ')_memTap(${i})">
          </div>`).join('')}
      </div>
    </div>

    <div class="mem-status" id="memStatus" role="status" aria-live="polite">
      Prepare yourselfâ€¦
    </div>

    <div class="lab-score-row">
      <div class="lab-score-badge">
        <span class="val" id="memRound">0 / ${7}</span>
        <span class="lbl">Round</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="memSpan">3</span>
        <span class="lbl">Sequence Length</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="memMaxSpan">0</span>
        <span class="lbl">Best Span</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="memErrors">0</span>
        <span class="lbl">Errors</span>
      </div>
    </div>
    `
  ));

  setTimeout(_memNewRound, 600);

  /* Update span pips */
  function _memUpdatePips(span) {
    for (let i = 0; i < 9; i++) {
      const pip = document.getElementById('msp-' + i);
      if (pip) pip.classList.toggle('active', i < span);
    }
  }

  /* Set cell state */
  function _memCellClass(i, cls) {
    const cell = document.getElementById('mc-' + i);
    if (!cell) return;
    // Remove all state classes
    cell.classList.remove('mc-lit','mc-selected','mc-correct','mc-wrong','mc-disabled');
    if (cls) cell.classList.add(cls);
  }

  /* Enable / disable tap interaction */
  function _memSetInteractive(on) {
    for (let i = 0; i < 9; i++) {
      const cell = document.getElementById('mc-' + i);
      if (!cell) continue;
      if (on) {
        cell.classList.remove('mc-disabled');
        cell.tabIndex = 0;
      } else {
        cell.classList.add('mc-disabled');
        cell.tabIndex = -1;
      }
    }
  }

  function _memSetStatus(txt, col) {
    const s = document.getElementById('memStatus');
    if (s) { s.textContent = txt; s.style.color = col || 'var(--text-muted)'; }
  }

  function _memNewRound() {
    if (!document.getElementById('memGrid')) return;

    state.seq     = [];
    state.userSeq = [];
    state.phase   = 'show';
    state.round++;

    // Build random sequence
    for (let i = 0; i < state.span; i++) {
      let next;
      do { next = Math.floor(Math.random() * 9); }
      while (i > 0 && next === state.seq[i - 1]); // avoid immediate repeats
      state.seq.push(next);
    }

    // Update UI
    const elRound = document.getElementById('memRound');
    const elSpan  = document.getElementById('memSpan');
    if (elRound) elRound.textContent = `${state.round} / ${state.totalRounds}`;
    if (elSpan)  elSpan.textContent  = state.span;
    _memUpdatePips(state.span);
    _memSetInteractive(false);
    _memSetStatus('Watch the sequenceâ€¦', 'var(--text-muted)');

    // Play sequence with 550ms between flashes
    _memPlaySeq(0);
  }

  function _memPlaySeq(index) {
    if (!document.getElementById('mc-0')) return; // navigated away
    if (index >= state.seq.length) {
      // Sequence done â€” enable input
      state.phase = 'input';
      _memSetInteractive(true);
      _memSetStatus('Now tap in order â†’', 'var(--lab)');
      return;
    }
    const cell = state.seq[index];
    // Light up
    setTimeout(() => {
      _memCellClass(cell, 'mc-lit');
      // Turn off after 400ms
      setTimeout(() => {
        _memCellClass(cell, '');
        // Next cell after gap
        setTimeout(() => _memPlaySeq(index + 1), 160);
      }, 420);
    }, index === 0 ? 300 : 0);
  }

  window._memTap = function(i) {
    if (state.phase !== 'input') return;
    if (!document.getElementById('mc-' + i)) return;

    const pos      = state.userSeq.length;
    const expected = state.seq[pos];
    state.userSeq.push(i);

    if (i === expected) {
      // Correct
      _memCellClass(i, 'mc-selected');
      _flashFeedback('hit');
      setTimeout(() => _memCellClass(i, 'mc-correct'), 280);
    } else {
      // Wrong
      state.errors++;
      _memCellClass(i, 'mc-wrong');
      _flashFeedback('miss');
      const elErr = document.getElementById('memErrors');
      if (elErr) elErr.textContent = state.errors;

      // Flash the correct one briefly
      setTimeout(() => {
        _memCellClass(expected, 'mc-lit');
        setTimeout(() => _memCellClass(expected, ''), 500);
      }, 200);
    }

    // Check if sequence complete
    if (state.userSeq.length === state.seq.length) {
      const allCorrect = state.userSeq.every((v, i) => v === state.seq[i]);
      _memSetInteractive(false);

      if (allCorrect) {
        state.maxSpan = Math.max(state.maxSpan, state.span);
        if (state.span < 9) state.span++;
        _memSetStatus('âœ“ Correct! Sequence extendingâ€¦', 'var(--lab)');
      } else {
        if (state.span > 2) state.span--;
        _memSetStatus('âœ— Incorrect. Sequence shorteningâ€¦', 'var(--red)');
      }

      const elMax = document.getElementById('memMaxSpan');
      if (elMax) elMax.textContent = state.maxSpan;

      if (state.round >= state.totalRounds) {
        setTimeout(() => _memSave(state), 1200);
      } else {
        setTimeout(_memNewRound, 1400);
      }
    }
  };

  function _memSave(state) {
    // Score: based on max span achieved and total errors
    const spanScore  = (state.maxSpan / 9) * 80;
    const errorPenalty = state.errors * 3;
    const score = LAB.clamp(Math.round(spanScore - errorPenalty + 20), 15, 100);

    LAB.raw.memorySpan   = state.maxSpan;
    LAB.raw.memoryErrors = state.errors;
    LAB.raw.memoryScore  = score;

    LAB.moduleIndex++;
    LAB.nextModule();
  }
};


/* ============================================================
   MODULE 4 â€” SUSTAINED ATTENTION MONITOR
   90-second hit/ignore task (green = tap, red = ignore)
   ============================================================ */
window.mod_sustainedAttention = function() {

  const DURATION = 90; // seconds
  const state = {
    active:      false,
    elapsed:     0,
    hits:        0,
    misses:      0,
    falseAlarms: 0,
    shown:       0,
    currentType: null,
    canTap:      false,
    streakLog:   [],   // 'hit' | 'fa' | 'miss'
  };
  let _countdown = null;
  let _showTimer = null;

  LAB.renderModule(_moduleCard(
    'ğŸ‘ Attention Focus', LAB.moduleIndex + 1, LAB.moduleQueue.length,
    'Sustained Attention Monitor',
    'TAP the <strong style="color:var(--lab-bright)">ğŸŸ¢ Green</strong> shape as fast as you can. IGNORE the <strong style="color:var(--red)">ğŸ”´ Red</strong> shape. 90-second endurance test measuring impulse control and focus drift.',
    `
    <span class="lab-timer" id="attTimer">90</span>

    <div class="att-arena">
      <div class="att-circle att-idle"
           id="attCircle"
           role="button" aria-label="Attention target â€” tap only green"
           tabindex="0"
           onclick="_attTap()"
           onkeydown="if(event.key==='Enter'||event.key===' ') _attTap()">
        <span class="att-shape" id="attShape">â€”</span>
        <span class="att-hint" id="attHint">Waitingâ€¦</span>
      </div>
    </div>

    <!-- Streak indicator -->
    <div class="att-streak" id="attStreak" aria-label="Tap history" aria-live="polite"></div>

    <div class="lab-score-row" style="justify-content:center">
      <div class="lab-score-badge">
        <span class="val" id="attHits">0</span>
        <span class="lbl">Hits âœ“</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="attFA">0</span>
        <span class="lbl">False Alarms âœ—</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="attMiss">0</span>
        <span class="lbl">Missed</span>
      </div>
      <div class="lab-score-badge">
        <span class="val" id="attAcc">â€”</span>
        <span class="lbl">Accuracy</span>
      </div>
    </div>

    <div class="lab-notice" id="attNotice">
      <div class="notice-icon">ğŸ¯</div>
      <p><strong>Green = Tap</strong> &nbsp;Â·&nbsp; <strong>Red = Ignore</strong> &nbsp;Â·&nbsp; Missing a green counts against you. False alarms (tapping red) count against you more.</p>
    </div>

    <div class="lab-btn-row">
      <button class="lab-btn lab-btn--primary" id="attStartBtn" onclick="_attStart()">
        â–¶ Start 90s Test
      </button>
    </div>
    `
  ));

  window._attStart = function() {
    const btn = document.getElementById('attStartBtn');
    if (btn) btn.style.display = 'none';
    const notice = document.getElementById('attNotice');
    if (notice) notice.style.display = 'none';

    state.active = true;
    state.elapsed = 0;

    _countdown = setInterval(() => {
      state.elapsed++;
      const rem     = DURATION - state.elapsed;
      const timerEl = document.getElementById('attTimer');
      if (timerEl) {
        timerEl.textContent = rem;
        timerEl.className   = 'lab-timer' +
          (rem <= 10 ? ' t-crit' : rem <= 25 ? ' t-warn' : '');
      }
      if (state.elapsed >= DURATION) {
        clearInterval(_countdown);
        clearTimeout(_showTimer);
        _attSave(state);
      }
    }, 1000);

    _attShowNext();
  };

  function _attShowNext() {
    if (!state.active || !document.getElementById('attCircle')) return;

    // 62% green, 38% red
    const isGreen   = Math.random() > 0.38;
    state.currentType = isGreen ? 'green' : 'red';
    state.canTap      = true;

    const circle = document.getElementById('attCircle');
    const shape  = document.getElementById('attShape');
    const hint   = document.getElementById('attHint');
    if (!circle) return;

    circle.className = 'att-circle ' + (isGreen ? 'att-green' : 'att-red');
    if (shape) shape.textContent = isGreen ? 'ğŸŸ¢' : 'ğŸ”´';
    if (hint)  hint.textContent  = isGreen ? 'TAP!' : 'IGNORE';

    // How long it stays visible
    const vis = 900 + Math.random() * 700;
    _showTimer = setTimeout(() => {
      if (!state.canTap) return; // already tapped
      state.canTap = false;

      // Auto-expire: if green and not tapped â†’ miss
      if (state.currentType === 'green') {
        state.misses++;
        _attUpdateStreakDot('miss');
        _attUpdateStats();
      }

      // Hide circle
      const c2 = document.getElementById('attCircle');
      const s2 = document.getElementById('attShape');
      const h2 = document.getElementById('attHint');
      if (c2) c2.className = 'att-circle att-idle';
      if (s2) s2.textContent = 'â€”';
      if (h2) h2.textContent = 'Waitâ€¦';

      // Gap between stimuli
      setTimeout(_attShowNext, 300 + Math.random() * 500);
    }, vis);
  }

  window._attTap = function() {
    if (!state.active || !state.canTap) return;
    clearTimeout(_showTimer);
    state.canTap = false;

    const circle = document.getElementById('attCircle');
    const shape  = document.getElementById('attShape');
    const hint   = document.getElementById('attHint');

    if (state.currentType === 'green') {
      state.hits++;
      if (circle) { circle.classList.add('att-hit'); }
      if (hint) hint.textContent = 'âœ“';
      _attUpdateStreakDot('hit');
      _flashFeedback('hit');
    } else {
      state.falseAlarms++;
      if (circle) { circle.classList.add('att-fa'); }
      if (hint) hint.textContent = 'âœ—';
      _attUpdateStreakDot('fa');
      _flashFeedback('miss');
    }

    _attUpdateStats();

    setTimeout(() => {
      const c2 = document.getElementById('attCircle');
      const s2 = document.getElementById('attShape');
      const h2 = document.getElementById('attHint');
      if (c2) { c2.className = 'att-circle att-idle'; }
      if (s2) s2.textContent = 'â€”';
      if (h2) h2.textContent = 'Waitâ€¦';
      setTimeout(_attShowNext, 280 + Math.random() * 400);
    }, 380);
  };

  function _attUpdateStreakDot(type) {
    state.streakLog.push(type);
    const streak = document.getElementById('attStreak');
    if (!streak) return;
    const col = type === 'hit' ? 'sd-hit' : type === 'fa' ? 'sd-fa' : 'sd-miss';
    const dot = document.createElement('div');
    dot.className = 'att-streak-dot ' + col;
    streak.appendChild(dot);
    // Keep max 30 dots visible
    while (streak.children.length > 30) streak.removeChild(streak.firstChild);
    streak.scrollLeft = streak.scrollWidth;
  }

  function _attUpdateStats() {
    const total    = state.hits + state.falseAlarms + state.misses;
    const accuracy = total > 0
      ? Math.round((state.hits / (state.hits + state.falseAlarms + 0.001)) * 100)
      : 100;

    const elHits  = document.getElementById('attHits');
    const elFA    = document.getElementById('attFA');
    const elMiss  = document.getElementById('attMiss');
    const elAcc   = document.getElementById('attAcc');
    if (elHits)  elHits.textContent  = state.hits;
    if (elFA)    elFA.textContent    = state.falseAlarms;
    if (elMiss)  elMiss.textContent  = state.misses;
    if (elAcc)   {
      elAcc.textContent  = accuracy + '%';
      elAcc.style.color  = accuracy > 85 ? 'var(--lab)' : accuracy > 65 ? 'var(--amber)' : 'var(--red)';
    }
  }

  function _attSave(state) {
    const total     = state.hits + state.falseAlarms + state.misses;
    const precision = state.hits / Math.max(1, state.hits + state.falseAlarms);
    const recall    = state.hits / Math.max(1, state.hits + state.misses);
    // F1-style composite, weighted toward precision (impulse control matters more)
    const f1        = (2 * precision * recall) / Math.max(0.01, precision + recall);
    const score     = LAB.clamp(Math.round(f1 * 90 + Math.random() * 6), 15, 100);

    LAB.raw.attHits        = state.hits;
    LAB.raw.attFalseAlarms = state.falseAlarms;
    LAB.raw.attMisses      = state.misses;
    LAB.raw.attPrecision   = Math.round(precision * 100);
    LAB.raw.attRecall      = Math.round(recall * 100);
    LAB.raw.attentionScore = score;

    /* â”€â”€ Compute Cognitive Composite Score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const cogScores = [
      LAB.raw.reactionScore  || 55,
      LAB.raw.fatigueScore   || 55,
      LAB.raw.memoryScore    || 55,
      LAB.raw.attentionScore || 55,
    ];
    LAB.scores.cognitive = Math.round(LAB.avg(cogScores));

    LAB.moduleIndex++;
    LAB.nextModule();
  }
};

/* â”€â”€ Module registration confirmation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
console.log('[WellnessLab] Part 2 loaded â€” Cognitive modules (1â€“4) registered.');

</script>


<!-- ============================================================
     PART 3 CSS â€” Respiratory Â· Stress Â· Motor Â· Lifestyle
     ============================================================ -->
<style>
/* â”€â”€ Breath Circle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.breath-stage { display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem 0; }
.breath-outer { position:relative;width:200px;height:200px;display:flex;align-items:center;justify-content:center;cursor:pointer; }
.breath-ring { position:absolute;inset:0;border-radius:50%;border:2.5px solid var(--lab);transform:scale(1);opacity:0.35; }
.breath-ring.br-inhale { animation:br-expand 4s ease-in-out infinite; }
.breath-ring.br-exhale { animation:br-contract 4s ease-in-out infinite; }
@keyframes br-expand   { 0%,100%{transform:scale(1);opacity:0.35} 50%{transform:scale(1.38);opacity:1} }
@keyframes br-contract { 0%,100%{transform:scale(1.38);opacity:1} 50%{transform:scale(1);opacity:0.35} }
.breath-inner { position:relative;z-index:1;width:108px;height:108px;border-radius:50%;background:var(--lab-dim);border:2px solid var(--border-h);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.15rem;transition:background 0.5s; }
.breath-inner.bi-inhale { background:rgba(56,180,140,0.22); }
.breath-inner.bi-exhale { background:rgba(56,180,140,0.06); }
.breath-phase-label { font-family:var(--font-mono);font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--lab); }
.breath-cycle-count { font-family:var(--font-mono);font-size:0.62rem;color:var(--text-muted); }
.breath-tap-hint { font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);text-align:center;margin-top:0.85rem;letter-spacing:0.06em; }
.breath-sync-bar { width:100%;max-width:280px;height:6px;background:var(--surface);border-radius:3px;overflow:hidden;margin-top:1rem;border:1px solid var(--border); }
.breath-sync-fill { height:100%;border-radius:3px;background:linear-gradient(90deg,var(--lab),var(--lab-bright));transition:width 0.4s var(--ease); }
/* â”€â”€ Hold Ring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hold-ring-wrap { display:flex;align-items:center;justify-content:center;margin:1.5rem 0; }
.hold-ring { position:relative;width:180px;height:180px; }
.hold-ring svg { transform:rotate(-90deg); }
.hold-ring-bg   { fill:none;stroke:var(--surface);stroke-width:10; }
.hold-ring-fill { fill:none;stroke:var(--lab);stroke-width:10;stroke-linecap:round;stroke-dasharray:502;stroke-dashoffset:502;transition:stroke-dashoffset 0.3s linear,stroke 0.4s; }
.hold-ring-text { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.1rem; }
.hold-ring-num  { font-family:var(--font-mono);font-size:2.8rem;font-weight:600;color:var(--lab-bright);line-height:1; }
.hold-ring-lbl  { font-family:var(--font-mono);font-size:0.62rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em; }
/* â”€â”€ Arithmetic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.arith-display { background:var(--ink-4);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;text-align:center;margin:1rem 0;position:relative;overflow:hidden; }
.arith-display.with-distraction::after { content:'';position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(45deg,transparent,transparent 8px,rgba(232,85,85,0.022) 8px,rgba(232,85,85,0.022) 9px);animation:distract-move 2s linear infinite; }
@keyframes distract-move { from{background-position:0 0} to{background-position:24px 24px} }
.arith-question { font-family:var(--font-mono);font-size:clamp(2rem,6vw,3.2rem);font-weight:600;color:var(--text);margin-bottom:0.35rem; }
.arith-time-bar  { height:3px;background:var(--surface);border-radius:2px;overflow:hidden;margin-bottom:1.5rem; }
.arith-time-fill { height:100%;background:var(--lab);border-radius:2px;transition:width 0.1s linear; }
.arith-choices { display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;max-width:300px;margin:0 auto; }
.arith-choice { padding:0.9rem;background:var(--ink-3);border:2px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-mono);font-size:1.2rem;color:var(--text);cursor:pointer;transition:all 0.18s var(--ease);text-align:center; }
.arith-choice:hover:not(:disabled) { border-color:var(--lab);color:var(--lab-bright);transform:scale(1.04); }
.arith-choice.ac-correct { border-color:var(--lab);background:rgba(56,180,140,0.15);color:var(--lab-bright); }
.arith-choice.ac-wrong   { border-color:var(--red);background:rgba(232,85,85,0.12);color:var(--red); }
.arith-choice:disabled { pointer-events:none; }
/* â”€â”€ Pattern Arena â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pattern-arena { position:relative;width:100%;height:240px;background:var(--ink-4);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin:1rem 0; }
.pattern-shape { position:absolute;display:flex;align-items:center;justify-content:center;width:52px;height:52px;border-radius:8px;font-size:1.9rem;cursor:pointer;transition:transform 0.12s;user-select:none; }
.pattern-shape:hover { transform:scale(1.18); }
.pattern-target-label { display:inline-flex;align-items:center;gap:0.5rem;padding:0.55rem 1.2rem;background:var(--ink-4);border:1px solid var(--border-h);border-radius:var(--radius-sm);margin-bottom:1rem;font-family:var(--font-mono);font-size:0.8rem;color:var(--text-mid); }
.pattern-target-label strong { color:var(--text);font-size:1.2rem; }
/* â”€â”€ Stability Ring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stability-wrap { display:flex;align-items:center;justify-content:center;margin:1.5rem 0; }
.stability-ring { position:relative;width:220px;height:220px; }
.stability-ring-outer { fill:none;stroke:var(--border);stroke-width:1.5; }
.stability-ring-zone  { fill:none;stroke:rgba(56,180,140,0.25);stroke-width:1;stroke-dasharray:4 4; }
.stability-dot   { fill:var(--lab-bright);filter:drop-shadow(0 0 6px rgba(78,237,184,0.7)); }
.stability-center{ fill:rgba(56,180,140,0.12); }
.stability-index-label { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.1rem;pointer-events:none; }
.stability-idx-num { font-family:var(--font-mono);font-size:1.8rem;font-weight:600;color:var(--lab-bright);line-height:1; }
.stability-idx-lbl { font-family:var(--font-mono);font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em; }
/* â”€â”€ Tremor Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tremor-canvas-wrap { position:relative;margin:1rem 0; }
#tremorCanvas { width:100%;height:160px;display:block;background:var(--ink-4);border:1px solid var(--border);border-radius:var(--radius);cursor:crosshair;touch-action:none; }
.tremor-guideline { position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);height:0;border-top:1px dashed rgba(56,180,140,0.2);pointer-events:none; }
/* â”€â”€ Lifestyle Rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lifestyle-row { display:flex;align-items:center;gap:1rem;padding:1rem 1.1rem;background:var(--ink-4);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:0.75rem;flex-wrap:wrap; }
.lifestyle-row-icon { font-size:1.35rem;flex-shrink:0; }
.lifestyle-row-body { flex:1;min-width:180px; }
.lifestyle-row-label { font-size:0.84rem;font-weight:600;color:var(--text);margin-bottom:0.4rem; }
/* â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-timer { font-family:var(--font-mono);font-size:clamp(2.8rem,8vw,4.5rem);font-weight:600;line-height:1;text-align:center;color:var(--lab-bright);letter-spacing:0.04em;text-shadow:0 0 30px rgba(78,237,184,0.35);display:block;margin:1rem 0;transition:color 0.3s,text-shadow 0.3s; }
.lab-timer.t-warn { color:var(--amber);text-shadow:0 0 30px rgba(240,160,32,0.35); }
.lab-timer.t-crit { color:var(--red);text-shadow:0 0 30px rgba(232,85,85,0.45);animation:lab-pulse 0.6s ease-in-out infinite; }
/* â”€â”€ Reaction zone states (used in modules 7) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rx-zone { width:100%;border-radius:var(--radius);height:200px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0.5rem;cursor:pointer;user-select:none;border:2px solid var(--border);transition:background 0.12s,border-color 0.12s;position:relative;overflow:hidden; }
.rx-zone .rz-label { font-family:var(--font-mono);font-size:clamp(1rem,3vw,1.4rem);font-weight:600;letter-spacing:0.06em;text-transform:uppercase;transition:color 0.12s; }
.rx-zone .rz-sub   { font-family:var(--font-mono);font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;opacity:0.55; }
.rx-zone.rz-wait  { background:rgba(10,18,20,0.6);border-color:var(--border); }
.rx-zone.rz-wait .rz-label { color:var(--text-muted); }
.rx-zone.rz-ready { background:rgba(56,180,140,0.12);border-color:var(--lab);box-shadow:0 0 0 4px rgba(56,180,140,0.12),0 0 40px rgba(56,180,140,0.2);animation:rx-flash 0.15s ease; }
.rx-zone.rz-ready .rz-label { color:var(--lab-bright); }
.rx-zone.rz-result { background:rgba(56,180,140,0.06);border-color:rgba(56,180,140,0.4);cursor:default; }
.rx-history { display:flex;align-items:flex-end;gap:5px;height:48px;margin:0.75rem 0; }
.rx-bar { flex:1;border-radius:3px 3px 0 0;min-height:4px;max-height:48px;transition:height 0.4s var(--ease); }
</style>


<!-- ============================================================
     PART 3 JAVASCRIPT â€” Modules 5â€“13
     ============================================================ -->
<script>
'use strict';

/* helpers reused from Part 2 */
function _rxBarsHTML(times) {
  if(!times.length) return '';
  const max=Math.max(...times,600);
  return times.map(t=>{
    const h=Math.max(4,Math.round((t/max)*48));
    const c=t<250?'var(--lab)':t<400?'var(--amber)':'var(--red)';
    return `<div class="rx-bar" style="height:${h}px;background:${c}" title="${t}ms"></div>`;
  }).join('');
}
function _flashFeedback(type){
  let f=document.getElementById('_feedbackFlash');
  if(!f){f=document.createElement('div');f.id='_feedbackFlash';f.style.cssText='position:fixed;inset:0;z-index:8000;pointer-events:none;opacity:0;transition:opacity 0.12s';document.body.appendChild(f);}
  f.style.background=type==='hit'?'rgba(56,180,140,0.07)':'rgba(232,85,85,0.08)';
  requestAnimationFrame(()=>{f.style.opacity='1';setTimeout(()=>f.style.opacity='0',120);});
}

/* ============================================================
   MODULE 5 â€” BREATH SYNCHRONIZATION
   ============================================================ */
window.mod_breathSync = function(){
  const CYCLES=6, HALF_MS=4000;
  const st={active:false,cycleStart:0,phase:'inhale',halfCount:0,deviations:[],taps:0};
  let _pt=null;
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">ğŸŒ¬ Respiratory Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Breath Synchronization</h2>
      <p class="lab-p">Follow the circle. <strong style="color:var(--lab-bright)">Tap at peak expansion</strong> (inhale) and again at <strong style="color:var(--lab-bright)">full contraction</strong> (exhale). 6 cycles.</p>
    </div>
    <div class="breath-stage">
      <div class="breath-outer" id="breathOuter" onclick="_breathTap()" role="button" aria-label="Breath circle" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' ')_breathTap()">
        <div class="breath-ring" id="breathRing"></div>
        <div class="breath-inner" id="breathInner">
          <span class="breath-phase-label" id="breathPhaseLabel">Tap to Start</span>
          <span class="breath-cycle-count" id="breathCycleCount">0/${CYCLES}</span>
        </div>
      </div>
      <p class="breath-tap-hint" id="breathHint">Tap the circle to begin</p>
      <div class="breath-sync-bar"><div class="breath-sync-fill" id="breathSyncFill" style="width:0%"></div></div>
      <div style="font-family:var(--font-mono);font-size:0.64rem;color:var(--text-muted);margin-top:0.4rem;text-align:center" id="breathSyncPct">Sync Accuracy: â€”</div>
    </div>
    <div class="lab-score-row" style="justify-content:center">
      <div class="lab-score-badge"><span class="val" id="breathTaps">0</span><span class="lbl">Taps</span></div>
      <div class="lab-score-badge"><span class="val" id="breathSyncScore">â€”</span><span class="lbl">Avg Sync %</span></div>
    </div>
  </div></div>`);

  function _cycle(){
    st.cycleStart=performance.now(); st.phase='inhale'; st.halfCount++;
    const ring=document.getElementById('breathRing'),inner=document.getElementById('breathInner');
    const lbl=document.getElementById('breathPhaseLabel'),hint=document.getElementById('breathHint');
    if(ring) ring.className='breath-ring br-inhale';
    if(inner) inner.className='breath-inner bi-inhale';
    if(lbl) lbl.textContent='INHALE';
    if(hint) hint.textContent='Tap at peak expansion â†‘';
    _pt=setTimeout(()=>{
      st.phase='exhale'; st.cycleStart=performance.now();
      if(ring) ring.className='breath-ring br-exhale';
      if(inner) inner.className='breath-inner bi-exhale';
      if(lbl) lbl.textContent='EXHALE';
      if(hint) hint.textContent='Tap at full contraction â†“';
      _pt=setTimeout(()=>{
        const done=Math.floor(st.halfCount/2);
        const ce=document.getElementById('breathCycleCount');
        if(ce) ce.textContent=done+'/'+CYCLES;
        if(done>=CYCLES) _breathSave(); else _cycle();
      },HALF_MS);
    },HALF_MS);
  }

  window._breathTap=function(){
    if(!st.active){st.active=true;_cycle();return;}
    const elapsed=performance.now()-st.cycleStart;
    const dev=Math.abs(elapsed-HALF_MS)/HALF_MS;
    const sync=Math.max(0,1-dev);
    st.deviations.push(sync); st.taps++;
    const avg=LAB.avg(st.deviations);
    const pct=Math.round(avg*100);
    const fe=document.getElementById('breathSyncFill'),pe=document.getElementById('breathSyncPct');
    const te=document.getElementById('breathTaps'),se=document.getElementById('breathSyncScore');
    if(fe) fe.style.width=pct+'%';
    if(pe) pe.textContent='Sync Accuracy: '+pct+'%';
    if(te) te.textContent=st.taps;
    if(se){se.textContent=pct+'%';se.style.color=LAB.scoreColor(pct);}
  };

  function _breathSave(){
    clearTimeout(_pt);
    const s=LAB.clamp(Math.round(LAB.avg(st.deviations)*100),20,100);
    LAB.raw.breathSyncScore=s; LAB.raw.breathTaps=st.taps;
    LAB.moduleIndex++; LAB.nextModule();
  }
};

/* ============================================================
   MODULE 6 â€” COâ‚‚ TOLERANCE TEST
   ============================================================ */
window.mod_co2Tolerance=function(){
  let holding=false,startTime=0,ticker=null,duration=0;
  const CIRC=2*Math.PI*80;
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">â± Respiratory Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">COâ‚‚ Tolerance Test</h2>
      <p class="lab-p">Take a slow <strong>deep breath in</strong>. Press <em style="color:var(--lab-bright)">Start Hold</em>. When you feel the natural urge to breathe, press <em style="color:var(--gold-bright)">Release</em>. Never strain.</p>
    </div>
    <div class="hold-ring-wrap"><div class="hold-ring">
      <svg width="180" height="180" viewBox="0 0 180 180">
        <circle class="hold-ring-bg"   cx="90" cy="90" r="80"/>
        <circle class="hold-ring-fill" id="holdRingFill" cx="90" cy="90" r="80"/>
      </svg>
      <div class="hold-ring-text">
        <span class="hold-ring-num" id="holdNum">0.0</span>
        <span class="hold-ring-lbl" id="holdLbl">seconds</span>
      </div>
    </div></div>
    <div style="text-align:center;font-family:var(--font-mono);font-size:0.78rem;color:var(--text-muted);margin-bottom:1.5rem;min-height:1.4em" id="holdStatus">Take a deep breath in, then press Start Hold</div>
    <div class="lab-score-row" style="justify-content:center">
      <div class="lab-score-badge"><span class="val" id="holdDur">â€”</span><span class="lbl">Duration (s)</span></div>
      <div class="lab-score-badge"><span class="val" id="holdRating">â€”</span><span class="lbl">Rating</span></div>
    </div>
    <div class="lab-btn-row" style="justify-content:center">
      <button class="lab-btn lab-btn--primary lab-btn--lg" id="holdBtn" onclick="_holdToggle()">â–¶ Start Hold</button>
    </div>
    <div class="lab-notice" style="margin-top:1.5rem"><div class="notice-icon">âš ï¸</div><p>Stop immediately if you feel dizzy. This is safe when performed naturally â€” never force it.</p></div>
  </div></div>`);

  window._holdToggle=function(){
    const btn=document.getElementById('holdBtn'),status=document.getElementById('holdStatus');
    if(!holding){
      holding=true; startTime=performance.now();
      if(btn){btn.textContent='â–  Release Hold';btn.className='lab-btn lab-btn--gold lab-btn--lg';}
      if(status) status.textContent='Holdingâ€¦ press Release when you feel the urge to breathe';
      ticker=setInterval(()=>{
        duration=(performance.now()-startTime)/1000;
        const ne=document.getElementById('holdNum'),re=document.getElementById('holdRingFill'),le=document.getElementById('holdLbl');
        if(ne) ne.textContent=duration.toFixed(1);
        if(le) le.textContent=duration<60?'seconds':'EXCELLENT!';
        if(re){
          const pct=Math.min(duration/90,1);
          re.style.strokeDashoffset=CIRC*(1-pct);
          re.style.stroke=duration<20?'var(--lab)':duration<45?'var(--amber)':'var(--gold-bright)';
        }
      },100);
    } else {
      clearInterval(ticker); holding=false;
      duration=(performance.now()-startTime)/1000;
      const rating=duration<15?'Low':duration<25?'Below Average':duration<40?'Average':duration<60?'Good':'Excellent';
      const score=LAB.clamp(Math.round(duration/75*100),10,100);
      const de=document.getElementById('holdDur'),ra=document.getElementById('holdRating'),st=document.getElementById('holdStatus');
      if(de){de.textContent=duration.toFixed(1)+'s';de.style.color=LAB.scoreColor(score);}
      if(ra){ra.textContent=rating;ra.style.color=LAB.scoreColor(score);}
      if(st) st.textContent='Complete â€” '+rating+' COâ‚‚ tolerance';
      if(btn) btn.style.display='none';
      LAB.raw.co2Duration=parseFloat(duration.toFixed(1)); LAB.raw.co2Score=score;
      setTimeout(()=>{LAB.moduleIndex++;LAB.nextModule();},2600);
    }
  };
};

/* ============================================================
   MODULE 7 â€” RECOVERY NORMALIZATION
   ============================================================ */
window.mod_recovery=function(){
  const ROUNDS=5;
  const st={round:0,times:[],waiting:false,startT:0};
  let _timer=null;
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">â™»ï¸ Respiratory Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Recovery Normalization</h2>
      <p class="lab-p">5 quick reaction rounds immediately after the breath hold. Measures how fast your nervous system returns to baseline after respiratory stress.</p>
    </div>
    <div id="recovZone" class="rx-zone rz-wait" style="height:170px" onclick="_recovTap()" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' ')_recovTap()">
      <span class="rz-label" id="recovLabel">Preparingâ€¦</span>
      <span class="rz-sub">5 quick rounds</span>
    </div>
    <div class="rx-history" id="recovHistory"></div>
    <div class="lab-score-row">
      <div class="lab-score-badge"><span class="val" id="recovRound">0/${ROUNDS}</span><span class="lbl">Round</span></div>
      <div class="lab-score-badge"><span class="val" id="recovAvg">â€”</span><span class="lbl">Avg (ms)</span></div>
      <div class="lab-score-badge"><span class="val" id="recovVsBase">â€”</span><span class="lbl">vs Baseline</span></div>
    </div>
  </div></div>`);
  setTimeout(_rSched,900);
  function _rSched(){
    const z=document.getElementById('recovZone'),l=document.getElementById('recovLabel');
    if(!z) return;
    z.className='rx-zone rz-wait'; if(l) l.textContent='Waitâ€¦'; st.waiting=false;
    _timer=setTimeout(()=>{
      const z2=document.getElementById('recovZone'),l2=document.getElementById('recovLabel');
      if(!z2) return;
      z2.className='rx-zone rz-ready'; if(l2) l2.textContent='TAP!'; st.waiting=true; st.startT=performance.now();
    },900+Math.random()*2000);
  }
  window._recovTap=function(){
    if(!st.waiting) return;
    const rt=Math.round(performance.now()-st.startT);
    st.times.push(rt); st.round++; st.waiting=false;
    const z=document.getElementById('recovZone'),l=document.getElementById('recovLabel');
    if(z) z.className='rx-zone rz-result'; if(l) l.textContent='âœ“ '+rt+'ms';
    const avgNow=Math.round(LAB.avg(st.times));
    const base=LAB.raw.reactionAvg||350;
    const diff=avgNow-base;
    const er=document.getElementById('recovRound'),ea=document.getElementById('recovAvg'),ev=document.getElementById('recovVsBase'),eh=document.getElementById('recovHistory');
    if(er) er.textContent=st.round+'/'+ROUNDS;
    if(ea) ea.textContent=avgNow+'ms';
    if(ev){ev.textContent=(diff>=0?'+':'')+diff+'ms';ev.style.color=diff<30?'var(--lab)':diff<80?'var(--amber)':'var(--red)';}
    if(eh) eh.innerHTML=_rxBarsHTML(st.times);
    _flashFeedback('hit');
    if(st.round>=ROUNDS){clearTimeout(_timer);setTimeout(_rSave,700);}
    else setTimeout(_rSched,700);
  };
  function _rSave(){
    const base=LAB.raw.reactionAvg||350;
    const drift=Math.max(0,LAB.avg(st.times)-base);
    const score=LAB.clamp(Math.round(100-drift/5),20,100);
    LAB.raw.recoveryScore=score; LAB.raw.recoveryAvg=Math.round(LAB.avg(st.times));
    LAB.scores.respiratory=Math.round(LAB.avg([LAB.raw.breathSyncScore||60,LAB.raw.co2Score||60,score]));
    LAB.moduleIndex++; LAB.nextModule();
  }
};

/* ============================================================
   MODULE 8 â€” COGNITIVE UNDER PRESSURE
   ============================================================ */
window.mod_cognitiveUnderPressure=function(){
  const TOTAL=12,TIME_MS=5000;
  const st={q:0,correct:0,wrong:0,times:[],startT:0};
  let _tba=null;
  function _gen(){
    const ops=['+','âˆ’','Ã—'],op=ops[Math.floor(Math.random()*3)];
    let a,b,ans;
    if(op==='+'){a=8+Math.floor(Math.random()*28);b=5+Math.floor(Math.random()*25);ans=a+b;}
    else if(op==='âˆ’'){a=20+Math.floor(Math.random()*40);b=5+Math.floor(Math.random()*20);ans=a-b;}
    else{a=2+Math.floor(Math.random()*9);b=2+Math.floor(Math.random()*9);ans=a*b;}
    const wr=new Set();
    while(wr.size<3){const w=ans+Math.floor(Math.random()*17)-8;if(w!==ans)wr.add(w);}
    return{expr:`${a} ${op} ${b}`,answer:ans,choices:[ans,...wr].sort(()=>Math.random()-0.5)};
  }
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">ğŸ”¥ Stress Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Cognitive Under Pressure</h2>
      <p class="lab-p">Solve ${TOTAL} arithmetic problems quickly and accurately. A visual distraction activates halfway â€” mimicking real cognitive stress.</p>
    </div>
    <div class="lab-score-row">
      <div class="lab-score-badge"><span class="val" id="arithQ">0/${TOTAL}</span><span class="lbl">Question</span></div>
      <div class="lab-score-badge"><span class="val" id="arithCorrect">0</span><span class="lbl">Correct âœ“</span></div>
      <div class="lab-score-badge"><span class="val" id="arithWrong">0</span><span class="lbl">Wrong âœ—</span></div>
      <div class="lab-score-badge"><span class="val" id="arithAvgMs">â€”</span><span class="lbl">Avg speed</span></div>
    </div>
    <div class="arith-display" id="arithDisplay">
      <div class="arith-time-bar"><div class="arith-time-fill" id="arithTimeFill" style="width:100%"></div></div>
      <div class="arith-question" id="arithQuestion">Loadingâ€¦</div>
      <div class="arith-choices" id="arithChoices"></div>
    </div>
    <div style="text-align:center;font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted);min-height:1.4em" id="arithStatus"></div>
  </div></div>`);
  setTimeout(_next,600);
  function _startBar(){
    clearInterval(_tba);
    const s=performance.now();
    _tba=setInterval(()=>{
      const pct=Math.max(0,100-((performance.now()-s)/TIME_MS)*100);
      const f=document.getElementById('arithTimeFill');
      if(f){f.style.width=pct+'%';f.style.background=pct>50?'var(--lab)':pct>20?'var(--amber)':'var(--red)';}
      if(pct<=0){clearInterval(_tba);_record(false,TIME_MS);}
    },80);
  }
  function _next(){
    if(!document.getElementById('arithDisplay')) return;
    if(st.q>=TOTAL){_save();return;}
    const q=_gen(); st.startT=performance.now();
    const qe=document.getElementById('arithQuestion'),ce=document.getElementById('arithChoices');
    const qn=document.getElementById('arithQ'),di=document.getElementById('arithDisplay'),sta=document.getElementById('arithStatus');
    if(qn) qn.textContent=`${st.q+1}/${TOTAL}`;
    if(qe) qe.textContent=q.expr+' = ?';
    if(sta) sta.textContent=st.q>=6?'âš  Distraction mode â€” stay focused':st.q>=4?'Distraction activatingâ€¦':'';
    if(di&&st.q>=4) di.classList.add('with-distraction');
    if(ce) ce.innerHTML=q.choices.map(c=>`<button class="arith-choice" onclick="_arithPick(this,${c},${q.answer})">${c}</button>`).join('');
    _startBar();
  }
  window._arithPick=function(btn,chosen,correct){
    clearInterval(_tba);
    const rt=Math.round(performance.now()-st.startT);
    document.querySelectorAll('.arith-choice').forEach(b=>b.disabled=true);
    btn.classList.add(chosen===correct?'ac-correct':'ac-wrong');
    if(chosen!==correct) document.querySelectorAll('.arith-choice').forEach(b=>{if(parseInt(b.textContent)===correct) b.classList.add('ac-correct');});
    _record(chosen===correct,rt);
  };
  function _record(ok,rt){
    if(ok) st.correct++; else st.wrong++;
    st.times.push(rt); st.q++;
    const ec=document.getElementById('arithCorrect'),ew=document.getElementById('arithWrong'),ea=document.getElementById('arithAvgMs');
    if(ec) ec.textContent=st.correct;
    if(ew){ew.textContent=st.wrong;ew.style.color=st.wrong>2?'var(--red)':'var(--text)';}
    if(ea) ea.textContent=Math.round(LAB.avg(st.times))+'ms';
    if(ok) _flashFeedback('hit'); else _flashFeedback('miss');
    setTimeout(_next,550);
  }
  function _save(){
    const acc=st.correct/TOTAL,avgMs=LAB.avg(st.times);
    const early=st.times.slice(0,6),late=st.times.slice(6);
    const slowdown=late.length?LAB.avg(late)-LAB.avg(early):0;
    const score=LAB.clamp(Math.round(acc*75+Math.max(0,1-avgMs/4000)*20-Math.max(0,slowdown/30)),15,100);
    LAB.raw.arithCorrect=st.correct; LAB.raw.arithWrong=st.wrong; LAB.raw.arithScore=score;
    LAB.moduleIndex++; LAB.nextModule();
  }
};

/* ============================================================
   MODULE 9 â€” VISUAL PATTERN OVERLOAD
   ============================================================ */
window.mod_patternOverload=function(){
  const SHAPES=['â­•','ğŸ”·','â¬›','ğŸ”º','ğŸŸ¡','ğŸŸ£','ğŸ”¶','ğŸŸ¤'];
  const TARGET=SHAPES[Math.floor(Math.random()*SHAPES.length)];
  const ROUNDS=8;
  const st={round:0,hits:0,falseAlarms:0,misses:0};
  let _auto=null;
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">ğŸ”· Stress Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Visual Pattern Overload</h2>
      <p class="lab-p">Find and tap the target shape only. Ignore all others. Appears briefly â€” react fast.</p>
    </div>
    <div class="pattern-target-label">Target: <strong id="patTarget">${TARGET}</strong> &nbsp;â€” Tap it only, ignore everything else.</div>
    <div class="pattern-arena" id="patArena"></div>
    <div class="lab-score-row" style="justify-content:center">
      <div class="lab-score-badge"><span class="val" id="patRound">0/${ROUNDS}</span><span class="lbl">Round</span></div>
      <div class="lab-score-badge"><span class="val" id="patHits">0</span><span class="lbl">Hits âœ“</span></div>
      <div class="lab-score-badge"><span class="val" id="patFA">0</span><span class="lbl">False Alarms</span></div>
      <div class="lab-score-badge"><span class="val" id="patAcc">â€”</span><span class="lbl">Accuracy</span></div>
    </div>
  </div></div>`);
  setTimeout(_show,600);
  function _show(){
    const arena=document.getElementById('patArena');
    if(!arena) return;
    arena.innerHTML='';
    const hasTarget=Math.random()>0.28;
    const count=4+Math.floor(st.round*0.5)+Math.floor(Math.random()*3);
    const t0=performance.now(); let tapped=false;
    for(let i=0;i<count;i++){
      const isT=(i===0&&hasTarget);
      const shape=isT?TARGET:SHAPES.filter(s=>s!==TARGET)[Math.floor(Math.random()*(SHAPES.length-1))];
      const el=document.createElement('div');
      el.className='pattern-shape'; el.textContent=shape;
      el.style.left=(5+Math.random()*82)+'%'; el.style.top=(5+Math.random()*72)+'%';
      el.onclick=function(){
        if(tapped) return; tapped=true; clearTimeout(_auto);
        st.round++;
        if(isT){st.hits++;_flashFeedback('hit');el.style.background='rgba(56,180,140,0.35)';}
        else{st.falseAlarms++;_flashFeedback('miss');el.style.background='rgba(232,85,85,0.3)';}
        _upd(); setTimeout(()=>{ if(st.round>=ROUNDS)_save(); else _show(); },560);
      };
      arena.appendChild(el);
    }
    _auto=setTimeout(()=>{
      if(tapped) return; tapped=true; st.round++;
      if(hasTarget) st.misses++;
      _upd(); if(st.round>=ROUNDS)_save(); else _show();
    },Math.max(1200,2000-st.round*80));
  }
  function _upd(){
    const acc=Math.round(st.hits/Math.max(1,st.hits+st.falseAlarms)*100);
    const er=document.getElementById('patRound'),eh=document.getElementById('patHits'),ef=document.getElementById('patFA'),ea=document.getElementById('patAcc');
    if(er) er.textContent=st.round+'/'+ROUNDS;
    if(eh) eh.textContent=st.hits; if(ef) ef.textContent=st.falseAlarms;
    if(ea){ea.textContent=acc+'%';ea.style.color=LAB.scoreColor(acc);}
  }
  function _save(){
    const prec=st.hits/Math.max(1,st.hits+st.falseAlarms);
    const rec=st.hits/Math.max(1,st.hits+st.misses);
    const score=LAB.clamp(Math.round(prec*60+rec*40),15,100);
    LAB.raw.patternScore=score;
    LAB.scores.stress=Math.round(LAB.avg([LAB.raw.arithScore||60,score]));
    LAB.moduleIndex++; LAB.nextModule();
  }
};

/* ============================================================
   MODULE 10 â€” STABILITY HOLD TEST
   ============================================================ */
window.mod_stabilityHold=function(){
  const DUR=30;
  const st={active:false,elapsed:0,samples:[]};
  let _cd=null,_mh=null,_msf=null,_sim=null;
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">ğŸ“± Motor Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Stability Hold Test</h2>
      <p class="lab-p">Hold your device perfectly still for 30 seconds. On desktop, keep your mouse still. The dot tracks any detected micro-movement.</p>
    </div>
    <span class="lab-timer" id="stabTimer">30</span>
    <div class="stability-wrap"><div class="stability-ring">
      <svg id="stabSvg" width="220" height="220" viewBox="0 0 220 220">
        <circle class="stability-ring-outer" cx="110" cy="110" r="105"/>
        <circle class="stability-ring-zone"  cx="110" cy="110" r="28"/>
        <circle class="stability-center"     cx="110" cy="110" r="4" opacity="0.4"/>
        <circle class="stability-dot" id="stabDot" cx="110" cy="110" r="7"/>
      </svg>
      <div class="stability-index-label">
        <span class="stability-idx-num" id="stabIdx">â€”</span>
        <span class="stability-idx-lbl">Stability Index</span>
      </div>
    </div></div>
    <div style="text-align:center;font-family:var(--font-mono);font-size:0.76rem;color:var(--text-muted)" id="stabStatus">Press Start, then hold as still as possible</div>
    <div class="lab-score-row" style="justify-content:center;margin-top:1rem">
      <div class="lab-score-badge"><span class="val" id="stabVar">â€”</span><span class="lbl">Avg Variance</span></div>
      <div class="lab-score-badge"><span class="val" id="stabSens">â€”</span><span class="lbl">Sensor</span></div>
    </div>
    <div class="lab-btn-row" style="justify-content:center">
      <button class="lab-btn lab-btn--primary" id="stabBtn" onclick="_stabStart()">â–¶ Start 30s Hold</button>
    </div>
  </div></div>`);

  window._stabStart=function(){
    const btn=document.getElementById('stabBtn'); if(btn) btn.style.display='none';
    st.active=true; st.elapsed=0;
    const sens=document.getElementById('stabSens');
    if(window.DeviceMotionEvent){
      if(sens) sens.textContent='Gyroscope';
      _mh=function(e){
        if(!st.active) return;
        const acc=e.acceleration||e.accelerationIncludingGravity;
        if(!acc) return;
        const x=acc.x||0,y=acc.y||0,z=acc.z||0;
        const mag=Math.sqrt(x*x+y*y+z*z);
        st.samples.push(mag);
        _moveDot(110+LAB.clamp(x*18,-90,90),110+LAB.clamp(y*18,-90,90));
        _updIdx();
      };
      window.addEventListener('devicemotion',_mh);
    } else {
      if(sens) sens.textContent='Mouse';
      _msf=function(e){
        if(!st.active) return;
        st.samples.push(Math.sqrt((e.movementX||0)**2+(e.movementY||0)**2)*0.4);
        _updIdx();
      };
      window.addEventListener('mousemove',_msf);
      let t=0;
      _sim=setInterval(()=>{
        if(!st.active){clearInterval(_sim);return;}
        t+=0.2;
        const j=Math.sin(t*2.3)*5+Math.cos(t*1.7)*3;
        st.samples.push(Math.abs(j)*0.12);
        _moveDot(110+Math.sin(t)*j*0.7,110+Math.cos(t*1.3)*j*0.5);
        _updIdx();
      },130);
    }
    _cd=setInterval(()=>{
      st.elapsed++;
      const rem=DUR-st.elapsed;
      const te=document.getElementById('stabTimer');
      if(te){te.textContent=rem;te.className='lab-timer'+(rem<=5?' t-crit':rem<=12?' t-warn':'');}
      if(st.elapsed>=DUR){clearInterval(_cd);_stabClean();_stabSave();}
    },1000);
  };
  function _moveDot(x,y){
    const d=document.getElementById('stabDot'); if(!d) return;
    d.setAttribute('cx',x.toFixed(1)); d.setAttribute('cy',y.toFixed(1));
    const dist=Math.sqrt((x-110)**2+(y-110)**2);
    d.style.fill=dist<28?'var(--lab-bright)':dist<55?'var(--amber)':'var(--red)';
  }
  function _updIdx(){
    if(st.samples.length<3) return;
    const avg=LAB.avg(st.samples.slice(-20));
    const idx=LAB.clamp(Math.round(100-avg*12),10,100);
    const ie=document.getElementById('stabIdx'),ve=document.getElementById('stabVar');
    if(ie){ie.textContent=idx;ie.style.color=LAB.scoreColor(idx);}
    if(ve) ve.textContent=avg.toFixed(2);
  }
  function _stabClean(){
    st.active=false;
    if(_mh) window.removeEventListener('devicemotion',_mh);
    if(_msf) window.removeEventListener('mousemove',_msf);
    if(_sim) clearInterval(_sim);
  }
  function _stabSave(){
    const avg=st.samples.length?LAB.avg(st.samples):2.5;
    const score=LAB.clamp(Math.round(100-avg*12),15,100);
    LAB.raw.stabilityScore=score; LAB.raw.stabilityVariance=parseFloat(avg.toFixed(3));
    LAB.moduleIndex++; LAB.nextModule();
  }
};

/* ============================================================
   MODULE 11 â€” MICRO TREMOR ANALYSIS
   ============================================================ */
window.mod_microTremor=function(){
  let points=[],drawing=false;
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">âœ‹ Motor Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Micro Tremor Analysis</h2>
      <p class="lab-p">Draw a single <strong>slow horizontal line</strong> from left to right. Move as smoothly as possible. Vertical deviations measure your neuromotor steadiness.</p>
    </div>
    <div class="tremor-canvas-wrap">
      <canvas id="tremorCanvas"></canvas>
      <div class="tremor-guideline"></div>
    </div>
    <div style="text-align:center;font-family:var(--font-mono);font-size:0.76rem;color:var(--text-muted);min-height:1.4em;margin-top:0.5rem" id="tremorStatus">Draw slowly â€” one continuous stroke â†’</div>
    <div class="lab-score-row" style="justify-content:center">
      <div class="lab-score-badge"><span class="val" id="tremorPts">0</span><span class="lbl">Points</span></div>
      <div class="lab-score-badge"><span class="val" id="tremorSD">â€”</span><span class="lbl">Deviation (px)</span></div>
      <div class="lab-score-badge"><span class="val" id="tremorScore">â€”</span><span class="lbl">Steadiness</span></div>
    </div>
    <div class="lab-btn-row">
      <button class="lab-btn lab-btn--ghost lab-btn--sm" onclick="_tremorClear()">â†º Clear &amp; Retry</button>
      <button class="lab-btn lab-btn--primary" id="tremorNextBtn" disabled onclick="_tremorNext()">Accept &amp; Continue â†’</button>
    </div>
  </div></div>`);

  const canvas=document.getElementById('tremorCanvas'); if(!canvas) return;
  const rect=canvas.getBoundingClientRect();
  canvas.width=Math.max(300,rect.width||500); canvas.height=160;
  const ctx=canvas.getContext('2d');
  function _style(){ctx.strokeStyle='rgba(78,237,184,0.85)';ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineJoin='round';}
  function _pos(e){
    const r=canvas.getBoundingClientRect(),sx=canvas.width/r.width,sy=canvas.height/r.height;
    if(e.touches) return{x:(e.touches[0].clientX-r.left)*sx,y:(e.touches[0].clientY-r.top)*sy};
    return{x:(e.clientX-r.left)*sx,y:(e.clientY-r.top)*sy};
  }
  function _start(e){e.preventDefault();drawing=true;points=[];ctx.clearRect(0,0,canvas.width,canvas.height);_style();const p=_pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);points.push(p);const b=document.getElementById('tremorNextBtn');if(b) b.disabled=true;}
  function _move(e){if(!drawing) return;e.preventDefault();const p=_pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();points.push(p);const el=document.getElementById('tremorPts');if(el) el.textContent=points.length;}
  function _end(e){
    if(!drawing) return; drawing=false;
    if(points.length<15){const s=document.getElementById('tremorStatus');if(s)s.textContent='Draw a longer line â€” at least halfway across.';return;}
    const ys=points.map(p=>p.y);
    const sd=LAB.stdev(ys);
    const steadiness=LAB.clamp(Math.round(100-sd*2.2),15,100);
    const es=document.getElementById('tremorSD'),ec=document.getElementById('tremorScore'),est=document.getElementById('tremorStatus'),btn=document.getElementById('tremorNextBtn');
    if(es) es.textContent=sd.toFixed(1)+'px';
    if(ec){ec.textContent=steadiness;ec.style.color=LAB.scoreColor(steadiness);}
    if(est) est.textContent=steadiness>=75?'âœ“ Excellent steadiness':steadiness>=50?'Good â€” or retry':'â†º Try again for a steadier line';
    if(btn) btn.disabled=false;
    LAB.raw.tremorSD=parseFloat(sd.toFixed(2)); LAB.raw.tremorScore=steadiness;
    LAB.scores.stability=Math.round(LAB.avg([LAB.raw.stabilityScore||65,steadiness]));
  }
  canvas.addEventListener('mousedown',_start); canvas.addEventListener('mousemove',_move);
  canvas.addEventListener('mouseup',_end); canvas.addEventListener('mouseleave',_end);
  canvas.addEventListener('touchstart',_start,{passive:false}); canvas.addEventListener('touchmove',_move,{passive:false});
  canvas.addEventListener('touchend',_end);
  window._tremorClear=function(){
    ctx.clearRect(0,0,canvas.width,canvas.height); points=[]; drawing=false;
    ['tremorPts','tremorSD','tremorScore'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=id==='tremorPts'?'0':'â€”';});
    const s=document.getElementById('tremorStatus');if(s)s.textContent='Draw slowly â€” one continuous stroke â†’';
    const b=document.getElementById('tremorNextBtn');if(b)b.disabled=true;
  };
  window._tremorNext=function(){LAB.moduleIndex++;LAB.nextModule();};
};

/* ============================================================
   MODULE 12 â€” SLEEP EFFICIENCY CALCULATOR
   ============================================================ */
window.mod_sleepEfficiency=function(){
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">ğŸ’¤ Lifestyle Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Sleep Efficiency Calculator</h2>
      <p class="lab-p">Answer based on your average over the past two weeks. Honest responses give the most accurate wellness score.</p>
    </div>
    <div class="lab-grid-2">
      <div class="lab-field"><label class="lab-label" for="s1">Avg sleep per night (hours)</label><input class="lab-input" type="number" id="s1" min="2" max="14" step="0.5" placeholder="e.g. 7" inputmode="decimal"></div>
      <div class="lab-field"><label class="lab-label" for="s2">Time to fall asleep (minutes)</label><input class="lab-input" type="number" id="s2" min="0" max="120" placeholder="e.g. 20" inputmode="numeric"></div>
      <div class="lab-field"><label class="lab-label" for="s3">Night-time wake-ups per night</label><input class="lab-input" type="number" id="s3" min="0" max="10" placeholder="e.g. 1" inputmode="numeric"></div>
      <div class="lab-field"><label class="lab-label" for="s4">Sleep quality (1=poor, 5=excellent)</label>
        <select class="lab-select" id="s4"><option value="">Selectâ€¦</option><option value="1">1 â€” Very Poor</option><option value="2">2 â€” Poor</option><option value="3">3 â€” Fair</option><option value="4">4 â€” Good</option><option value="5">5 â€” Excellent</option></select>
      </div>
    </div>
    <div class="lab-field"><label class="lab-label" for="s5">How refreshed do you feel on waking?</label>
      <select class="lab-select" id="s5"><option value="">Selectâ€¦</option><option value="1">Exhausted â€” barely functional</option><option value="2">Tired â€” need coffee to start</option><option value="3">Neutral â€” okay but not great</option><option value="4">Fairly refreshed</option><option value="5">Fully refreshed â€” energised</option></select>
    </div>
    <div class="lab-field"><label class="lab-label" for="s6">Screen use within 1hr of sleep?</label>
      <select class="lab-select" id="s6"><option value="">Selectâ€¦</option><option value="1">Every night</option><option value="2">Most nights</option><option value="3">Sometimes</option><option value="4">Rarely</option><option value="5">Never</option></select>
    </div>
    <div class="lab-btn-row"><button class="lab-btn lab-btn--primary" onclick="_sleepSave()">Calculate â†’</button></div>
  </div></div>`);
  window._sleepSave=function(){
    const hrs=parseFloat(document.getElementById('s1')?.value)||7;
    const lat=parseFloat(document.getElementById('s2')?.value)||20;
    const wakes=parseFloat(document.getElementById('s3')?.value)||1;
    const qual=parseInt(document.getElementById('s4')?.value)||3;
    const ref=parseInt(document.getElementById('s5')?.value)||3;
    const scr=parseInt(document.getElementById('s6')?.value)||3;
    const tib=hrs+lat/60;
    const actual=Math.max(0.5,hrs-wakes*0.22);
    const se=LAB.clamp((actual/tib)*100,10,100);
    const qs=((qual+ref+scr)/3)*20;
    const score=LAB.clamp(Math.round(se*0.55+qs*0.45),15,100);
    LAB.raw.sleepHours=hrs; LAB.raw.sleepEfficiency=parseFloat(se.toFixed(1)); LAB.raw.sleepScore=score;
    LAB.moduleIndex++; LAB.nextModule();
  };
};

/* ============================================================
   MODULE 13 â€” LIFESTYLE LOAD SCORE
   ============================================================ */
window.mod_lifestyleLoad=function(){
  function slv(id,dId,sfx){const e=document.getElementById(id),d=document.getElementById(dId);if(e&&d)d.textContent=e.value+sfx;}
  LAB.renderModule(`<div class="lab-module-wrap"><div class="lab-card lab-card--glow">
    <div class="lab-step-head">
      <div class="lab-tag">âš–ï¸ Lifestyle Â· Module ${LAB.moduleIndex+1} of ${LAB.moduleQueue.length}</div>
      <h2 class="lab-h2" style="margin-top:1rem;margin-bottom:0.6rem">Lifestyle Load Score</h2>
      <p class="lab-p">Rate your average day honestly. This identifies lifestyle strain patterns that affect your health and energy levels.</p>
    </div>
    <div class="lifestyle-row">
      <span class="lifestyle-row-icon">ğŸ“±</span>
      <div class="lifestyle-row-body"><div class="lifestyle-row-label">Daily screen time</div>
        <input class="lab-range" type="range" id="ls1" min="0" max="16" value="6" oninput="slv('ls1','ls1v','h')">
        <div class="lab-range-labels"><span>0h</span><span id="ls1v">6h</span><span>16h</span></div>
      </div>
    </div>
    <div class="lifestyle-row">
      <span class="lifestyle-row-icon">ğŸ¦º</span>
      <div class="lifestyle-row-body"><div class="lifestyle-row-label">Sedentary hours per day</div>
        <input class="lab-range" type="range" id="ls2" min="0" max="16" value="8" oninput="slv('ls2','ls2v','h')">
        <div class="lab-range-labels"><span>0h</span><span id="ls2v">8h</span><span>16h</span></div>
      </div>
    </div>
    <div class="lifestyle-row">
      <span class="lifestyle-row-icon">ğŸƒ</span>
      <div class="lifestyle-row-body"><div class="lifestyle-row-label">Exercise days per week</div>
        <input class="lab-range" type="range" id="ls3" min="0" max="7" value="2" oninput="slv('ls3','ls3v',' days')">
        <div class="lab-range-labels"><span>None</span><span id="ls3v">2 days</span><span>Daily</span></div>
      </div>
    </div>
    <div class="lifestyle-row">
      <span class="lifestyle-row-icon">ğŸ’§</span>
      <div class="lifestyle-row-body"><div class="lifestyle-row-label">Daily water intake</div>
        <select class="lab-select" id="ls4" style="margin-top:0.4rem">
          <option value="1">Less than 1 litre</option><option value="2">1â€“1.5 litres</option>
          <option value="3" selected>1.5â€“2.5 litres (ideal)</option><option value="4">More than 2.5 litres</option>
        </select>
      </div>
    </div>
    <div class="lifestyle-row">
      <span class="lifestyle-row-icon">ğŸ”¥</span>
      <div class="lifestyle-row-body"><div class="lifestyle-row-label">Average daily stress level</div>
        <select class="lab-select" id="ls5" style="margin-top:0.4rem">
          <option value="1">1 â€” Very Low</option><option value="2">2 â€” Low</option>
          <option value="3" selected>3 â€” Moderate</option><option value="4">4 â€” High</option><option value="5">5 â€” Very High</option>
        </select>
      </div>
    </div>
    <div class="lifestyle-row">
      <span class="lifestyle-row-icon">ğŸ¥—</span>
      <div class="lifestyle-row-body"><div class="lifestyle-row-label">Diet quality</div>
        <select class="lab-select" id="ls6" style="margin-top:0.4rem">
          <option value="1">Poor â€” mostly processed food</option><option value="2">Below average</option>
          <option value="3" selected>Average â€” mixed diet</option><option value="4">Good â€” mostly whole foods</option>
          <option value="5">Excellent â€” very balanced</option>
        </select>
      </div>
    </div>
    <div class="lab-btn-row"><button class="lab-btn lab-btn--primary" onclick="_lifestyleSave()">Calculate â†’</button></div>
  </div></div>`);
  window.slv=slv;
  window._lifestyleSave=function(){
    const screen=parseInt(document.getElementById('ls1')?.value)||6;
    const sed=parseInt(document.getElementById('ls2')?.value)||8;
    const ex=parseInt(document.getElementById('ls3')?.value)||2;
    const hydra=parseInt(document.getElementById('ls4')?.value)||3;
    const stress=parseInt(document.getElementById('ls5')?.value)||3;
    const diet=parseInt(document.getElementById('ls6')?.value)||3;
    const sp=screen>10?22:screen>7?12:screen>4?5:0;
    const ssp=sed>11?20:sed>8?12:sed>5?5:0;
    const eb=ex>=5?18:ex>=3?11:ex>=1?5:0;
    const hb=hydra===3?8:hydra===4?6:hydra===2?0:-12;
    const stp=(stress-1)*7;
    const db=(diet-1)*5;
    const score=LAB.clamp(Math.round(80-sp-ssp-stp+eb+hb+db),15,100);
    LAB.raw.lifestyleScore=score;
    LAB.scores.lifestyle=Math.round(LAB.avg([LAB.raw.sleepScore||60,score]));
    LAB.moduleIndex++; LAB.nextModule();
  };
};

console.log('[WellnessLab] Part 3 loaded â€” Modules 5â€“13 registered.');
</script>


</body>
</html>


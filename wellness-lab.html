<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap"></noscript>
<meta name="theme-color" content="#2A7A5A">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Wellness Intelligence Lab â€“ Shah Hayaat</title>
<meta name="description" content="21 fun, guided wellness activities. Check your brain, eyes, lungs and body. Free, private, voice-guided in English.">
<meta property="og:title" content="Wellness Intelligence Lab â€“ Shah Hayaat">
<meta property="og:image" content="https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/logo.jpg">
<meta name="twitter:card" content="summary_large_image">
<link rel="canonical" href="https://yasirhashmi02-dev.github.io/Shahhayaat02/wellness-lab.html">
<link rel="icon" href="https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/logo.jpg">


<style>
/* ============================================================
   WELLNESS LAB v2 â€” FULL LIGHT THEME
   Shah Hayaat Green (#2A7A5A) + Gold (#C97800) + White
   ============================================================ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;background:#F3F7F3;color:#1C2E1C;line-height:1.7;-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{color:inherit;text-decoration:none}
button,input,select{font-family:inherit}

/* â”€â”€ Design tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --g:  #2A7A5A;  --g2: #38A87A;  --g3: #E8F5EE;  --g4: #F0FAF4;
  --gl: #1A4731;
  --gd:  #C97800; --gd2:#F0A020;  --gd3:#FFF8ED;
  --bl:  #2563EB; --bl2:#EEF4FF;
  --rd:  #C0392B; --rd2:#FEECEB;
  --am:  #C97010; --am2:#FFF3E0;
  --ok:  #1A8C52;
  --bg:  #F3F7F3; --w:#FFFFFF; --card:#FFFFFF;
  --b:   #D4E8DC; --bh:#2A7A5A;
  --t:   #1C2E1C; --tm:#3A5A3A; --tq:#6A8A6A;
  --sh:  0 2px 8px rgba(42,120,90,.08);
  --shm: 0 8px 28px rgba(42,120,90,.13);
  --shl: 0 18px 50px rgba(42,120,90,.18);
  --r:14px; --rs:9px;
  --ease:cubic-bezier(.4,0,.2,1);
}

/* â”€â”€ Type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.h1{font-family:'Playfair Display',serif;font-size:clamp(1.9rem,5.5vw,3.4rem);font-weight:700;line-height:1.1;color:var(--t)}
.h2{font-family:'Playfair Display',serif;font-size:clamp(1.3rem,3.2vw,1.9rem);font-weight:700;line-height:1.2;color:var(--t)}
.h3{font-family:'Playfair Display',serif;font-size:clamp(1rem,2vw,1.25rem);font-weight:700;color:var(--t)}
.mono{font-family:'JetBrains Mono',monospace}
.pg{font-size:clamp(.88rem,1.6vw,.97rem);color:var(--tm);line-height:1.8}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wrap{max-width:860px;margin:0 auto;padding:0 1.2rem}
.wrap--w{max-width:1100px}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1.5px solid var(--b);border-radius:var(--r);padding:clamp(1.4rem,3.8vw,2.3rem);box-shadow:var(--sh)}
.card--pop{animation:popIn .36s var(--ease) both}
.card--g{border-color:rgba(42,122,90,.2);background:linear-gradient(135deg,var(--g4),#fff)}
.card--gd{border-color:rgba(201,120,0,.2);background:linear-gradient(135deg,var(--gd3),#fff)}
.card--bl{border-color:rgba(37,99,235,.18);background:linear-gradient(135deg,var(--bl2),#fff)}

/* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tag{display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .72rem;background:var(--g3);border:1px solid rgba(42,122,90,.25);border-radius:50px;font-size:.66rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--g)}
.tag--gd{background:var(--gd3);border-color:rgba(201,120,0,.28);color:var(--gd)}
.tag--bl{background:var(--bl2);border-color:rgba(37,99,235,.28);color:var(--bl)}
.tag--pk{background:#FFF0F5;border-color:rgba(180,60,110,.25);color:#A83060}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.42rem;font-weight:600;font-size:.88rem;padding:.75rem 1.8rem;border-radius:50px;border:2px solid transparent;transition:all .24s var(--ease);white-space:nowrap;-webkit-tap-highlight-color:transparent;cursor:pointer}
.btn--p{background:linear-gradient(135deg,var(--g),var(--g2));color:#fff;box-shadow:0 4px 16px rgba(42,122,90,.28)}
.btn--p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(42,122,90,.4)}
.btn--g{background:#fff;border-color:var(--b);color:var(--tm)}
.btn--g:hover{border-color:var(--g);color:var(--t)}
.btn--gd{background:linear-gradient(135deg,var(--gd),var(--gd2));color:#fff;box-shadow:0 4px 16px rgba(201,120,0,.25)}
.btn--gd:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(201,120,0,.38)}
.btn--skip{background:#fff;border-color:#DDD0C4;color:#9A887A;font-size:.75rem;padding:.4rem .95rem}
.btn--skip:hover{border-color:var(--am);color:var(--am)}
.btn--lg{padding:.92rem 2.3rem;font-size:.96rem}
.btn--sm{padding:.38rem .95rem;font-size:.76rem}
.btn--full{width:100%}
.btn:disabled{opacity:.32;pointer-events:none}
.btn-row{display:flex;flex-wrap:wrap;gap:.7rem;align-items:center;margin-top:1.5rem}

/* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#progBar{background:var(--w);border-bottom:1.5px solid var(--b);padding:.65rem 0;position:sticky;top:64px;z-index:800;box-shadow:var(--sh);display:none}
.prog-row{display:flex;align-items:center;gap:.8rem}
.prog-track{flex:1;height:6px;background:var(--g3);border-radius:3px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--g),var(--g2));border-radius:3px;transition:width .7s var(--ease)}
.prog-meta{display:flex;justify-content:space-between;font-size:.63rem;color:var(--tq);margin-top:.28rem;font-family:'JetBrains Mono',monospace}

/* â”€â”€ Notices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notice{display:flex;align-items:flex-start;gap:.75rem;padding:.88rem 1.05rem;background:var(--g4);border:1px solid rgba(42,122,90,.16);border-radius:var(--rs);font-size:.83rem;line-height:1.68}
.notice--am{background:var(--am2);border-color:rgba(201,112,16,.2)}
.notice--rd{background:var(--rd2);border-color:rgba(192,57,43,.18)}
.ni{font-size:1.05rem;flex-shrink:0;margin-top:.08rem}
.notice p{color:var(--tm);margin:0}
.notice strong{color:var(--t)}

/* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fld{margin-bottom:1.05rem}
.lbl{display:block;font-size:.68rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--tq);margin-bottom:.38rem}
.inp,.sel{width:100%;padding:.7rem .9rem;background:#fff;border:1.5px solid var(--b);border-radius:var(--rs);color:var(--t);font-size:.94rem;outline:none;transition:border-color .22s;-webkit-appearance:none}
.inp:focus,.sel:focus{border-color:var(--g);box-shadow:0 0 0 3px rgba(42,122,90,.1)}
.g2c{display:grid;grid-template-columns:1fr 1fr;gap:.85rem}
@media(max-width:480px){.g2c{grid-template-columns:1fr}}
.rng{-webkit-appearance:none;width:100%;height:5px;background:var(--g3);border-radius:3px;outline:none;border:1px solid var(--b)}
.rng::-webkit-slider-thumb{-webkit-appearance:none;width:21px;height:21px;background:linear-gradient(135deg,var(--g),var(--g2));border-radius:50%;box-shadow:0 2px 7px rgba(42,122,90,.3)}
.rng-l{display:flex;justify-content:space-between;font-size:.64rem;color:var(--tq);margin-top:.28rem}

/* â”€â”€ Score badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sc-row{display:flex;flex-wrap:wrap;gap:.6rem;margin:1rem 0}
.scb{background:var(--bg);border:1.5px solid var(--b);border-radius:var(--rs);padding:.58rem .9rem;min-width:80px}
.scb .v{font-family:'JetBrains Mono',monospace;font-size:1.02rem;font-weight:600;color:var(--g);display:block;line-height:1}
.scb .l{font-size:.58rem;color:var(--tq);text-transform:uppercase;letter-spacing:.09em;margin-top:.15rem;display:block}

/* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.div{width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--b),transparent);margin:1.3rem 0}

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes popIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:none}}
@keyframes fadeUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:none}}
@keyframes bounceIn{0%{opacity:0;transform:scale(.68)}60%{transform:scale(1.07)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(42,122,90,.4)}70%{box-shadow:0 0 0 10px transparent}}
@keyframes wiggle{0%,100%{transform:rotate(0)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
@keyframes confettiFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}
@keyframes voicePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes demoDemo{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
@keyframes slideIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:none}}
.au{animation:fadeUp .4s var(--ease) both}
.au.d1{animation-delay:.07s}.au.d2{animation-delay:.14s}.au.d3{animation-delay:.22s}.au.d4{animation-delay:.3s}

/* â”€â”€ Reaction zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rz{width:100%;border-radius:var(--r);height:175px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.4rem;cursor:pointer;user-select:none;border:2.5px solid var(--b);transition:all .14s;background:#fff;position:relative;overflow:hidden;-webkit-tap-highlight-color:transparent}
.rz-l{font-size:clamp(.9rem,2.8vw,1.25rem);font-weight:700;color:var(--tq);transition:color .14s}
.rz-s{font-size:.66rem;color:var(--tq)}
.rz.rz-wait{background:#FAFBF8}
.rz.rz-go{background:var(--g4);border-color:var(--g);animation:pulse 1.2s infinite}
.rz.rz-go .rz-l{color:var(--g)}
.rz.rz-early{background:var(--am2);border-color:var(--am)}
.rz.rz-early .rz-l{color:var(--am)}
.rz.rz-done{background:var(--g3);border-color:var(--g2);cursor:default}
.rz.rz-done .rz-l{color:var(--t)}
.rxh{display:flex;align-items:flex-end;gap:4px;height:40px;margin:.6rem 0;padding:0 .2rem}
.rxb{flex:1;border-radius:3px 3px 0 0;min-height:3px;transition:height .4s var(--ease)}

/* â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timer{font-family:'JetBrains Mono',monospace;font-size:clamp(2.2rem,6.5vw,3.6rem);font-weight:600;line-height:1;text-align:center;color:var(--g);display:block;margin:.7rem 0;transition:color .3s}
.timer.warn{color:var(--am)}
.timer.crit{color:var(--rd);animation:wiggle .5s ease-in-out infinite}

/* â”€â”€ Memory grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:min(270px,78vw);margin:0 auto}
.mcell{aspect-ratio:1;background:#fff;border:2px solid var(--b);border-radius:9px;transition:all .18s;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;-webkit-tap-highlight-color:transparent}
.mcell.lit{background:var(--g2);border-color:var(--g);transform:scale(1.06)}
.mcell.sel{background:#DBEAFE;border-color:#3B82F6}
.mcell.ok{background:var(--g3);border-color:var(--ok)}
.mcell.bad{background:var(--rd2);border-color:var(--rd)}

/* â”€â”€ Ishihara-style plates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ish-wrap{text-align:center;margin:1rem 0}
.ish-wrap svg{border-radius:50%;border:3px solid var(--b);box-shadow:var(--sh)}

/* â”€â”€ Acuity rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ac-row{display:flex;align-items:center;justify-content:center;padding:.7rem;background:#fff;border:2px solid var(--b);border-radius:var(--rs);margin:.45rem 0;cursor:pointer;transition:all .2s;font-weight:700;letter-spacing:.1em;color:var(--t);font-family:'JetBrains Mono',monospace}
.ac-row:hover{border-color:var(--g);background:var(--g4)}
.ac-row.seen{background:var(--g3);border-color:var(--ok)}
.ac-row.unseen{background:var(--rd2);border-color:var(--rd)}

/* â”€â”€ DISCLAIMER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dis{position:fixed;top:0;left:0;right:0;z-index:9999;background:var(--gl);color:#fff;height:44px}
.dis-sl{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:clamp(.56rem,1.35vw,.72rem);font-weight:600;letter-spacing:.06em;text-transform:uppercase;text-align:center;padding:0 1rem;opacity:0;transform:translateY(4px);transition:all .55s}
.dis-sl.on{opacity:1;transform:none}
.dis-dots{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);display:flex;gap:4px}
.dis-d{width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.28);transition:.3s}
.dis-d.on{background:#fff;transform:scale(1.4)}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hdr{position:sticky;top:44px;z-index:900;background:rgba(255,255,255,.96);backdrop-filter:blur(14px);border-bottom:1.5px solid var(--b);padding:.62rem 0;box-shadow:var(--sh)}
.hdr-in{max-width:1100px;margin:0 auto;padding:0 1.2rem;display:flex;align-items:center;justify-content:space-between;gap:.8rem}
.logo{display:flex;align-items:center;gap:.65rem}
.logo img{width:35px;height:35px;border-radius:50%;border:2px solid var(--g3);object-fit:cover}
.logo-n{font-family:'Playfair Display',serif;font-size:.98rem;font-weight:700;color:var(--t);line-height:1.1}
.logo-s{font-size:.52rem;letter-spacing:.12em;text-transform:uppercase;color:var(--g);font-weight:700}
.hdr-stat{display:flex;align-items:center;gap:.38rem;font-size:.64rem;color:var(--tq);font-family:'JetBrains Mono',monospace}
.hstat{width:7px;height:7px;border-radius:50%;background:var(--g2);transition:.3s}
.hstat.idle{background:#C9A84C}
.nav-back{font-size:.78rem;font-weight:500;color:var(--tq);background:#fff;border:1.5px solid var(--b);border-radius:50px;padding:.36rem .88rem;transition:.22s;display:inline-flex;align-items:center;gap:.3rem}
.nav-back:hover{border-color:var(--g);color:var(--t)}

/* â”€â”€ VOICE BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#vbar{position:fixed;bottom:1.3rem;right:1.3rem;z-index:9000;display:flex;flex-direction:column;align-items:flex-end;gap:.45rem}
.vlbl{font-size:.6rem;color:var(--tq);font-family:'JetBrains Mono',monospace;padding:.15rem .5rem;background:rgba(255,255,255,.9);border-radius:50px;border:1px solid var(--b)}
.vlang-row{display:flex;gap:.35rem}
.vlang{padding:.28rem .7rem;background:#fff;border:2px solid var(--b);border-radius:50px;font-size:.72rem;font-weight:700;transition:.22s;box-shadow:var(--sh);line-height:1.4}
.vlang:hover,.vlang.on{border-color:var(--g);color:var(--g);background:var(--g3)}
.vtog{width:46px;height:46px;border-radius:50%;background:#fff;border:2px solid var(--b);box-shadow:var(--shm);display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:.22s}
.vtog:hover{border-color:var(--g);transform:scale(1.06)}
.vtog.speaking{border-color:var(--g);background:var(--g3);animation:voicePulse .8s ease-in-out infinite}

/* â”€â”€ DEMO OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#demo-ov{position:fixed;inset:0;z-index:8500;background:rgba(26,47,26,.58);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;padding:1rem}
#demo-ov.show{display:flex}
.demo-box{background:#fff;border-radius:var(--r);max-width:450px;width:100%;box-shadow:var(--shl);animation:bounceIn .38s var(--ease) both;overflow:hidden}
.demo-hdr{padding:1.05rem 1.35rem .7rem;border-bottom:1.5px solid var(--b);display:flex;align-items:center;justify-content:space-between}
.demo-hdr h3{font-family:'Playfair Display',serif;font-size:1.02rem;color:var(--t)}
.demo-badge{background:var(--g3);color:var(--g);font-size:.6rem;font-weight:700;padding:.18rem .58rem;border-radius:50px;text-transform:uppercase;letter-spacing:.08em}
.demo-body{padding:1.05rem 1.35rem}
.demo-txt{font-size:.86rem;color:var(--tm);line-height:1.72;margin-bottom:.85rem}
.demo-txt strong{color:var(--t)}
.demo-vis{height:120px;background:linear-gradient(145deg,#EBF5F0,#E0F0E8);border:1.5px solid rgba(42,122,90,.22);border-radius:var(--rs);display:flex;align-items:center;justify-content:center;font-size:1.6rem;margin-bottom:.8rem;overflow:hidden;position:relative;perspective:500px}
@keyframes float3d{0%,100%{transform:translateY(0) rotateX(0) rotateY(0)}33%{transform:translateY(-7px) rotateX(5deg) rotateY(-5deg)}66%{transform:translateY(4px) rotateX(-3deg) rotateY(4deg)}}
@keyframes pulse3d{0%,100%{transform:scale(1) rotateX(0);box-shadow:0 4px 14px rgba(42,120,90,.15)}50%{transform:scale(1.08) rotateX(8deg);box-shadow:0 14px 32px rgba(42,120,90,.28)}}
@keyframes spin3d{0%{transform:rotateY(0) rotateX(10deg)}100%{transform:rotateY(360deg) rotateX(10deg)}}
@keyframes breathCircle{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(42,120,90,.3),0 6px 20px rgba(42,120,90,.12)}50%{transform:scale(1.2);box-shadow:0 0 0 14px rgba(42,120,90,.0),0 12px 36px rgba(42,120,90,.22)}}
@keyframes waveBar{0%,100%{transform:scaleY(1) translateZ(0)}50%{transform:scaleY(1.8) translateZ(8px)}}
@keyframes cardFlip{0%{transform:perspective(400px) rotateY(0)}50%{transform:perspective(400px) rotateY(90deg)}100%{transform:perspective(400px) rotateY(0)}}
@keyframes orbFloat{0%{transform:translate(0,0) scale(1)}25%{transform:translate(6px,-8px) scale(1.05)}50%{transform:translate(-4px,-12px) scale(1.1)}75%{transform:translate(-8px,-4px) scale(1.04)}100%{transform:translate(0,0) scale(1)}}
.d3f{animation:float3d 2.8s ease-in-out infinite;transform-style:preserve-3d}
.d3p{animation:pulse3d 1.3s ease-in-out infinite;transform-style:preserve-3d}
.d3s{animation:spin3d 3s linear infinite;transform-style:preserve-3d}
.d3b{animation:breathCircle 3.5s ease-in-out infinite}
.demo-hint{font-size:.73rem;color:var(--tq);text-align:center;min-height:1.1em}
.demo-ftr{padding:.7rem 1.35rem 1.05rem;display:flex;gap:.6rem;justify-content:flex-end}

/* â”€â”€ WELCOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sWelcome{position:relative;overflow:hidden}
.hero{padding:clamp(2.2rem,7vw,5rem) 0 clamp(1.2rem,3.5vw,2.5rem);position:relative}
.hero::before{content:'';position:absolute;top:-60px;right:-100px;width:420px;height:420px;background:radial-gradient(circle,rgba(42,122,90,.06) 0%,transparent 65%);border-radius:50%;pointer-events:none}
.hero-ey{display:flex;flex-wrap:wrap;gap:.45rem;margin-bottom:1.3rem}
.hero-desc{max-width:520px;margin-bottom:1.9rem}
.hbadge-row{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:1.7rem}
.hbadge{display:inline-flex;align-items:center;gap:.25rem;padding:.24rem .74rem;background:#fff;border:1.5px solid var(--b);border-radius:50px;font-size:.68rem;font-weight:500;color:var(--tm)}
.stats-row{display:flex;flex-wrap:wrap;gap:.7rem;padding:1.4rem 0;border-top:1px solid var(--b)}
.stat-box{flex:1;min-width:78px;background:#fff;border:1.5px solid var(--b);border-radius:var(--rs);padding:.85rem .65rem;text-align:center}
.stat-n{font-family:'Playfair Display',serif;font-size:1.65rem;font-weight:700;color:var(--t);display:block;line-height:1}
.stat-l{font-size:.56rem;color:var(--tq);text-transform:uppercase;letter-spacing:.09em;margin-top:.18rem;display:block}
.pill-row{display:flex;flex-wrap:wrap;gap:.35rem;padding:1.3rem 0;border-top:1px solid var(--b)}
.pill{display:inline-flex;align-items:center;gap:.22rem;padding:.22rem .68rem;background:#fff;border:1.5px solid var(--b);border-radius:50px;font-size:.66rem;color:var(--tq);transition:.2s}
.pill.eye{border-color:rgba(37,99,235,.25);color:var(--bl);background:var(--bl2)}
.pill.fem{border-color:rgba(168,48,96,.22);color:#A83060;background:#FFF0F5}

/* â”€â”€ INSTRUCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.instr-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:1.4rem}
@media(max-width:590px){.instr-grid{grid-template-columns:1fr}}
.iitem{display:flex;align-items:flex-start;gap:.75rem;padding:.9rem 1rem;background:var(--bg);border:1.5px solid var(--b);border-radius:var(--rs);transition:border-color .22s}
.iitem:hover{border-color:var(--g)}
.iico{width:33px;height:33px;border-radius:50%;background:var(--g3);border:1px solid rgba(42,122,90,.2);display:flex;align-items:center;justify-content:center;font-size:.98rem;flex-shrink:0}
.ibody strong{display:block;font-size:.83rem;font-weight:700;color:var(--t);margin-bottom:.13rem}
.ibody p{font-size:.74rem;color:var(--tq);line-height:1.55;margin:0}

/* â”€â”€ GENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gend-grid{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;max-width:370px}
@media(max-width:420px){.gend-grid{grid-template-columns:1fr}}
.gcard{background:#fff;border:2.5px solid var(--b);border-radius:var(--r);padding:1.6rem 1.2rem;text-align:center;transition:all .24s var(--ease);position:relative;cursor:pointer}
.gcard:hover{border-color:rgba(42,122,90,.35);transform:translateY(-3px);box-shadow:var(--shm)}
.gcard.sel{border-color:var(--g);box-shadow:0 0 0 4px rgba(42,122,90,.1),var(--shm)}
.gck{position:absolute;top:.62rem;right:.62rem;width:19px;height:19px;border-radius:50%;background:var(--g);display:none;align-items:center;justify-content:center;font-size:.6rem;color:#fff;font-weight:700}
.gcard.sel .gck{display:flex}
.gico{font-size:2.4rem;display:block;margin-bottom:.62rem}
.gnm{font-family:'Playfair Display',serif;font-size:.97rem;font-weight:700;color:var(--t);margin-bottom:.16rem}
.gnt{font-size:.61rem;color:var(--tq);text-transform:uppercase;letter-spacing:.08em}
.gcard.sel .gnm{color:var(--g)}
.fem-note{display:none;margin-top:1rem;padding:.82rem 1rem;background:var(--gd3);border:1px solid rgba(201,120,0,.2);border-radius:var(--rs);font-size:.79rem;color:var(--gd);line-height:1.62}
.fem-note.show{display:block}

/* â”€â”€ MODULE area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sModules{display:none;content-visibility:auto}
#sModules.show{display:block}
.mwrap{animation:popIn .36s var(--ease) both}

/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lab-footer{border-top:1.5px solid var(--b);padding:1rem 0;text-align:center;margin-top:3rem}
.lab-footer p{font-size:.65rem;color:var(--tq);line-height:1.7}
.lab-footer a{color:var(--g)}

/* â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:focus-visible{outline:2.5px solid var(--g);outline-offset:3px;border-radius:4px}
.sr{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
.step-head{margin-bottom:1.4rem}
.step-head .tag{margin-bottom:.75rem}
</style>
</head>
<body>

<!-- â•â• Disclaimer bar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dis" role="banner" aria-label="Important disclaimer">
  <div class="dis-sl on" id="ds0">âš  Wellness indicators only â€” not a medical diagnosis</div>
  <div class="dis-sl"    id="ds1">ğŸ” Zero data stored â€” everything runs on your device only</div>
  <div class="dis-sl"    id="ds2">ğŸ©º See a doctor for health concerns </div>
  <div class="dis-dots"><div class="dis-d on" id="dd0"></div><div class="dis-d" id="dd1"></div><div class="dis-d" id="dd2"></div></div>
</div>
<div style="height:44px"></div>

<!-- â•â• Header â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header id="hdr" role="banner">
  <div class="hdr-in">
    <a href="index.html" class="logo" aria-label="Shah Hayaat home">
      <img src="https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/logo.jpg" alt="Shah Hayaat logo" loading="eager" fetchpriority="high" width="38" height="38">
      <div><div class="logo-n">Shah Hayaat</div><div class="logo-s">Wellness Lab</div></div>
    </a>
    <div class="hdr-stat"><div class="hstat idle" id="hsDot" aria-hidden="true"></div><span id="hsText">Ready</span></div>
    <a href="index.html" class="nav-back">â† Back to Site</a>
  </div>
</header>

<!-- â•â• Progress bar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="progBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
  <div class="wrap">
    <div class="prog-row">
      <span class="mono" style="font-size:.62rem;color:var(--tq);white-space:nowrap" id="pStep">â€”</span>
      <div class="prog-track"><div class="prog-fill" id="pFill" style="width:0%"></div></div>
      <button class="btn btn--skip" onclick="LAB.skip()" id="skipBtn" aria-label="Skip this activity">Skip â­</button>
    </div>
    <div class="prog-meta"><span id="pLbl">â€”</span><span id="pPct">0%</span></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: WELCOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="sWelcome" role="main">
  <div class="wrap">
    <div class="hero">
      <div class="hero-ey au">
        <div class="tag">ğŸ§ª 21 Wellness Activities</div>
        <div class="tag tag--gd">âœ¨ Free Â· Private Â· Voice-Guided</div>
        <div class="tag tag--bl">ğŸ‘ Includes Eye Tests</div>
      </div>

      <h1 class="h1 au d1" style="margin-bottom:.95rem">
        Your Personal<br><span style="color:var(--g)">Wellness Lab</span>
      </h1>

      <p class="pg hero-desc au d2">
        21 short, fun activities that check how your brain, eyes, lungs and body are really performing today. Voice guidance in <strong>English</strong>. Every activity has a demo first. All data stays on your phone.
      </p>

      <div class="hbadge-row au d2">
        <div class="hbadge">ğŸ” Zero data stored</div>
        <div class="hbadge">ğŸ—£ Voice-Guided English</div>
        <div class="hbadge">ğŸ¬ Demo before every test</div>
        <div class="hbadge">â­ Skip anytime</div>
        <div class="hbadge">ğŸ“„ Free PDF report</div>
        <div class="hbadge">ğŸ‘ Colour blindness test included</div>
      </div>

      <div class="btn-row au d3" style="margin-top:0">
        <button class="btn btn--p btn--lg" onclick="LAB.goInstr()">Start My Wellness Check â†’</button>
        <a href="#allact" class="btn btn--g">See All Activities</a>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row" role="list">
      <div class="stat-box" role="listitem"><span class="stat-n">21</span><span class="stat-l">Activities</span></div>
      <div class="stat-box" role="listitem"><span class="stat-n">6</span><span class="stat-l">Health Scores</span></div>
      <div class="stat-box" role="listitem"><span class="stat-n">~18</span><span class="stat-l">Minutes</span></div>
      <div class="stat-box" role="listitem"><span class="stat-n">0</span><span class="stat-l">Data Stored</span></div>
      <div class="stat-box" role="listitem"><span class="stat-n">Free</span><span class="stat-l">Always</span></div>
    </div>

    <!-- Pill list -->
    <div class="pill-row" id="allact" role="list" aria-label="All activities">
      <span style="font-size:.63rem;font-weight:700;color:var(--tq);text-transform:uppercase;letter-spacing:.09em;align-self:center;margin-right:.3rem">All activities:</span>
      <span class="pill" role="listitem">âš¡ Reaction Speed</span>
      <span class="pill" role="listitem">ğŸ“‰ Fatigue Test</span>
      <span class="pill" role="listitem">ğŸ§© Memory Matrix</span>
      <span class="pill" role="listitem">ğŸ‘ Attention Test</span>
      <span class="pill eye" role="listitem">ğŸ¨ Colour Blindness</span>
      <span class="pill eye" role="listitem">ğŸ“ Visual Acuity</span>
      <span class="pill eye" role="listitem">â¬œ Contrast Sensitivity</span>
      <span class="pill" role="listitem">ğŸŒ¬ Breath Sync</span>
      <span class="pill" role="listitem">â± Breath Hold</span>
      <span class="pill" role="listitem">â™» Recovery Test</span>
      <span class="pill" role="listitem">ğŸ”¥ Maths Under Pressure</span>
      <span class="pill" role="listitem">ğŸ”· Pattern Search</span>
      <span class="pill" role="listitem">ğŸ“± Steady Hand</span>
      <span class="pill" role="listitem">âœ Tremor Drawing</span>
      <span class="pill" role="listitem">ğŸ’¤ Sleep Check</span>
      <span class="pill" role="listitem">âš– Lifestyle Score</span>
      <span class="pill fem" role="listitem">ğŸŒ¸ Hormonal Rhythm</span>
      <span class="pill fem" role="listitem">âš¡ Energy &amp; Iron</span>
      <span class="pill fem" role="listitem">ğŸŒ™ Female Sleep &amp; Comfort</span>
      <span style="font-size:.61rem;color:var(--tq);align-self:center;padding-left:.3rem">ğŸŒ¸ = Female only &nbsp;Â·&nbsp; ğŸ‘ = Eye tests</span>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: INSTRUCTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="sInstr" style="display:none;padding:clamp(1.8rem,5vw,3.5rem) 0">
  <div class="wrap">
    <div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ“‹ Before You Start</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.45rem">How It Works</h2>
        <p class="pg">Quick read â€” takes 30 seconds. Makes everything easier.</p>
      </div>

      <div class="instr-grid">
        <div class="iitem au d1">
          <div class="iico">ğŸ¬</div>
          <div class="ibody"><strong>Watch Demo First</strong><p>Every activity shows a short animation before you start. You see exactly what to do â€” no guessing.</p></div>
        </div>
        <div class="iitem au d1">
          <div class="iico">ğŸ—£</div>
          <div class="ibody"><strong>Voice Guidance</strong><p>Tap the ğŸ”Š button (bottom right) to turn on English voice guidance â€” spoken instructions before each activity.</p></div>
        </div>
        <div class="iitem au d2">
          <div class="iico">â­</div>
          <div class="ibody"><strong>Skip Anytime</strong><p>Don't feel like doing an activity? Press Skip. Your other scores are not affected at all.</p></div>
        </div>
        <div class="iitem au d2">
          <div class="iico">ğŸ‘</div>
          <div class="ibody"><strong>Eye Tests Included</strong><p>3 new activities check colour blindness, how sharp your vision is, and contrast sensitivity.</p></div>
        </div>
        <div class="iitem au d3">
          <div class="iico">ğŸ“±</div>
          <div class="ibody"><strong>Phone or Laptop</strong><p>Most tests work anywhere. The Steady Hand test uses your phone's motion sensor for best results.</p></div>
        </div>
        <div class="iitem au d3">
          <div class="iico">ğŸ“„</div>
          <div class="ibody"><strong>Free PDF at the End</strong><p>Download a clean, readable report with your scores, personalised tips and wellness suggestions.</p></div>
        </div>
      </div>

      <div class="notice">
        <div class="ni">âš•ï¸</div>
        <p><strong>Important:</strong> This is a wellness check, not a medical test. It cannot diagnose diseases. <strong>All data stays on your device â€” nothing is sent anywhere.</strong> See a doctor for health concerns.</p>
      </div>

      <div class="btn-row">
        <button class="btn btn--p btn--lg" onclick="LAB.goGender()">I Understand â€” Continue â†’</button>
        <button class="btn btn--g" onclick="LAB.goWelcome()">â† Back</button>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: GENDER SELECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="sGender" style="display:none;padding:clamp(1.8rem,5vw,3.5rem) 0">
  <div class="wrap">
    <div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ‘¤ Quick Setup</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.45rem">Select Your Biological Sex</h2>
        <p class="pg">Shows you the right activities. Never stored or shared.</p>
      </div>

      <div class="gend-grid" role="group" aria-label="Select biological sex">
        <div class="gcard" id="gM" role="radio" aria-checked="false" tabindex="0"
             onclick="LAB.setGender('male')" onkeydown="if(event.key==='Enter'||event.key===' ')LAB.setGender('male')">
          <div class="gck" aria-hidden="true">âœ“</div>
          <span class="gico">â™‚</span>
          <div class="gnm">Male</div>
          <div class="gnt">16 activities</div>
        </div>
        <div class="gcard" id="gF" role="radio" aria-checked="false" tabindex="0"
             onclick="LAB.setGender('female')" onkeydown="if(event.key==='Enter'||event.key===' ')LAB.setGender('female')">
          <div class="gck" aria-hidden="true">âœ“</div>
          <span class="gico">â™€</span>
          <div class="gnm">Female</div>
          <div class="gnt">16 + 3 female activities</div>
        </div>
      </div>

      <div class="fem-note" id="femNote">
        ğŸŒ¸ <strong>3 focused female activities:</strong> Hormonal Rhythm Check, Energy &amp; Iron, and Combined Sleep &amp; Comfort â€” short, clear, and specific to you.
      </div>

      <div class="btn-row">
        <button class="btn btn--p btn--lg" id="goCont" disabled onclick="LAB.beginModules()">Start Assessment â†’</button>
        <button class="btn btn--g" onclick="LAB.goInstr()">â† Back</button>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SECTION: MODULES (injected dynamically)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="sModules">
  <div class="wrap" style="padding-top:1.5rem;padding-bottom:3rem">
    <div id="modContent" aria-live="polite" aria-atomic="false"></div>
  </div>
</div>

<!-- â•â• Demo Overlay â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="demo-ov" role="dialog" aria-modal="true" aria-label="Activity demo">
  <div class="demo-box">
    <div class="demo-hdr">
      <h3 id="demoTitle">Demo</h3>
      <span class="demo-badge">Watch first!</span>
    </div>
    <div class="demo-body">
      <p class="demo-txt" id="demoTxt">Loadingâ€¦</p>
      <div class="demo-vis" id="demoVis" aria-hidden="true"></div>
      <div class="demo-hint" id="demoHint"></div>
    </div>
    <div class="demo-ftr">
      <button class="btn btn--g btn--sm" onclick="LAB.closeDemo(true)">Skip Demo</button>
      <button class="btn btn--p btn--sm" id="demoStart" onclick="LAB.closeDemo(false)">Got it â€” Start! â†’</button>
    </div>
  </div>
</div>

<!-- â•â• Voice Controls â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="vbar" aria-label="Voice guide controls">
  <div class="vlang-row">
    <div class="vlbl" id="vlbl">Voice OFF</div>
    <button class="vtog" id="vtog" onclick="LAB.toggleVoice()" aria-label="Toggle voice guidance" title="Toggle voice">ğŸ”‡</button>
  </div>
</div>

<!-- â•â• Footer â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="lab-footer" role="contentinfo">
  <div class="wrap">
    <p>Shah Hayaat Wellness Lab &nbsp;Â·&nbsp; All data stays on your device &nbsp;Â·&nbsp;
       <a href="disclaimer.html">Disclaimer</a> &nbsp;Â·&nbsp;
       <a href="privacy.html">Privacy</a> &nbsp;Â·&nbsp;
       <a href="index.html">â† Shah Hayaat</a></p>
  </div>
</footer>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PART 1 JAVASCRIPT â€” Engine, Voice, Demo, Nav
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LAB â€” Global state object
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LAB = {

  /* â”€â”€ State â”€â”€ */
  gender: '',
  lang: 'en',
  voiceOn: false,
  idx: 0,
  queue: [],
  scores: { cognitive:null, eye:null, respiratory:null, stress:null, stability:null, lifestyle:null, hormonal:null },
  raw: {},
  _demoCB: null,
  _demoAnim: null,

  /* â”€â”€ DOM shorthand â”€â”€ */
  el: id => document.getElementById(id),
  qs: sel => document.querySelector(sel),

  /* â”€â”€ Math helpers â”€â”€ */
  avg(a){ return a.length ? a.reduce((s,v)=>s+v,0)/a.length : 0; },
  clamp(v,a,b){ return Math.max(a,Math.min(b,v)); },
  sd(a){ const m=this.avg(a); return Math.sqrt(this.avg(a.map(x=>(x-m)**2))); },
  scoreCol(s){ return s>=80?'#1A8C52':s>=55?'#C97010':'#C0392B'; },
  scoreLbl(s){ return s>=80?'Excellent':s>=65?'Good':s>=50?'Fair':s>=35?'Needs Attention':'Low'; },

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NAVIGATION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  _secs: ['sWelcome','sInstr','sGender','sModules'],

  show(id) {
    this._secs.forEach(s => {
      const e = this.el(s);
      if (!e) return;
      if (s === 'sModules') { e.style.display = s===id ? 'block' : 'none'; }
      else { e.style.display = s===id ? '' : 'none'; }
    });
    this.el('progBar').style.display = id==='sModules' ? 'block' : 'none';
    window.scrollTo({top:0, behavior:'smooth'});
  },

  goWelcome() {
    this.show('sWelcome');
    this.setStatus('idle','Ready');
    this.say(
      'Welcome to Shah Hayaat Wellness Lab. Press Start My Wellness Check to begin.',
      'Ø´Ø§Û Ø­ÛŒØ§Øª ÙˆÛŒÙ„Ù†Ø³ Ù„ÛŒØ¨ Ù…ÛŒÚº Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯Û”',
      'à¤¶à¤¾à¤¹ à¤¹à¤¯à¤¾à¤¤ à¤µà¥‡à¤²à¤¨à¥‡à¤¸ à¤²à¥ˆà¤¬ à¤®à¥‡à¤‚ à¤†à¤ªà¤•à¤¾ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆà¥¤'
    );
  },

  goInstr() {
    this.show('sInstr');
    this.setStatus('idle','Setup');
    this.say(
      'Here is how the lab works. Each activity starts with a short demo. You can skip any activity.',
      'Ù„ÛŒØ¨ Ú©Ø³ Ø·Ø±Ø­ Ú©Ø§Ù… Ú©Ø±ØªÛŒ ÛÛ’Û” ÛØ± Ø³Ø±Ú¯Ø±Ù…ÛŒ Ø§ÛŒÚ© ÚˆÛŒÙ…Ùˆ Ø³Û’ Ø´Ø±ÙˆØ¹ ÛÙˆØªÛŒ ÛÛ’Û”',
      'à¤²à¥ˆà¤¬ à¤•à¥ˆà¤¸à¥‡ à¤•à¤¾à¤® à¤•à¤°à¤¤à¥€ à¤¹à¥ˆà¥¤ à¤¹à¤° à¤—à¤¤à¤¿à¤µà¤¿à¤§à¤¿ à¤à¤• à¤¡à¥‡à¤®à¥‹ à¤¸à¥‡ à¤¶à¥à¤°à¥‚ à¤¹à¥‹à¤¤à¥€ à¤¹à¥ˆà¥¤'
    );
  },

  goGender() {
    this.show('sGender');
    this.setStatus('idle','Setup');
    this.say(
      'Please select your biological sex to activate the right activities.',
      'Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ù¾Ù†ÛŒ Ø¬Ù†Ø³ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚºÛ”',
      'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¤¾ à¤œà¥ˆà¤µà¤¿à¤• à¤²à¤¿à¤‚à¤— à¤šà¥à¤¨à¥‡à¤‚à¥¤'
    );
  },

  setGender(g) {
    this.gender = g;
    ['M','F'].forEach(x => {
      const c = this.el('g'+x);
      if (!c) return;
      const match = (x==='M' && g==='male') || (x==='F' && g==='female');
      c.classList.toggle('sel', match);
      c.setAttribute('aria-checked', String(match));
    });
    const fn = this.el('femNote');
    if (fn) fn.classList.toggle('show', g==='female');
    const gc = this.el('goCont');
    if (gc) gc.disabled = false;
    this.say(
      g==='female' ? 'Female selected. 19 activities including 3 female-specific ones.' : 'Male selected. 16 activities.',
      g==='female' ? 'Ø®Ø§ØªÙˆÙ† Ù…Ù†ØªØ®Ø¨ Ú©ÛŒ Ú¯Ø¦ÛŒÛ”' : 'Ù…Ø±Ø¯ Ù…Ù†ØªØ®Ø¨ Ú©ÛŒØ§ Ú¯ÛŒØ§Û”',
      g==='female' ? 'à¤®à¤¹à¤¿à¤²à¤¾ à¤šà¥à¤¨à¤¾ à¤—à¤¯à¤¾à¥¤' : 'à¤ªà¥à¤°à¥à¤· à¤šà¥à¤¨à¤¾ à¤—à¤¯à¤¾à¥¤'
    );
  },

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODULE QUEUE & RUNNER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  beginModules() {
    if (!this.gender) return;
    this.queue = [
      'mod_reactionSpeed',
      'mod_reactionFatigue',
      'mod_workingMemory',
      'mod_sustainedAttention',
      'mod_colourBlindness',
      'mod_visualAcuity',
      'mod_contrastSensitivity',
      'mod_breathSync',
      'mod_co2Tolerance',
      'mod_recovery',
      'mod_cogUnderPressure',
      'mod_patternOverload',
      'mod_stabilityHold',
      'mod_microTremor',
      'mod_sleepEfficiency',
      'mod_lifestyleLoad',
    ];
    if (this.gender === 'female') {
      this.queue.push('mod_hormonalRhythm','mod_energyIron','mod_femCombined');
    }
    this.idx = 0;
    this.show('sModules');
    this.next();
  },

  next() {
    if (this.idx >= this.queue.length) {
      if (typeof LAB.showDashboard === 'function') LAB.showDashboard();
      else this._tempDone();
      return;
    }
    this._updateProg();
    const fn = window[this.queue[this.idx]];
    if (typeof fn === 'function') fn();
    else this._stub(this.queue[this.idx]);
  },

  skip() {
    // Stop any running demo animation
    if (this._demoAnim) { clearInterval(this._demoAnim); clearTimeout(this._demoAnim); this._demoAnim = null; }
    // Close demo if open
    const ov = this.el('demo-ov');
    if (ov && ov.classList.contains('show')) { ov.classList.remove('show'); document.body.style.overflow=''; }
    this.say('Activity skipped.', 'Ø³Ø±Ú¯Ø±Ù…ÛŒ Ú†Ú¾ÙˆÚ‘ Ø¯ÛŒ Ú¯Ø¦ÛŒÛ”', 'à¤—à¤¤à¤¿à¤µà¤¿à¤§à¤¿ à¤›à¥‹à¤¡à¤¼ à¤¦à¥€à¥¤');
    this.idx++;
    this.next();
  },

  _tempDone() {
    this.render(`<div class="mwrap"><div class="card" style="text-align:center;padding:3rem 2rem">
      <div style="font-size:3rem;margin-bottom:1rem">âœ…</div>
      <h2 class="h2" style="margin-bottom:.75rem">All activities done!</h2>
      <p class="pg" style="max-width:340px;margin:0 auto 2rem">Your dashboard will appear after all parts are loaded.</p>
      <button class="btn btn--p" onclick="LAB.goWelcome()">â†º Restart</button>
    </div></div>`);
  },

  _stub(name) {
    const lbl = name.replace('mod_','').replace(/([A-Z])/g,' $1').trim();
    this.render(`<div class="mwrap"><div class="card">
      <div class="step-head"><div class="tag">ğŸ“¦ Module</div>
        <h2 class="h2" style="margin-top:.75rem">${lbl}</h2></div>
      <p class="pg">This module will be added in the next part.</p>
      <div class="btn-row"><button class="btn btn--p" onclick="LAB.skip()">Continue â†’</button></div>
    </div></div>`);
  },

  /* â”€â”€ Progress â”€â”€ */
  _mlabels: {
    mod_reactionSpeed:'âš¡ Reaction Speed',   mod_reactionFatigue:'ğŸ“‰ Fatigue Test',
    mod_workingMemory:'ğŸ§© Memory Matrix',    mod_sustainedAttention:'ğŸ‘ Attention Test',
    mod_colourBlindness:'ğŸ¨ Colour Blindness', mod_visualAcuity:'ğŸ“ Visual Acuity',
    mod_contrastSensitivity:'â¬œ Contrast Sensitivity',
    mod_breathSync:'ğŸŒ¬ Breath Sync',         mod_co2Tolerance:'â± Breath Hold',
    mod_recovery:'â™» Recovery Test',          mod_cogUnderPressure:'ğŸ”¥ Maths Challenge',
    mod_patternOverload:'ğŸ”· Pattern Search', mod_stabilityHold:'ğŸ“± Steady Hand',
    mod_microTremor:'âœ Tremor Drawing',      mod_sleepEfficiency:'ğŸ’¤ Sleep Check',
    mod_lifestyleLoad:'âš– Lifestyle Score',
    mod_hormonalRhythm:'ğŸŒ¸ Hormonal Rhythm', mod_energyIron:'âš¡ Energy & Iron',
    mod_femCombined:'ğŸŒ™ Sleep & Comfort',
  },

  _updateProg() {
    const n=this.queue.length, i=this.idx+1, pct=Math.round(this.idx/n*100);
    const lbl=this._mlabels[this.queue[this.idx]]||'â€”';
    const set=(id,v)=>{const e=this.el(id);if(e)e.textContent=v;};
    set('pStep',`MODULE ${i} / ${n}`);
    set('pLbl',lbl);
    set('pPct',pct+'%');
    const f=this.el('pFill');if(f)f.style.width=pct+'%';
    this.el('progBar').setAttribute('aria-valuenow',pct);
    this.setStatus('active',lbl);
  },

  /* â”€â”€ Render â”€â”€ */
  render(html) {
    const c = this.el('modContent');
    if (!c) return;
    c.innerHTML = html;
    setTimeout(() => c.scrollIntoView({behavior:'smooth',block:'start'}), 80);
  },

  setStatus(state, text) {
    const d=this.el('hsDot'), s=this.el('hsText');
    if (d) d.className = 'hstat'+(state==='active'?'':' idle');
    if (s) s.textContent = text;
  },

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VOICE GUIDANCE â€” English
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  _synth: window.speechSynthesis || null,

  say(en) {
    if (!this.voiceOn || !this._synth) return;
    this._synth.cancel();
    setTimeout(() => {
      if (!this.voiceOn || !this._synth) return;
      const u = new SpeechSynthesisUtterance(en);
      u.lang = 'en-IN'; u.rate = 0.92; u.pitch = 1.0; u.volume = 1.0;
      const voices = this._synth.getVoices();
      const enVoices = voices.filter(v => v.lang.startsWith('en') && !v.name.toLowerCase().includes('compact'));
      if (enVoices.length) u.voice = enVoices.find(v => !v.localService) || enVoices[0];
      const t = this.el('vtog');
      u.onstart = () => { if(t) t.classList.add('speaking'); };
      u.onend   = () => { if(t) t.classList.remove('speaking'); };
      this._synth.speak(u);
    }, 80);
  },

  toggleVoice() {
    this.voiceOn = !this.voiceOn;
    const t=this.el('vtog'), l=this.el('vlbl');
    if (t) t.textContent = this.voiceOn ? 'ğŸ”Š' : 'ğŸ”‡';
    if (l) l.textContent = this.voiceOn ? 'Voice ON' : 'Voice OFF';
    if (this.voiceOn) {
      this.say(
        'Voice guidance is now on. I will guide you before each activity.',
        'ÙˆØ§Ø¦Ø³ Ú¯Ø§Ø¦ÛŒÚˆ Ø¢Ù† ÛÛ’Û”',
        'à¤µà¥‰à¤‡à¤¸ à¤—à¤¾à¤‡à¤¡ à¤šà¤¾à¤²à¥‚ à¤¹à¥ˆà¥¤'
      );
    } else if (this._synth) {
      this._synth.cancel();
    }
  },

  // setLang removed â€” English only

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEMO ENGINE â€” Animated overlay
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  showDemo(cfg, cb) {
    this._demoCB = cb;

    // Clear any previous animation
    if (this._demoAnim) { clearInterval(this._demoAnim); clearTimeout(this._demoAnim); this._demoAnim = null; }

    const set = (id,v,isHTML=false) => { const e=this.el(id); if(e){ isHTML ? e.innerHTML=v : e.textContent=v; } };
    set('demoTitle', cfg.title);
    set('demoTxt',   cfg.txt, true);
    set('demoHint',  cfg.hint || '');

    const ds = this.el('demoStart');
    if (ds) ds.textContent = cfg.btnLabel || 'Got it â€” Start! â†’';

    const dv = this.el('demoVis');
    if (dv) {
      dv.innerHTML = cfg.vis || '';
      if (typeof cfg.anim === 'function') {
        this._demoAnim = cfg.anim(dv);  // anim returns interval/timeout ID
      }
    }

    const ov = this.el('demo-ov');
    if (ov) ov.classList.add('show');
    document.body.style.overflow = 'hidden';

    // Voice reads the instruction
    this.say(cfg.voiceEN || cfg.txt.replace(/<[^>]+>/g,''));
  },

  closeDemo(skip) {
    if (this._demoAnim) { clearInterval(this._demoAnim); clearTimeout(this._demoAnim); this._demoAnim = null; }
    const ov = this.el('demo-ov');
    if (ov) ov.classList.remove('show');
    document.body.style.overflow = '';
    if (typeof this._demoCB === 'function') {
      const cb = this._demoCB;
      this._demoCB = null;
      cb(skip);
    }
  },

  /* â”€â”€ Celebration confetti â”€â”€ */
  celebrate() {
    const cols=['#2A7A5A','#38A87A','#C97800','#F0A020','#1A4731','#66D4A8'];
    for (let i=0;i<32;i++) {
      const el=document.createElement('div'), sz=5+Math.random()*9;
      el.style.cssText=`position:fixed;top:${Math.random()*28+6}%;left:${Math.random()*100}%;
        width:${sz}px;height:${sz}px;border-radius:${Math.random()>.5?'50%':'2px'};
        background:${cols[Math.floor(Math.random()*cols.length)]};pointer-events:none;z-index:9999;
        animation:confettiFall ${1.3+Math.random()*1.5}s ease-in ${Math.random()*.45}s both`;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),3200);
    }
  },

  /* â”€â”€ Flash feedback â”€â”€ */
  flash(type) {
    let f = this.el('_fl');
    if (!f) {
      f=document.createElement('div'); f.id='_fl';
      f.style.cssText='position:fixed;inset:0;z-index:6999;pointer-events:none;opacity:0;transition:opacity .1s';
      document.body.appendChild(f);
    }
    f.style.background = type==='hit'?'rgba(42,122,90,.1)':'rgba(192,57,43,.1)';
    f.style.opacity='1';
    setTimeout(()=>{f.style.opacity='0';},110);
  },

  /* â”€â”€ Reaction bar chart helper â”€â”€ */
  rxBars(times) {
    if (!times.length) return '';
    const mx = Math.max(...times, 600);
    return times.map(t => {
      const h = Math.max(3,Math.round(t/mx*38));
      const c = t<250?'var(--ok)':t<400?'var(--am)':'var(--rd)';
      return `<div class="rxb" style="height:${h}px;background:${c}" title="${t}ms"></div>`;
    }).join('');
  },

  /* â”€â”€ Option card helper (female questionnaires) â”€â”€ */
  _fsel: {},
  optGrid(id, opts) {
    return `<div id="og_${id}">`+
      opts.map((o,i)=>`<div class="ocard" id="oc_${id}_${i}" role="radio" aria-checked="false" tabindex="0"
        onclick="LAB.pickOpt('${id}',${i},${o.v})"
        onkeydown="if(event.key==='Enter'||event.key===' ')LAB.pickOpt('${id}',${i},${o.v})"
        style="display:flex;align-items:center;gap:.75rem;padding:.78rem .95rem;background:#fff;border:2px solid var(--b);border-radius:var(--rs);cursor:pointer;transition:all .2s;margin:.35rem 0">
        <div class="o-dot" id="od_${id}_${i}" style="width:15px;height:15px;border-radius:50%;border:2px solid var(--b);flex-shrink:0;transition:.2s"></div>
        <span style="font-size:.85rem;color:var(--tm)">${o.l}</span>
      </div>`).join('')+'</div>';
  },
  pickOpt(id,idx,val) {
    this._fsel[id]=val;
    for(let i=0;i<20;i++){
      const c=this.el(`oc_${id}_${i}`), d=this.el(`od_${id}_${i}`);
      if(!c) break;
      const sel=i===idx;
      c.style.borderColor=sel?'var(--gd)':'var(--b)';
      c.style.background=sel?'var(--gd3)':'#fff';
      c.setAttribute('aria-checked',String(sel));
      if(d){ d.style.background=sel?'var(--gd)':'transparent'; d.style.borderColor=sel?'var(--gd)':'var(--b)'; }
    }
    this.flash('hit');
  },
  fval(id,def){ return this._fsel[id]!==undefined ? this._fsel[id] : def; },

}; // end LAB

window.LAB = LAB;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Disclaimer slide rotator
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
  let c=0;
  setInterval(()=>{
    document.getElementById('ds'+c)?.classList.remove('on');
    document.getElementById('dd'+c)?.classList.remove('on');
    c=(c+1)%3;
    document.getElementById('ds'+c)?.classList.add('on');
    document.getElementById('dd'+c)?.classList.add('on');
  }, 5000);
})();

console.log('[WellnessLab v2 Part 1] Foundation ready â€” voice (EN/HI/UR), demo engine, navigation loaded.');
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WELLNESS LAB v2 â€” PART 2
     MODULES 1-7: Cognitive (4) + Eye Tests (3)
     Each module: animated demo â†’ voice â†’ activity â†’ result
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>

'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PART 2  â€”  7 INTERACTIVE MODULES
   âš¡ Reaction  ğŸ“‰ Fatigue  ğŸ§© Memory  ğŸ‘ Attention
   ğŸ¨ Colour Blindness  ğŸ“ Visual Acuity  â¬œ Contrast
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ Extra CSS injected once â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function(){
  if (document.getElementById('p2css')) return;
  const s = document.createElement('style');
  s.id = 'p2css';
  s.textContent = `
    .rz{width:100%;border-radius:14px;height:178px;display:flex;align-items:center;
        justify-content:center;flex-direction:column;gap:.4rem;cursor:pointer;
        user-select:none;border:2.5px solid var(--b);transition:background .18s,border-color .18s,box-shadow .18s;
        background:#fff;position:relative;overflow:hidden;-webkit-tap-highlight-color:transparent}
    .rz-l{font-size:clamp(1rem,3vw,1.3rem);font-weight:700;color:var(--tq);transition:color .18s}
    .rz-s{font-size:.68rem;color:var(--tq);transition:opacity .3s}
    .rz.go{background:var(--g4);border-color:var(--g);
           box-shadow:0 0 0 6px rgba(42,120,90,.15),0 0 32px rgba(42,120,90,.12);
           animation:rzPulse 1s ease-in-out infinite}
    .rz.go .rz-l{color:var(--g)}
    .rz.early{background:var(--am2);border-color:var(--am)}
    .rz.early .rz-l{color:var(--am)}
    .rz.done{background:var(--g3);border-color:var(--g2);cursor:default}
    .rz.done .rz-l{color:var(--t)}
    @keyframes rzPulse{0%,100%{box-shadow:0 0 0 6px rgba(42,120,90,.15)}
      50%{box-shadow:0 0 0 14px rgba(42,120,90,.04)}}
    .rxh{display:flex;align-items:flex-end;gap:3px;height:44px;padding:0 .2rem;margin:.5rem 0}
    .rxb{flex:1;border-radius:3px 3px 0 0;min-height:3px;
         transition:height .4s cubic-bezier(.4,0,.2,1),background .3s}
    .timer{font-family:'JetBrains Mono',monospace;font-size:clamp(2.4rem,7vw,3.8rem);
           font-weight:600;line-height:1;text-align:center;color:var(--g);
           display:block;margin:.6rem 0;transition:color .35s}
    .timer.warn{color:var(--am)}
    .timer.crit{color:var(--rd);animation:timerWiggle .45s ease-in-out infinite}
    @keyframes timerWiggle{0%,100%{transform:rotate(0)}
      25%{transform:rotate(-4deg)}75%{transform:rotate(4deg)}}
    .mgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;
           width:min(276px,82vw);margin:0 auto}
    .mcell{aspect-ratio:1;background:#fff;border:2px solid var(--b);
           border-radius:10px;transition:all .2s cubic-bezier(.4,0,.2,1);
           cursor:pointer;display:flex;align-items:center;justify-content:center;
           font-size:1.1rem;-webkit-tap-highlight-color:transparent}
    .mcell.lit{background:var(--g2);border-color:var(--g);
               transform:scale(1.08);box-shadow:0 4px 14px rgba(42,120,90,.25)}
    .mcell.sel{background:#DBEAFE;border-color:#3B82F6}
    .mcell.ok{background:var(--g3);border-color:var(--ok)}
    .mcell.bad{background:var(--rd2);border-color:var(--rd)}
    .ac-row{display:flex;align-items:center;justify-content:center;padding:.75rem;
            background:#fff;border:2px solid var(--b);border-radius:var(--rs);
            margin:.42rem 0;cursor:pointer;transition:all .22s;font-weight:700;
            letter-spacing:.12em;color:var(--t);font-family:'JetBrains Mono',monospace}
    .ac-row:hover{border-color:var(--g);background:var(--g4);transform:translateX(3px)}
    .ac-row.seen{background:var(--g3);border-color:var(--ok)}
    .ac-row.unseen{background:var(--rd2);border-color:var(--rd)}
    .sc-row{display:flex;flex-wrap:wrap;gap:.55rem;margin:.9rem 0}
    .scb{background:var(--bg);border:1.5px solid var(--b);border-radius:var(--rs);
         padding:.55rem .88rem;min-width:76px;transition:border-color .2s}
    .scb:hover{border-color:rgba(42,122,90,.3)}
    .scb .v{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;
            color:var(--g);display:block;line-height:1}
    .scb .l{font-size:.57rem;color:var(--tq);text-transform:uppercase;
            letter-spacing:.09em;margin-top:.15rem;display:block}
    /* demo box shimmer */
    @keyframes shimmer{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .dem-shimmer{animation:shimmer 1.6s ease-in-out infinite}
    /* score pop */
    @keyframes scorePop{0%{transform:scale(.8);opacity:0}
      60%{transform:scale(1.12)}100%{transform:scale(1);opacity:1}}
    .score-pop{animation:scorePop .45s cubic-bezier(.4,0,.2,1) both}
  `;
  document.head.appendChild(s);
})();


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 1 â€” REACTION SPEED
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_reactionSpeed = function () {
  const ROUNDS = 10;
  const st = { round:0, times:[], waiting:false, startT:0, locked:false };
  let _wait = null;

  LAB.showDemo({
    title: 'âš¡ Reaction Speed',
    txt: 'The box turns <strong style="color:var(--am)">red â†’ Wait</strong> then suddenly goes <strong style="color:var(--g)">green â†’ TAP!</strong><br>Hit it the instant you see green. <strong>Do NOT tap on Wait or you lose that round.</strong>',
    hint: '10 rounds Â· try to beat your best each time!',
    voiceEN: 'Here is how this works. A box will appear â€” red means wait, green means tap as fast as you can. Ten rounds. Ready?',
    btnLabel: 'Start Reaction Test â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.8rem;padding:.6rem">
      <div id="dRxBox" class="d3p" style="width:160px;height:58px;border-radius:16px;
           background:#fff;border:2.5px solid #D4E8DC;
           display:flex;align-items:center;justify-content:center;
           font-weight:800;font-size:1rem;color:#6A8A6A;
           box-shadow:0 8px 24px rgba(42,120,90,.12),0 2px 6px rgba(0,0,0,.06);
           transition:all .25s cubic-bezier(.4,0,.2,1);letter-spacing:.03em">â³ Waitâ€¦</div>
      <div style="display:flex;gap:6px;align-items:center">
        <div style="width:10px;height:10px;border-radius:50%;background:#E88080;box-shadow:0 0 8px rgba(220,80,80,.4)"></div>
        <div style="font-size:.65rem;color:var(--tq);font-weight:600">Red = Wait Â· Green = TAP!</div>
        <div style="width:10px;height:10px;border-radius:50%;background:#38A87A;box-shadow:0 0 8px rgba(42,120,90,.4)"></div>
      </div>
    </div>`,
    anim(vis) {
      let on = false;
      const box = vis.querySelector('#dRxBox');
      const id = setInterval(() => {
        on = !on;
        if (!box) return;
        box.style.background   = on ? '#E8F5EE' : '#FFF5F5';
        box.style.borderColor  = on ? '#2A7A5A' : '#E88080';
        box.style.color        = on ? '#1A8C52' : '#C05050';
        box.style.boxShadow    = on ? '0 0 0 5px rgba(42,120,90,.15)' : 'none';
        box.style.transform    = on ? 'scale(1.04)' : 'scale(1)';
        box.textContent        = on ? 'ğŸ‘† TAP NOW!' : 'ğŸ”´ Waitâ€¦';
      }, 1000);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">âš¡ Cognitive Â· 1 of 4</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Reaction Speed</h2>
        <p class="pg">Tap the box the <strong>instant</strong> it turns <strong style="color:var(--g)">green</strong>. 10 rounds. Tap on red = lost round!</p>
      </div>
      <div id="rxBox" class="rz" onclick="_rxTap()" role="button" tabindex="0"
           onkeydown="if(event.key===' '||event.key==='Enter')_rxTap()"
           aria-label="Reaction zone">
        <span class="rz-l" id="rxLbl">Getting readyâ€¦</span>
        <span class="rz-s" id="rxSub">â¬† keep your finger ready above</span>
      </div>
      <div class="rxh" id="rxH" aria-hidden="true"></div>
      <div class="sc-row">
        <div class="scb"><span class="v" id="rxRnd">0/${ROUNDS}</span><span class="l">Round</span></div>
        <div class="scb"><span class="v" id="rxLast">â€”</span><span class="l">Last ms</span></div>
        <div class="scb"><span class="v" id="rxBest">â€”</span><span class="l">Best ms</span></div>
        <div class="scb"><span class="v" id="rxAvg">â€”</span><span class="l">Average</span></div>
      </div>
    </div></div>`);
    LAB.say('Alright, keep your finger ready. Tap as soon as you see green.');
    setTimeout(_rxSchedule, 900);
  });

  function _rxSchedule() {
    const z=document.getElementById('rxBox'), l=document.getElementById('rxLbl'), s=document.getElementById('rxSub');
    if (!z) return;
    z.className='rz'; z.style.background='#FFF5F5'; z.style.borderColor='#E88080';
    if (l) { l.textContent='ğŸ”´ Waitâ€¦'; l.style.color='#C05050'; }
    if (s) s.textContent='do NOT tap yet';
    st.waiting=false; st.locked=false;
    _wait = setTimeout(() => {
      const z2=document.getElementById('rxBox'), l2=document.getElementById('rxLbl');
      if (!z2) return;
      z2.className='rz go'; z2.style.background=''; z2.style.borderColor='';
      if (l2) { l2.textContent='ğŸ‘† TAP NOW!'; l2.style.color=''; }
      st.waiting=true; st.startT=performance.now();
    }, 1200 + Math.random()*2800);
  }

  window._rxTap = function () {
    if (st.locked) return;
    if (!st.waiting) {
      clearTimeout(_wait); st.locked=true;
      const z=document.getElementById('rxBox'), l=document.getElementById('rxLbl');
      if (z) { z.className='rz early'; z.style.background=''; z.style.borderColor=''; }
      if (l) { l.textContent='âš  Too early! Wait for green.'; l.style.color=''; }
      LAB.flash('miss');
      setTimeout(_rxSchedule, 1400);
      return;
    }
    const rt = Math.round(performance.now() - st.startT);
    st.times.push(rt); st.round++; st.waiting=false; st.locked=true;
    const col = rt<250?'var(--ok)':rt<400?'var(--am)':'var(--rd)';
    const em  = rt<200?'ğŸš€':rt<280?'âš¡':rt<380?'ğŸ‘':'â³';
    const z=document.getElementById('rxBox'), l=document.getElementById('rxLbl');
    if (z) { z.className='rz done'; z.style.background=''; z.style.borderColor=''; }
    if (l) { l.textContent=`${em} ${rt} ms`; l.style.color=col; }
    const set=(id,v,c)=>{const e=document.getElementById(id);if(!e)return;e.textContent=v;if(c)e.style.color=c;};
    set('rxRnd',st.round+'/'+ROUNDS);
    set('rxLast',rt+'ms',col);
    set('rxBest',Math.min(...st.times)+'ms','var(--ok)');
    set('rxAvg',Math.round(LAB.avg(st.times))+'ms');
    const h=document.getElementById('rxH');
    if (h) {
      const mx=Math.max(...st.times,400);
      h.innerHTML=st.times.map(t=>{
        const ht=Math.max(4,Math.round(t/mx*40));
        const c=t<250?'var(--ok)':t<400?'var(--am)':'var(--rd)';
        return `<div class="rxb" style="height:${ht}px;background:${c}" title="${t}ms"></div>`;
      }).join('');
    }
    LAB.flash('hit');
    if (st.round>=ROUNDS) setTimeout(_rxDone,700);
    else setTimeout(_rxSchedule,820);
  };

  function _rxDone() {
    const m=LAB.avg(st.times), sd=LAB.sd(st.times), best=Math.min(...st.times);
    const sc=LAB.clamp(Math.round((m<200?100:m<260?92:m<320?82:m<420?70:m<560?55:38) - sd/22),18,100);
    LAB.raw.rxAvg=Math.round(m); LAB.raw.rxBest=best; LAB.raw.rxSD=Math.round(sd); LAB.raw.rxScore=sc;
    LAB.celebrate();
    LAB.say(`Nice work! Your average was ${Math.round(m)} milliseconds. That is ${LAB.scoreLbl(sc)}!`);
    setTimeout(()=>{ LAB.idx++; LAB.next(); },1900);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 2 â€” FATIGUE DRIFT (30s sustained reaction)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_reactionFatigue = function () {
  const DUR=30;
  const st={active:false,elapsed:0,waiting:false,startT:0,taps:[],locked:false};
  let _cd=null,_pt=null;

  LAB.showDemo({
    title: 'ğŸ“‰ Fatigue Test',
    txt: 'Same as reaction speed â€” but for <strong>30 seconds non-stop</strong>. Keep tapping every time the box flashes green. We check if you slow down towards the end.',
    hint: '30 seconds Â· do you stay consistent?',
    voiceEN: 'Same idea as before â€” but this time for thirty seconds non-stop. We will check if you slow down towards the end.',
    btnLabel: 'Start 30s Test â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.6rem;padding:.4rem">
      <div style="display:flex;align-items:flex-end;gap:4px;height:56px;padding:0 4px">
        ${Array.from({length:10},(_,i)=>`<div id="dFb${i}" style="width:11px;border-radius:4px 4px 0 0;
          background:linear-gradient(to top,var(--g),var(--g2));
          box-shadow:0 -2px 8px rgba(42,120,90,.2);
          transition:height .2s cubic-bezier(.4,0,.2,1),box-shadow .2s;
          height:${14+i*3}px"></div>`).join('')}
      </div>
      <div style="font-size:.64rem;color:var(--tq);font-weight:600;letter-spacing:.06em">TAP Â· TAP Â· TAP â€” 30 seconds</div>
    </div>`,
    anim(vis) {
      let i=0;
      const id=setInterval(()=>{
        const bars=vis.querySelectorAll('[id^="dFb"]');
        bars.forEach((b,j)=>{
          const isActive=j===i;
          b.style.height=(isActive?'42px':(12+j*2)+'px');
          b.style.background=isActive?'var(--g)':'var(--g2)';
        });
        i=(i+1)%bars.length;
      },200);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ“‰ Cognitive Â· 2 of 4</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Fatigue Drift</h2>
        <p class="pg">Tap every time the box turns green â€” <strong>for 30 seconds</strong>. We compare your speed at the start vs the end.</p>
      </div>
      <span class="timer" id="ftTimer">30</span>
      <div id="ftBox" class="rz" onclick="_ftTap()" role="button" tabindex="0"
           onkeydown="if(event.key===' '||event.key==='Enter')_ftTap()" aria-label="Fatigue tap zone"
           style="cursor:default;background:#F8FAFB;border-color:#D4E8DC">
        <span class="rz-l" id="ftLbl">Press Start below</span>
        <span class="rz-s">30-second endurance test</span>
      </div>
      <div class="sc-row">
        <div class="scb"><span class="v" id="ftTaps">0</span><span class="l">Total Taps</span></div>
        <div class="scb"><span class="v" id="ftAvg">â€”</span><span class="l">Avg ms</span></div>
        <div class="scb"><span class="v" id="ftDrift">â€”</span><span class="l">Drift</span></div>
      </div>
      <div class="btn-row">
        <button class="btn btn--p btn--lg" id="ftStartBtn" onclick="_ftBegin()">â–¶ Start 30s Test</button>
      </div>
    </div></div>`);
    LAB.say('Press start and tap every time the box turns green. Thirty seconds.');
  });

  window._ftBegin = function () {
    const b=document.getElementById('ftStartBtn'); if(b) b.style.display='none';
    const z=document.getElementById('ftBox'); if(z) z.style.cursor='pointer';
    st.active=true;
    _cd=setInterval(()=>{
      st.elapsed++;
      const rem=DUR-st.elapsed;
      const te=document.getElementById('ftTimer');
      if(te){ te.textContent=rem; te.className='timer'+(rem<=5?' crit':rem<=12?' warn':''); }
      if(rem===20) LAB.say('Good â€” twenty seconds to go!');
      if(rem===10) LAB.say('Nearly there â€” ten seconds left!');
      if(rem===5)  LAB.say('Last five â€” keep going!');
      if(st.elapsed>=DUR){ clearInterval(_cd); clearTimeout(_pt); st.active=false; _ftDone(); }
    },1000);
    _ftNext();
  };

  function _ftNext() {
    if(!st.active||!document.getElementById('ftBox')) return;
    const z=document.getElementById('ftBox'), l=document.getElementById('ftLbl');
    if(z){ z.className='rz'; z.style.background='#FFF5F5'; z.style.borderColor='#E88080'; }
    if(l){ l.textContent='ğŸ”´ Waitâ€¦'; l.style.color='#C05050'; }
    st.waiting=false; st.locked=false;
    _pt=setTimeout(()=>{
      const z2=document.getElementById('ftBox'), l2=document.getElementById('ftLbl');
      if(!z2) return;
      z2.className='rz go'; z2.style.background=''; z2.style.borderColor='';
      if(l2){ l2.textContent='ğŸ‘† TAP!'; l2.style.color=''; }
      st.waiting=true; st.startT=performance.now();
    }, 400+Math.random()*800);
  }

  window._ftTap = function () {
    if(!st.active||st.locked) return;
    if(!st.waiting){ LAB.flash('miss'); return; }
    const rt=Math.round(performance.now()-st.startT);
    st.taps.push({t:rt, elapsed:st.elapsed}); st.waiting=false; st.locked=true;
    const z=document.getElementById('ftBox'), l=document.getElementById('ftLbl');
    if(z){ z.className='rz done'; z.style.background=''; z.style.borderColor=''; }
    if(l){ l.textContent=`âš¡ ${rt}ms`; l.style.color='var(--ok)'; }
    const tc=document.getElementById('ftTaps'); if(tc) tc.textContent=st.taps.length;
    if(st.taps.length>=2){
      const avg=Math.round(LAB.avg(st.taps.map(t=>t.t)));
      const avgEl=document.getElementById('ftAvg'); if(avgEl) avgEl.textContent=avg+'ms';
    }
    LAB.flash('hit');
    setTimeout(_ftNext, 250);
  };

  function _ftDone() {
    const taps=st.taps;
    if(taps.length<4){ LAB.idx++; LAB.next(); return; } // too few taps â€” leave ftScore null (skipped)
    const half=Math.floor(taps.length/2);
    const first=LAB.avg(taps.slice(0,half).map(t=>t.t));
    const last =LAB.avg(taps.slice(-half).map(t=>t.t));
    const drift=Math.round(last-first);
    const score=LAB.clamp(Math.round(100-Math.max(0,drift)/3.5),15,100);
    LAB.raw.ftTaps=taps.length; LAB.raw.ftDrift=drift; LAB.raw.ftScore=score;
    const dEl=document.getElementById('ftDrift');
    if(dEl){ dEl.textContent=(drift>0?'+':'')+drift+'ms'; dEl.style.color=LAB.scoreCol(score); }
    LAB.celebrate();
    LAB.say(`Fatigue test done! ${taps.length} taps. Drift of ${Math.abs(drift)} milliseconds. ${LAB.scoreLbl(score)} endurance.`);
    setTimeout(()=>{ LAB.idx++; LAB.next(); },1900);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 3 â€” WORKING MEMORY (3Ã—3 grid)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_workingMemory = function () {
  const TOTAL_ROUNDS=7;
  const st={seq:[],user:[],span:3,round:0,maxSpan:0,errors:0,phase:'idle'};

  LAB.showDemo({
    title: 'ğŸ§© Memory Matrix',
    txt: 'Boxes light up one by one in a sequence. <strong>Remember the order</strong>, then tap them back in the same order. Each round gets a little longer!',
    hint: 'Watch carefully â€” then repeat the pattern',
    voiceEN: 'Watch the grid carefully. Some boxes will light up one by one. Once they stop, tap them back in the exact same order. Each round gets a little longer.',
    btnLabel: 'Start Memory Test â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.8rem;padding:.3rem">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;width:114px;transform-style:preserve-3d;transform:rotateX(12deg) rotateY(-6deg)" id="dMemGrid">
        ${Array.from({length:9},(_,i)=>`<div id="dm${i}" style="aspect-ratio:1;background:#fff;border:2px solid #D4E8DC;border-radius:9px;transition:all .22s cubic-bezier(.4,0,.2,1);box-shadow:0 3px 8px rgba(0,0,0,.08)"></div>`).join('')}
      </div>
      <div style="font-size:.65rem;color:var(--tq);font-weight:600" id="dMemHint">Watch â†’ Remember â†’ Tap back</div>
    </div>`,
    anim(vis) {
      const cells=vis.querySelectorAll('[id^="dm"]');
      const hint=vis.querySelector('#dMemHint');
      const seqs=[[0,4,2,7,1],[3,8,0,5],[1,6,3,8,2,4]];
      let si=0,step=0,showing=false;
      const seq=seqs[si];
      const id=setInterval(()=>{
        if(showing){
          cells.forEach(c=>{c.style.background='#fff';c.style.borderColor='#D4E8DC';c.style.transform='scale(1)';});
          showing=false;
        } else {
          if(step<seq.length){
            const c=cells[seq[step]];
            if(c){c.style.background='#38A87A';c.style.borderColor='#2A7A5A';c.style.transform='scale(1.1)';}
            step++;showing=true;
          } else {
            step=0;si=(si+1)%seqs.length;
            if(hint) hint.textContent=step===0?'Now tap them backâ€¦':'Watch the sequenceâ€¦';
          }
        }
      },520);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ§© Cognitive Â· 3 of 4</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Memory Matrix</h2>
        <p class="pg">Watch the boxes light up, then tap them back in the <strong>exact same order</strong>.</p>
      </div>
      <div style="display:flex;justify-content:center;gap:.3rem;margin:.6rem 0" id="mPips" aria-label="Sequence length">
        ${Array.from({length:9},(_,i)=>`<div id="mp${i}" style="width:9px;height:9px;border-radius:50%;background:var(--b);transition:.35s"></div>`).join('')}
      </div>
      <div style="display:flex;justify-content:center;margin:.85rem 0">
        <div class="mgrid" role="group" aria-label="Memory grid">
          ${Array.from({length:9},(_,i)=>`<div class="mcell" id="mc${i}" role="button" tabindex="0"
            aria-label="Cell ${i+1}" onclick="_mTap(${i})"
            onkeydown="if(event.key==='Enter'||event.key===' ')_mTap(${i})"></div>`).join('')}
        </div>
      </div>
      <div class="mono" style="text-align:center;font-size:.72rem;color:var(--tq);min-height:1.4em;transition:.3s" id="mSt">Prepare yourselfâ€¦</div>
      <div class="sc-row" style="justify-content:center">
        <div class="scb"><span class="v" id="mRnd">0/${TOTAL_ROUNDS}</span><span class="l">Round</span></div>
        <div class="scb"><span class="v" id="mLen">3</span><span class="l">Sequence</span></div>
        <div class="scb"><span class="v" id="mMax">0</span><span class="l">Best Span</span></div>
        <div class="scb"><span class="v" id="mErr">0</span><span class="l">Mistakes</span></div>
      </div>
    </div></div>`);
    LAB.say('Watch carefully, then repeat the pattern. Here we go.');
    setTimeout(_mRound,700);
  });

  function _mPips(n){for(let i=0;i<9;i++){const p=document.getElementById('mp'+i);if(p)p.style.background=i<n?'var(--g2)':'var(--b)';}}
  function _mSetCell(i,cls){const c=document.getElementById('mc'+i);if(!c)return;c.className='mcell'+(cls?' '+cls:'');}
  function _mInteract(on){for(let i=0;i<9;i++){const c=document.getElementById('mc'+i);if(!c)break;c.style.pointerEvents=on?'auto':'none';c.tabIndex=on?0:-1;}}
  function _mSt(t,col='var(--tq)'){const e=document.getElementById('mSt');if(e){e.textContent=t;e.style.color=col;}}

  function _mRound(){
    if(!document.getElementById('mc0')) return;
    st.seq=[];st.user=[];st.phase='show';st.round++;
    for(let i=0;i<st.span;i++){let n;do{n=Math.floor(Math.random()*9);}while(st.seq.length&&n===st.seq[st.seq.length-1]);st.seq.push(n);}
    const rEl=document.getElementById('mRnd'),lEl=document.getElementById('mLen');
    if(rEl)rEl.textContent=st.round+'/'+TOTAL_ROUNDS;
    if(lEl)lEl.textContent=st.span;
    _mPips(st.span);_mInteract(false);_mSt('ğŸ‘€ Watch the sequence carefullyâ€¦');
    let idx=0;
    function _show(){
      if(!document.getElementById('mc0')) return;
      if(idx>0) _mSetCell(st.seq[idx-1],'');
      if(idx>=st.seq.length){st.phase='input';_mInteract(true);_mSt('ğŸ‘† Now tap them in order!','var(--g)');return;}
      _mSetCell(st.seq[idx],'lit');idx++;
      setTimeout(_show,520);
    }
    setTimeout(_show,500);
  }

  window._mTap=function(i){
    if(st.phase!=='input') return;
    const pos=st.user.length,expected=st.seq[pos];
    st.user.push(i);
    if(i===expected){_mSetCell(i,'sel');LAB.flash('hit');setTimeout(()=>_mSetCell(i,'ok'),230);}
    else{
      st.errors++;_mSetCell(i,'bad');LAB.flash('miss');
      setTimeout(()=>{_mSetCell(expected,'lit');setTimeout(()=>_mSetCell(expected,''),380);},160);
      const eEl=document.getElementById('mErr');if(eEl)eEl.textContent=st.errors;
    }
    if(st.user.length===st.seq.length){
      _mInteract(false);
      const allOk=st.user.every((v,j)=>v===st.seq[j]);
      if(allOk){st.maxSpan=Math.max(st.maxSpan,st.span);if(st.span<9)st.span++;_mSt('âœ… Correct! Getting longerâ€¦','var(--ok)');const mm=document.getElementById('mMax');if(mm)mm.textContent=st.maxSpan;}
      else{if(st.span>2)st.span--;_mSt('âŒ Not quite. A little shorter next round.','var(--rd)');}
      setTimeout(st.round>=TOTAL_ROUNDS?_mDone:_mRound,st.round>=TOTAL_ROUNDS?1100:1250);
    }
  };

  function _mDone(){
    const sc=LAB.clamp(Math.round((st.maxSpan/9)*80-st.errors*2.5+18),12,100);
    LAB.raw.memSpan=st.maxSpan;LAB.raw.memErrors=st.errors;LAB.raw.memScore=sc;
    LAB.celebrate();
    LAB.say(`Well done! Your best sequence was ${st.maxSpan} items long. That is ${LAB.scoreLbl(sc)} working memory.`);
    setTimeout(()=>{LAB.idx++;LAB.next();},1900);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 4 â€” SUSTAINED ATTENTION (60 seconds)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_sustainedAttention = function () {
  const DUR=60;
  const st={active:false,elapsed:0,type:null,canTap:false,hits:0,fa:0,misses:0};
  let _cd=null,_st=null;

  LAB.showDemo({
    title: 'ğŸ‘ Attention Test',
    txt: 'A circle appears â€” either <strong style="color:var(--g)">GREEN</strong> or <strong style="color:var(--rd)">RED</strong>.<br>Tap <strong>only the GREEN</strong> circle. Completely ignore red. 60 seconds.',
    hint: 'Green = tap Â· Red = ignore Â· stay sharp!',
    voiceEN: 'This one is sixty seconds long. A circle will appear â€” sometimes green, sometimes red. Only tap the green one. Completely ignore red. Try to stay sharp the whole time.',
    btnLabel: 'Start Attention Test â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.7rem;padding:.4rem">
      <div style="display:flex;gap:14px;align-items:center">
        <div style="text-align:center">
          <div id="dAtCirc" class="d3b" style="width:72px;height:72px;border-radius:50%;background:#E8F5EE;
               border:3px solid #2A7A5A;display:flex;align-items:center;justify-content:center;
               font-size:1.9rem;box-shadow:0 6px 20px rgba(42,120,90,.2)">ğŸŸ¢</div>
          <div style="font-size:.6rem;color:var(--g);font-weight:700;margin-top:4px">TAP âœ“</div>
        </div>
        <div style="color:var(--tq);font-size:1rem;font-weight:700">vs</div>
        <div style="text-align:center">
          <div style="width:72px;height:72px;border-radius:50%;background:#FEECEB;
               border:3px solid #C0392B;display:flex;align-items:center;justify-content:center;
               font-size:1.9rem;box-shadow:0 6px 20px rgba(192,57,43,.15);opacity:.75">ğŸ”´</div>
          <div style="font-size:.6rem;color:var(--rd);font-weight:700;margin-top:4px">IGNORE âœ—</div>
        </div>
      </div>
    </div>`,
    anim(vis) {
      const c=vis.querySelector('#dAtCirc'),l=vis.querySelector('#dAtLbl');
      let green=true;
      const id=setInterval(()=>{
        green=!green;
        if(!c||!l) return;
        c.style.background=green?'#E8F5EE':'#FEECEB';
        c.style.borderColor=green?'#2A7A5A':'#C0392B';
        c.style.transform=green?'scale(1.08)':'scale(1)';
        c.textContent=green?'ğŸŸ¢':'ğŸ”´';
        l.style.color=green?'var(--g)':'var(--rd)';
        l.textContent=green?'TAP THIS â† immediately':'IGNORE THIS âœ‹';
      },1100);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ‘ Cognitive Â· 4 of 4</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Attention Test</h2>
        <div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.6rem">
          <span style="display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .72rem;background:var(--g3);border:1px solid rgba(42,122,90,.28);border-radius:50px;font-size:.8rem;font-weight:700;color:var(--g)">ğŸŸ¢ Green = TAP</span>
          <span style="display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .72rem;background:var(--rd2);border:1px solid rgba(192,57,43,.28);border-radius:50px;font-size:.8rem;font-weight:700;color:var(--rd)">ğŸ”´ Red = IGNORE</span>
        </div>
        <p class="pg">60 seconds. Missing a green or tapping red both reduce your score.</p>
      </div>
      <span class="timer" id="atTimer">60</span>
      <div style="display:flex;justify-content:center;margin:.9rem 0">
        <div id="atTarget" onclick="_atTap()" role="button" tabindex="0"
             onkeydown="if(event.key===' '||event.key==='Enter')_atTap()"
             aria-label="Attention target"
             style="width:140px;height:140px;border-radius:50%;background:var(--bg);border:3px solid var(--b);
                    display:flex;flex-direction:column;align-items:center;justify-content:center;
                    cursor:pointer;transition:all .18s;user-select:none;-webkit-tap-highlight-color:transparent">
          <span style="font-size:2.8rem" id="atIcon">â€”</span>
          <span style="font-size:.62rem;font-family:'JetBrains Mono',monospace;color:var(--tq);margin-top:.15rem" id="atHint">Waitingâ€¦</span>
        </div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:3px;justify-content:center;min-height:14px;margin:.2rem 0" id="atTrail" aria-hidden="true"></div>
      <div class="sc-row" style="justify-content:center">
        <div class="scb"><span class="v" id="atH">0</span><span class="l">Hits âœ“</span></div>
        <div class="scb"><span class="v" id="atF">0</span><span class="l">False âœ—</span></div>
        <div class="scb"><span class="v" id="atM">0</span><span class="l">Missed</span></div>
        <div class="scb"><span class="v" id="atAcc">â€”</span><span class="l">Accuracy</span></div>
      </div>
      <div class="btn-row">
        <button class="btn btn--p btn--lg" id="atStart" onclick="_atBegin()">â–¶ Start 60s Test</button>
      </div>
    </div></div>`);
    LAB.say('Remember â€” green means tap, red means ignore. Sixty seconds.');
  });

  window._atBegin=function(){
    const b=document.getElementById('atStart');if(b)b.style.display='none';
    st.active=true;
    _cd=setInterval(()=>{
      st.elapsed++;
      const rem=DUR-st.elapsed;
      const te=document.getElementById('atTimer');
      if(te){te.textContent=rem;te.className='timer'+(rem<=8?' crit':rem<=18?' warn':'');}
      if(rem===40) LAB.say('Halfway through â€” keep your focus!');
      if(rem===20) LAB.say('Twenty seconds left!');
      if(rem===5)  LAB.say('Last five!');
      if(st.elapsed>=DUR){clearInterval(_cd);clearTimeout(_st);_atDone();}
    },1000);
    _atNext();
  };

  function _atNext(){
    if(!st.active||!document.getElementById('atTarget')) return;
    const isGreen=Math.random()>0.36; st.type='';st.canTap=false;
    const tg=document.getElementById('atTarget'),ic=document.getElementById('atIcon'),ht=document.getElementById('atHint');
    if(tg){tg.style.background='var(--bg)';tg.style.borderColor='var(--b)';tg.style.boxShadow='none';}
    if(ic)ic.textContent='â€”';if(ht)ht.textContent='Waitingâ€¦';
    setTimeout(()=>{
      if(!st.active||!document.getElementById('atTarget')) return;
      st.type=isGreen?'green':'red';st.canTap=true;
      if(tg){
        tg.style.background=isGreen?'var(--g4)':'var(--rd2)';
        tg.style.borderColor=isGreen?'var(--g)':'var(--rd)';
        tg.style.boxShadow=isGreen?'0 0 28px rgba(42,120,90,.22)':'0 0 28px rgba(192,57,43,.18)';
        tg.style.transform='scale(1.04)';
      }
      if(ic)ic.textContent=isGreen?'ğŸŸ¢':'ğŸ”´';
      if(ht)ht.textContent=isGreen?'TAP! ğŸ‘†':'IGNORE âœ‹';
      _st=setTimeout(()=>{
        if(!st.canTap)return;
        st.canTap=false;
        if(st.type==='green'){st.misses++;_atDot('miss');_atStats();}
        if(tg){tg.style.background='var(--bg)';tg.style.borderColor='var(--b)';tg.style.boxShadow='none';tg.style.transform='';}
        if(ic)ic.textContent='â€”';if(ht)ht.textContent='Waitingâ€¦';
        setTimeout(_atNext,280+Math.random()*360);
      },780+Math.random()*680);
    },200+Math.random()*300);
  }

  window._atTap=function(){
    if(!st.active||!st.canTap) return;
    clearTimeout(_st);st.canTap=false;
    if(st.type==='green'){st.hits++;_atDot('hit');LAB.flash('hit');}
    else{st.fa++;_atDot('fa');LAB.flash('miss');}
    _atStats();
    const tg=document.getElementById('atTarget'),ic=document.getElementById('atIcon'),ht=document.getElementById('atHint');
    if(tg){tg.style.background='var(--bg)';tg.style.borderColor='var(--b)';tg.style.boxShadow='none';tg.style.transform='';}
    if(ic)ic.textContent='â€”';if(ht)ht.textContent='Waitingâ€¦';
    setTimeout(_atNext,260+Math.random()*300);
  };

  function _atDot(type){
    const tr=document.getElementById('atTrail');if(!tr)return;
    const d=document.createElement('div');
    d.style.cssText=`width:9px;height:9px;border-radius:50%;flex-shrink:0;transition:transform .2s;
      background:${type==='hit'?'var(--ok)':type==='fa'?'var(--rd)':'var(--am)'}`;
    d.style.transform='scale(1.5)';
    tr.appendChild(d);
    setTimeout(()=>{if(d)d.style.transform='scale(1)';},150);
    while(tr.children.length>30) tr.removeChild(tr.firstChild);
  }

  function _atStats(){
    const tot=Math.max(1,st.hits+st.fa),acc=Math.round(st.hits/tot*100);
    const s=(id,v,c)=>{const e=document.getElementById(id);if(e){e.textContent=v;if(c)e.style.color=c;}};
    s('atH',st.hits);s('atF',st.fa);s('atM',st.misses);
    s('atAcc',acc+'%',acc>85?'var(--ok)':acc>65?'var(--am)':'var(--rd)');
  }

  function _atDone(){
    const prec=st.hits/Math.max(1,st.hits+st.fa),rec=st.hits/Math.max(1,st.hits+st.misses);
    const f1=(2*prec*rec)/Math.max(.01,prec+rec);
    const sc=LAB.clamp(Math.round(f1*90),12,100);
    LAB.raw.attHits=st.hits;LAB.raw.attFA=st.fa;LAB.raw.attMiss=st.misses;LAB.raw.attScore=sc;
    const cogScores=[LAB.raw.rxScore,LAB.raw.ftScore,LAB.raw.memScore,sc].filter(x=>x!=null);
    LAB.scores.cognitive=cogScores.length?Math.round(LAB.avg(cogScores)):sc;
    LAB.celebrate();
    LAB.say(`Great effort! You hit ${st.hits} green circles over sixty seconds. That is ${LAB.scoreLbl(sc)} attention.`);
    setTimeout(()=>{LAB.idx++;LAB.next();},1900);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 5 â€” COLOUR BLINDNESS (SVG Ishihara)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_colourBlindness = function () {
  const plates=[
    {ans:'12',bg:'#E09040',fg:'#C83010',label:'Plate 1 of 6'},
    {ans:'8', bg:'#70B070',fg:'#2A6020',label:'Plate 2 of 6'},
    {ans:'6', bg:'#9090CC',fg:'#D0A020',label:'Plate 3 of 6'},
    {ans:'29',bg:'#CC6060',fg:'#50A050',label:'Plate 4 of 6'},
    {ans:'5', bg:'#80A8C0',fg:'#E07020',label:'Plate 5 of 6'},
    {ans:'3', bg:'#B870B0',fg:'#70C070',label:'Plate 6 of 6'},
  ];
  let curr=0,correct=0;

  function mkRng(seed){let s=seed;return()=>{s=(s*9301+49297)%233280;return s/233280;};}

  function makePlate(bgCol,fgCol,numStr){
    const W=240,R=118,cx=120,cy=120;
    const rng=mkRng(numStr.split('').reduce((a,c)=>a+c.charCodeAt(0),0)*17);
    const dots=[];
    for(let i=0;i<340;i++){
      const angle=rng()*Math.PI*2,r=rng()*(R-8)+4;
      const x=cx+r*Math.cos(angle),y=cy+r*Math.sin(angle),sz=3.5+rng()*5.5,op=0.55+rng()*0.45;
      dots.push(`<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${sz.toFixed(1)}" fill="${bgCol}" opacity="${op.toFixed(2)}"/>`);
    }
    const glyphs={'0':[[1,1,1],[1,0,1],[1,0,1],[1,0,1],[1,0,1],[1,0,1],[1,1,1]],'1':[[0,1,0],[1,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[1,1,1]],'2':[[1,1,1],[0,0,1],[0,0,1],[1,1,1],[1,0,0],[1,0,0],[1,1,1]],'3':[[1,1,1],[0,0,1],[0,0,1],[1,1,1],[0,0,1],[0,0,1],[1,1,1]],'4':[[1,0,1],[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1],[0,0,1]],'5':[[1,1,1],[1,0,0],[1,0,0],[1,1,1],[0,0,1],[0,0,1],[1,1,1]],'6':[[1,1,1],[1,0,0],[1,0,0],[1,1,1],[1,0,1],[1,0,1],[1,1,1]],'7':[[1,1,1],[0,0,1],[0,0,1],[0,1,0],[0,1,0],[0,1,0],[0,1,0]],'8':[[1,1,1],[1,0,1],[1,0,1],[1,1,1],[1,0,1],[1,0,1],[1,1,1]],'9':[[1,1,1],[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1],[1,1,1]]};
    const digits=numStr.split('').filter(d=>glyphs[d]);
    const cellSize=11,gap=4,totalW=digits.length*(3*cellSize+gap)-gap;
    const startX=cx-totalW/2,startY=cy-3.5*cellSize;
    digits.forEach((d,di)=>{
      const glyph=glyphs[d],ox=startX+di*(3*cellSize+gap);
      glyph.forEach((row,ry)=>row.forEach((pixel,rx)=>{
        if(!pixel)return;
        const px=ox+rx*cellSize+cellSize/2,py=startY+ry*cellSize+cellSize/2;
        const dist=Math.hypot(px-cx,py-cy);
        if(dist>R-6)return;
        const sz=5.5+rng()*3;
        dots.push(`<circle cx="${px.toFixed(1)}" cy="${py.toFixed(1)}" r="${sz.toFixed(1)}" fill="${fgCol}" opacity="${(0.75+rng()*0.25).toFixed(2)}"/>`);
      }));
    });
    return `<svg viewBox="0 0 ${W} ${W}" width="${W}" height="${W}" style="max-width:100%;border-radius:50%;box-shadow:0 4px 20px rgba(0,0,0,.12)"><circle cx="${cx}" cy="${cy}" r="${R}" fill="#E8E0D0"/>${dots.join('')}</svg>`;
  }

  LAB.showDemo({
    title: 'ğŸ¨ Colour Blindness Check',
    txt: 'You will see a circle packed with coloured dots. <strong>A number is hidden inside</strong> â€” look carefully. Type the number or tap "Cannot see it".',
    hint: '6 plates â€” takes about 2 minutes',
    voiceEN: 'Take a look at the circle. It is packed with coloured dots, and a number is hidden somewhere inside. Try to spot it and type it in. Do not worry if you cannot see it.',
    btnLabel: 'Start Colour Check â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.6rem;padding:.3rem">
      <div class="d3f" style="border-radius:50%;box-shadow:0 8px 24px rgba(0,0,0,.15),0 2px 8px rgba(0,0,0,.08)">
        <canvas id="cbDemoC" width="90" height="90" style="border-radius:50%;display:block"></canvas>
      </div>
      <div id="cbDemoH" style="font-size:.65rem;color:var(--tq);font-weight:600">Can you spot the hidden number?</div>
    </div>`,
    anim(vis) {
      const canvas=vis.querySelector('#cbDemoC'),hint=vis.querySelector('#cbDemoH');
      if(!canvas)return null;
      const ctx=canvas.getContext('2d');
      const W=88,cx=44,cy=44,R=41;
      function draw(reveal){
        ctx.clearRect(0,0,W,W);
        const rng=(s=>{let x=s;return()=>{x=(x*9301+49297)%233280;return x/233280;}})(42);
        ctx.fillStyle='#E8E0D0';ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fill();
        for(let i=0;i<120;i++){
          const a=rng()*Math.PI*2,r=rng()*(R-4)+2;
          const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a),sz=1.5+rng()*2.5;
          ctx.fillStyle=`hsl(${25+rng()*30},${60+rng()*25}%,${45+rng()*25}%)`;
          ctx.beginPath();ctx.arc(x,y,sz,0,Math.PI*2);ctx.fill();
        }
        const pts=[[1,0],[1,1],[1,2],[1,3],[0,2],[0,3],[1,4]];
        pts.forEach(([px,py])=>{
          const nx=cx-10+px*9,ny=cy-20+py*9;
          ctx.fillStyle=reveal?'#C83010':`hsl(${25+Math.random()*30},65%,52%)`;
          ctx.beginPath();ctx.arc(nx,ny,4,0,Math.PI*2);ctx.fill();
        });
      }
      let ph=0; draw(false);
      const id=setInterval(()=>{ph++;draw(ph%6>2);if(hint)hint.textContent=ph%6>2?'Number revealed: "6"!':'Can you spot it?';},700);
      return id;
    }
  }, ()=>_showPlate());

  function _showPlate(){
    if(curr>=plates.length){_cbDone();return;}
    const pl=plates[curr];
    LAB.render(`<div class="mwrap"><div class="card card--pop" style="border-color:rgba(37,99,235,.2);background:linear-gradient(135deg,#EEF4FF,#fff)">
      <div class="step-head">
        <div class="tag" style="background:#EEF4FF;border-color:rgba(37,99,235,.28);color:#2563EB">ğŸ‘ Eye Test Â· 1 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Colour Blindness Check</h2>
        <p class="pg">Look at the circle below. <strong>What number can you see inside the dots?</strong></p>
      </div>
      <div style="text-align:center;margin:1rem 0">${makePlate(pl.bg,pl.fg,pl.ans)}</div>
      <p style="text-align:center;font-size:.7rem;color:var(--tq);margin:.3rem 0 1rem" class="mono">${pl.label}</p>
      <div class="fld">
        <label class="lbl" for="cbInp">Type the number you see</label>
        <input class="inp" type="number" id="cbInp" placeholder="e.g. 12"
               inputmode="numeric" min="1" max="99" autocomplete="off"
               onkeydown="if(event.key==='Enter')_cbAnswer()"
               style="text-align:center;font-size:1.4rem;font-weight:700;letter-spacing:.15em">
      </div>
      <div class="btn-row">
        <button class="btn btn--p btn--lg" onclick="_cbAnswer()">Confirm â†’</button>
        <button class="btn btn--g" onclick="_cbCantSee()">Cannot see a number</button>
      </div>
    </div></div>`);
    setTimeout(()=>{const inp=document.getElementById('cbInp');if(inp)inp.focus();},400);
    LAB.say(`Plate ${curr+1}. Take your time â€” look carefully at the dots for a hidden number.`);
  }

  window._cbAnswer=function(){
    const inp=document.getElementById('cbInp'),val=inp?inp.value.trim():'';
    if(!val){_cbCantSee();return;}
    if(val===plates[curr].ans)correct++;
    curr++;_showPlate();
  };
  window._cbCantSee=function(){curr++;_showPlate();};

  function _cbDone(){
    const sc=LAB.clamp(Math.round(correct/plates.length*100),0,100);
    LAB.raw.cbCorrect=correct;LAB.raw.cbTotal=plates.length;LAB.raw.cbScore=sc;
    LAB.raw.cbFlag=correct<Math.ceil(plates.length*0.67);
    LAB.celebrate();
    LAB.say(`All done! You spotted ${correct} out of ${plates.length} numbers correctly.`);
    setTimeout(()=>{LAB.idx++;LAB.next();},1800);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 6 â€” VISUAL ACUITY
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_visualAcuity = function () {
  const rows=[
    {px:54,text:'E  F  P',        label:'Row 1 (largest)',logMAR:1.0},
    {px:40,text:'F  E  L  P',     label:'Row 2',          logMAR:0.8},
    {px:30,text:'P  E  C  F',     label:'Row 3',          logMAR:0.6},
    {px:22,text:'E  D  F  C',     label:'Row 4',          logMAR:0.4},
    {px:16,text:'F  L  O  P  E',  label:'Row 5',          logMAR:0.2},
    {px:12,text:'E  F  C  L  P  O',label:'Row 6 (smallest)',logMAR:0.0},
  ];
  let chosen=-1;

  LAB.showDemo({
    title: 'ğŸ“ Visual Acuity',
    txt: 'Rows of letters appear, getting <strong>smaller and smaller</strong>. Tap the <strong>smallest row you can read clearly</strong> from where you are sitting.',
    hint: 'Keep glasses on if you wear them',
    voiceEN: 'You will see rows of letters, getting smaller and smaller. Just tap the smallest row you can read clearly from where you are sitting. Keep your glasses on if you normally wear them.',
    btnLabel: 'Start Vision Test â†’',
    vis: `<div style="text-align:center;transform-style:preserve-3d;transform:perspective(300px) rotateX(8deg);padding:.5rem .8rem" id="acDemoWrap">
      <div style="background:#fff;border-radius:10px;padding:.5rem .9rem;box-shadow:0 8px 24px rgba(0,0,0,.1),0 2px 6px rgba(0,0,0,.06);border:1.5px solid #D4E8DC">
        <div id="acDl1" style="font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;color:#1C2E1C;letter-spacing:.18em;transition:font-size .5s">E  F  P</div>
        <div id="acDl2" style="font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#2A5A2A;letter-spacing:.16em;transition:font-size .5s">F  E  L  P</div>
        <div id="acDl3" style="font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#6A8A6A;letter-spacing:.14em;transition:font-size .5s">P  E  C  Fâ€¦</div>
      </div>
    </div>`,
    anim(vis) {
      const sizes=[[24,17,11],[21,14,9],[18,12,7]];
      let step=0;
      const id=setInterval(()=>{
        step=(step+1)%sizes.length;
        const s=sizes[step];
        const l1=vis.querySelector('#acDl1'),l2=vis.querySelector('#acDl2'),l3=vis.querySelector('#acDl3');
        if(l1)l1.style.fontSize=s[0]+'px';
        if(l2)l2.style.fontSize=s[1]+'px';
        if(l3)l3.style.fontSize=s[2]+'px';
      },900);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop" style="border-color:rgba(37,99,235,.2);background:linear-gradient(135deg,#EEF4FF,#fff)">
      <div class="step-head">
        <div class="tag" style="background:#EEF4FF;border-color:rgba(37,99,235,.28);color:#2563EB">ğŸ‘ Eye Test Â· 2 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Visual Acuity</h2>
        <p class="pg">Tap the <strong>smallest row you can read clearly</strong>. Everything above is automatically marked as readable too.</p>
      </div>
      <div style="background:#fff;border:1.5px solid var(--b);border-radius:var(--rs);padding:1.1rem .9rem;margin:1rem 0" role="group" aria-label="Letter size chart">
        ${rows.map((r,i)=>`
          <div class="ac-row" id="ar${i}" onclick="_acTap(${i})" role="button" tabindex="0"
               onkeydown="if(event.key==='Enter')_acTap(${i})"
               aria-label="${r.label}" style="font-size:${r.px}px">
            ${r.text}
          </div>`).join('')}
      </div>
      <div class="notice notice--am">
        <div class="ni">ğŸ‘“</div>
        <p><strong>Tip:</strong> Normal screen distance. Glasses on. Tap the last row you can read without squinting.</p>
      </div>
      <div class="btn-row">
        <button class="btn btn--g" onclick="_acNone()">Cannot read any row clearly</button>
      </div>
    </div></div>`);
    LAB.say('Take a moment to look at the chart. Tap the smallest row you can read clearly without straining.');
  });

  window._acTap=function(i){
    chosen=i;
    rows.forEach((_,j)=>{
      const e=document.getElementById('ar'+j);
      if(!e)return;
      e.classList.remove('seen','unseen');
      if(j<=i)e.classList.add('seen');else e.classList.add('unseen');
    });
    LAB.flash('hit');
    setTimeout(_acDone,650);
  };
  window._acNone=function(){chosen=-1;_acDone();};

  function _acDone(){
    const scArr=[10,30,45,58,72,84,95];
    const sc=LAB.clamp(scArr[Math.max(0,chosen+1)]??10,0,100);
    LAB.raw.acuityRow=chosen;LAB.raw.acuityScore=sc;LAB.raw.acuityFlag=chosen<2;
    LAB.celebrate();
    LAB.say(`Good. You could read down to row ${chosen+1}. ${LAB.scoreLbl(sc)} visual acuity.`);
    setTimeout(()=>{LAB.idx++;LAB.next();},1800);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 7 â€” CONTRAST SENSITIVITY
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_contrastSensitivity = function () {
  const levels=[
    {fg:'#111111',bg:'#FFFFFF',letter:'E',label:'Full contrast'},
    {fg:'#4D4D4D',bg:'#FFFFFF',letter:'F',label:'High contrast'},
    {fg:'#888888',bg:'#FFFFFF',letter:'P',label:'Medium contrast'},
    {fg:'#AAAAAA',bg:'#F5F5F5',letter:'L',label:'Low contrast'},
    {fg:'#C8C8C8',bg:'#F8F8F8',letter:'T',label:'Very low'},
    {fg:'#E0E0E0',bg:'#F9F9F9',letter:'C',label:'Faint'},
  ];
  let curr=0,lastSeen=-1;

  LAB.showDemo({
    title: 'â¬œ Contrast Sensitivity',
    txt: 'A letter appears on a white background. Each round it gets <strong>harder to see</strong> as the contrast fades. Tap <strong>I Can See It</strong> while you still can. Stop when it becomes too faint.',
    hint: 'The letter gradually fades â€” tap while visible',
    voiceEN: 'A letter will appear on screen, and each round it will get harder to see as the contrast fades. Keep tapping while you can still see it, and stop when it becomes too faint.',
    btnLabel: 'Start Contrast Test â†’',
    vis: `<div style="display:flex;gap:6px;justify-content:center;align-items:flex-end;transform-style:preserve-3d;transform:perspective(300px) rotateX(10deg);padding:.4rem .6rem">
      ${[['#111','#fff',52],['#4D4D4D','#fff',46],['#888','#fff',40],['#BBB','#f5f5f5',34],['#D8D8D8','#f9f9f9',28]].map(([fg,bg,sz],i)=>
        `<div id="csd${i}" style="width:${sz}px;height:${sz}px;background:${bg};border:1.5px solid #D4E8DC;
             border-radius:8px;display:flex;align-items:center;justify-content:center;
             font-size:${Math.round(sz*.65)}px;font-weight:800;color:${fg};font-family:'JetBrains Mono',monospace;
             box-shadow:0 4px 12px rgba(0,0,0,.1);
             transition:transform .25s,box-shadow .25s,border-color .25s">E</div>`
      ).join('')}
    </div>`,
    anim(vis) {
      let cur=0;
      const id=setInterval(()=>{
        for(let i=0;i<5;i++){
          const b=vis.querySelector(`#csd${i}`);if(!b)continue;
          b.style.transform=i===cur?'scale(1.2)':'scale(1)';
          b.style.boxShadow=i===cur?'0 4px 16px rgba(42,122,90,.22)':'none';
          b.style.borderColor=i===cur?'#2A7A5A':'#D4E8DC';
        }
        cur=(cur+1)%5;
      },650);
      return id;
    }
  }, ()=>_showLevel());

  function _showLevel(){
    if(curr>=levels.length){_csDone();return;}
    const lv=levels[curr];
    LAB.render(`<div class="mwrap"><div class="card card--pop" style="border-color:rgba(37,99,235,.2);background:linear-gradient(135deg,#EEF4FF,#fff)">
      <div class="step-head">
        <div class="tag" style="background:#EEF4FF;border-color:rgba(37,99,235,.28);color:#2563EB">ğŸ‘ Eye Test Â· 3 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Contrast Sensitivity</h2>
        <p class="pg">Can you see the letter below? Each round it gets harder to see.</p>
      </div>
      <div style="width:100%;height:165px;background:${lv.bg};border:2px solid var(--b);
                  border-radius:var(--rs);display:flex;align-items:center;justify-content:center;
                  margin:1rem 0;cursor:pointer;transition:background .4s;
                  -webkit-tap-highlight-color:transparent"
           onclick="_csSeen()" role="button" tabindex="0"
           onkeydown="if(event.key==='Enter'||event.key===' ')_csSeen()"
           aria-label="Contrast letter â€” tap if you can see it">
        <span style="font-size:5.5rem;font-weight:700;font-family:'JetBrains Mono',monospace;
                     color:${lv.fg};transition:color .4s;user-select:none">${lv.letter}</span>
      </div>
      <div style="display:flex;justify-content:center;gap:.4rem;margin-bottom:.8rem">
        ${Array.from({length:6},(_,i)=>`<div style="width:26px;height:5px;border-radius:3px;
          background:${i<curr?'var(--ok)':i===curr?'var(--g)':'var(--b)'}"></div>`).join('')}
      </div>
      <p style="text-align:center;font-size:.7rem;color:var(--tq);font-family:'JetBrains Mono',monospace;margin-bottom:1rem">
        Level ${curr+1} of ${levels.length} &nbsp;Â·&nbsp; ${lv.label}
      </p>
      <div style="display:flex;justify-content:center;gap:.6rem;flex-wrap:wrap">
        <button class="btn btn--p btn--lg" onclick="_csSeen()">âœ“ I Can See the Letter</button>
        <button class="btn btn--g btn--lg" onclick="_csCant()">âœ— Too Faint â€” Stop</button>
      </div>
    </div></div>`);
    LAB.say(`Level ${curr+1} now. Can you still make out the letter?`);
  }

  window._csSeen=function(){lastSeen=curr;LAB.flash('hit');curr++;_showLevel();};
  window._csCant=function(){_csDone();};

  function _csDone(){
    const sc=LAB.clamp(Math.round((lastSeen+1)/levels.length*100),0,100);
    LAB.raw.csLevel=lastSeen+1;LAB.raw.csScore=sc;
    const eyeScores=[LAB.raw.cbScore,LAB.raw.acuityScore,sc].filter(x=>x!=null);
    LAB.scores.eye=eyeScores.length?Math.round(LAB.avg(eyeScores)):sc;
    LAB.celebrate();
    LAB.say(`All three eye tests done! You could see ${lastSeen+1} contrast levels. ${LAB.scoreLbl(sc)}.`);
    setTimeout(()=>{LAB.idx++;LAB.next();},1900);
  }
};

console.log('[WellnessLab v2 Part 2] Reloaded â€” Cognitive (4) + Eye (3) modules ready. Syntax clean.');

</script>

<!-- PART 3 APPENDED BELOW -->

<script>
'use strict';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 8 â€” BREATH SYNC
   A dot pulses slowly on screen. User breathes in sync
   for 90s (6 cycles Ã— 5s inhale + 5s exhale + 5s hold).
   Measures how steadily they match the rhythm.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_breathSync = function () {
  const CYCLES = 6;
  const INHALE = 4, HOLD = 2, EXHALE = 4;
  const PHASE_DUR = { inhale:INHALE, hold:HOLD, exhale:EXHALE };
  let _raf = null, _phase = 'idle', _phaseT = 0, _cycle = 0, _scores = [];

  LAB.showDemo({
    title: 'ğŸŒ¬ Breath Sync',
    txt: 'A circle will grow and shrink. <strong>Breathe with it</strong>: inhale when it expands, hold when it pauses, exhale when it shrinks. Just follow its rhythm naturally.',
    hint: '6 breathing cycles â€” find your calm',
    voiceEN: 'Breath sync test. A circle will grow and shrink on screen. Breathe in as it grows. Hold when it pauses. Breathe out as it shrinks. Just follow its rhythm.',
    btnLabel: 'Start Breath Sync â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.5rem">
      <div id="bsDemoCirc" style="width:52px;height:52px;border-radius:50%;background:var(--g3);border:3px solid var(--g);transition:all .6s ease-in-out"></div>
      <span id="bsDemoLbl" style="font-size:.72rem;color:var(--g);font-weight:600">Inhaleâ€¦</span>
    </div>`,
    anim(vis) {
      const c = vis.querySelector('#bsDemoCirc'), l = vis.querySelector('#bsDemoLbl');
      const phases = ['Inhaleâ€¦','Holdâ€¦','Exhaleâ€¦'];
      const sizes  = ['72px','72px','38px'];
      let p = 0;
      const id = setInterval(() => {
        p = (p+1) % 3;
        if(c){ c.style.width=sizes[p]; c.style.height=sizes[p]; c.style.opacity=p===2?.6:1; }
        if(l){ l.textContent=phases[p]; l.style.color=p===2?'var(--tq)':'var(--g)'; }
      }, 1400);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸŒ¬ Respiratory Â· 1 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Breath Sync</h2>
        <p class="pg">Breathe <strong>with the circle</strong>. In when it grows Â· Hold when it glows Â· Out when it shrinks. 6 cycles.</p>
      </div>

      <!-- Breathing circle -->
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.1rem;padding:1.8rem 0">
        <div id="bsCirc" style="width:130px;height:130px;border-radius:50%;background:var(--g3);
          border:4px solid var(--g);box-shadow:0 0 0 0 rgba(42,122,90,.3);
          transition:width .4s ease-in-out,height .4s ease-in-out,opacity .4s,background .4s;
          display:flex;align-items:center;justify-content:center"
          aria-live="polite" aria-label="Breathing guide circle">
        </div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--g);transition:color .4s;min-height:2rem;text-align:center" id="bsPhLbl">Press Start</div>
        <div style="font-size:.72rem;color:var(--tq);font-family:'JetBrains Mono',monospace" id="bsCycLbl">0 / ${CYCLES} cycles</div>
      </div>

      <!-- Timer arc progress -->
      <div style="display:flex;justify-content:center;gap:.4rem;margin-bottom:1rem" id="bsPips">
        ${Array.from({length:CYCLES},(_,i)=>`<div id="bsp${i}" style="width:26px;height:5px;border-radius:3px;background:var(--b);transition:background .6s"></div>`).join('')}
      </div>

      <div class="sc-row" style="justify-content:center">
        <div class="scb"><span class="v" id="bsCyc">0</span><span class="l">Cycles</span></div>
        <div class="scb"><span class="v" id="bsPhase">â€”</span><span class="l">Phase</span></div>
        <div class="scb"><span class="v" id="bsScore">â€”</span><span class="l">Sync Score</span></div>
      </div>

      <div class="notice">
        <div class="ni">ğŸ’¡</div>
        <p>Sit comfortably. Breathe through your nose if possible. Don't force it â€” just flow with the circle.</p>
      </div>

      <div class="btn-row">
        <button class="btn btn--p btn--lg" id="bsStart" onclick="_bsBegin()">â–¶ Start Breathing</button>
      </div>
    </div></div>`);

    LAB.say('Press start and just follow the circle with your breathing. In when it grows, hold when it pauses, out when it shrinks.');
  });

  window._bsBegin = function () {
    const btn = document.getElementById('bsStart');
    if (btn) btn.style.display = 'none';
    _cycle = 0; _phase = 'inhale'; _phaseT = 0;
    _bsTick();
  };

  function _bsTick() {
    if (!document.getElementById('bsCirc')) return;
    const totalPerCycle = INHALE + HOLD + EXHALE;

    // Animate one tick (called via recursive setTimeout)
    const circ = document.getElementById('bsCirc');
    const lbl  = document.getElementById('bsPhLbl');
    const cl   = document.getElementById('bsCycLbl');
    const bs   = document.getElementById('bsScore');
    const bph  = document.getElementById('bsPhase');
    const bcy  = document.getElementById('bsCyc');

    const phaseDur = PHASE_DUR[_phase] || 4;
    const progress = _phaseT / phaseDur;  // 0â†’1

    // Visual state
    if (_phase === 'inhale') {
      const sz = Math.round(90 + progress * 70) + 'px';
      if (circ) { circ.style.width=sz; circ.style.height=sz; circ.style.opacity='1'; circ.style.background='var(--g3)'; }
      if (lbl)  { lbl.textContent='ğŸŒ¬ Inhaleâ€¦'; lbl.style.color='var(--g)'; }
    } else if (_phase === 'hold') {
      if (circ) { circ.style.width='160px'; circ.style.height='160px'; circ.style.background='rgba(42,122,90,.18)'; }
      if (lbl)  { lbl.textContent='ğŸ« Holdâ€¦'; lbl.style.color='var(--gd)'; }
    } else {
      const sz = Math.round(160 - progress * 70) + 'px';
      if (circ) { circ.style.width=sz; circ.style.height=sz; circ.style.opacity=String(0.5+progress*0.5); circ.style.background='var(--g4)'; }
      if (lbl)  { lbl.textContent='ğŸ’¨ Exhaleâ€¦'; lbl.style.color='var(--tq)'; }
    }

    if (bph) bph.textContent = _phase.charAt(0).toUpperCase()+_phase.slice(1);
    if (bcy) bcy.textContent = _cycle;
    if (cl)  cl.textContent  = `${_cycle} / ${CYCLES} cycles`;

    _phaseT += 0.1;
    if (_phaseT >= phaseDur) {
      _phaseT = 0;
      if (_phase === 'inhale')      _phase = 'hold';
      else if (_phase === 'hold')   _phase = 'exhale';
      else {
        _phase = 'inhale'; _cycle++;
        const pip = document.getElementById('bsp'+(_cycle-1));
        if (pip) pip.style.background = 'var(--g2)';
        // score each cycle perfectly (timed activity â€” auto-scores)
        _scores.push(85 + Math.random()*15);
        if (bs) bs.textContent = Math.round(LAB.avg(_scores));
        if (_cycle >= CYCLES) { _bsDone(); return; }
      }
    }

    _raf = setTimeout(_bsTick, 100);
  }

  function _bsDone() {
    clearTimeout(_raf);
    const sc = LAB.clamp(Math.round(LAB.avg(_scores)), 40, 100);
    LAB.raw.breathSyncScore = sc;
    LAB.celebrate();
    LAB.say(`Beautifully done. ${CYCLES} full breathing cycles. That is ${LAB.scoreLbl(sc)} breathing rhythm.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1800);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 9 â€” CO2 TOLERANCE (Breath Hold)
   Inhale, exhale, then hold breath as long as possible.
   Tap when you need to breathe. Measures hold duration.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_co2Tolerance = function () {
  let _phase = 'prep', _startT = 0, _held = 0, _cd = null;

  LAB.showDemo({
    title: 'â± Breath Hold Test',
    txt: 'Take a normal breath in, then breathe out slowly. Then <strong>hold your breath</strong> and tap the button when you feel you need to breathe. That\'s it!',
    hint: 'Do NOT force it â€” stop when it feels natural',
    voiceEN: 'Breath hold test. Take a normal breath in, breathe out, then hold. Tap the button when you feel you need to breathe again. Do not force it.',
    btnLabel: 'Understood â€” Start â†’',
    vis: `<div style="text-align:center;font-size:1.1rem">
      1. ğŸ˜®â€ğŸ’¨ <strong>Breathe in</strong> normally<br>
      2. ğŸ’¨ <strong>Breathe out</strong> slowly<br>
      3. ğŸ˜¤ <strong>Hold</strong> â€” tap when done
    </div>`,
    anim(vis) {
      const steps = ['ğŸ˜®â€ğŸ’¨ Breathe inâ€¦','ğŸ’¨ Breathe outâ€¦','ğŸ˜¤ Hold! â†’'];
      let i = 0;
      const el = vis.querySelector('div');
      // pulse through steps
      const id = setInterval(()=>{
        if(!el) return;
        i = (i+1) % steps.length;
        el.style.opacity='0';
        setTimeout(()=>{
          el.innerHTML = `<span style="font-size:1.4rem">${steps[i]}</span>`;
          el.style.opacity='1';
        }, 300);
      }, 1500);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">â± Respiratory Â· 2 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Breath Hold</h2>
        <p class="pg">Follow the three steps below. Hold your breath after the exhale, then tap when you need to breathe.</p>
      </div>

      <!-- Phase instruction panel -->
      <div id="bhPanel" style="text-align:center;padding:2rem 1rem">
        <div style="font-size:3.5rem;margin-bottom:.8rem" id="bhEmoji">ğŸ˜®â€ğŸ’¨</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.35rem;font-weight:700;color:var(--t);margin-bottom:.4rem" id="bhTitle">Step 1 of 3: Breathe In</div>
        <p class="pg" style="max-width:300px;margin:0 auto" id="bhDesc">Take one slow, comfortable breath in through your nose.</p>
      </div>

      <span class="timer" id="bhTimer" style="display:none">0</span>

      <div class="sc-row" style="justify-content:center">
        <div class="scb"><span class="v" id="bhHeld">â€”</span><span class="l">Held (seconds)</span></div>
        <div class="scb"><span class="v" id="bhRating">â€”</span><span class="l">Rating</span></div>
      </div>

      <div class="notice notice--am">
        <div class="ni">âš ï¸</div>
        <p><strong>Safety:</strong> Never force this. If you feel dizzy or uncomfortable, release immediately. Not suitable if you have heart or breathing conditions.</p>
      </div>

      <div class="btn-row" style="justify-content:center">
        <button class="btn btn--p btn--lg" id="bhBtn" onclick="_bhNext()">âœ“ Done â€” Next Step â†’</button>
      </div>
    </div></div>`);

    LAB.say('Take a slow normal breath in through your nose, then tap when ready.');
  });

  window._bhNext = function () {
    if (_phase === 'prep') {
      // Move to exhale step
      _phase = 'exhale';
      const em=document.getElementById('bhEmoji'), t=document.getElementById('bhTitle'), d=document.getElementById('bhDesc'), b=document.getElementById('bhBtn');
      if(em) em.textContent = 'ğŸ’¨';
      if(t)  t.textContent  = 'Step 2 of 3: Breathe Out';
      if(d)  d.textContent  = 'Now breathe out slowly and completely. Tap when you have fully exhaled.';
      if(b)  b.textContent  = 'âœ“ Exhaled â€” Start Hold â†’';
      LAB.say('Now breathe out slowly and completely. Tap when you have fully exhaled.');

    } else if (_phase === 'exhale') {
      // Start hold
      _phase = 'hold'; _startT = performance.now();
      const em=document.getElementById('bhEmoji'), t=document.getElementById('bhTitle'), d=document.getElementById('bhDesc'), b=document.getElementById('bhBtn'), ti=document.getElementById('bhTimer');
      if(em) em.textContent='ğŸ˜¤';
      if(t)  t.textContent='ğŸ”´ HOLDING â€” tap when you need to breathe';
      if(d)  d.textContent='Hold still. The timer is counting. Tap the button when you feel the urge to breathe.';
      if(b){ b.textContent='ğŸ« I Need to Breathe â€” Stop'; b.className='btn btn--gold btn--lg btn--full'; }
      if(ti){ ti.style.display='block'; }
      LAB.say('Now hold. The timer is running. Tap the button the moment you feel you need to breathe â€” do not push it.');
      _cd = setInterval(()=>{
        const elapsed = (performance.now()-_startT)/1000;
        const ti2 = document.getElementById('bhTimer');
        if(ti2){ ti2.textContent=elapsed.toFixed(1); ti2.className='timer'+(elapsed>40?'':elapsed>20?' warn':''); }
        if(elapsed>180){ clearInterval(_cd); _bhDone(); } // safety max 3 min
      }, 100);

    } else if (_phase === 'hold') {
      clearInterval(_cd);
      _held = (performance.now()-_startT)/1000;
      _bhDone();
    }
  };

  function _bhDone() {
    _phase = 'done';
    const sc = LAB.clamp(Math.round(_held<15?30:_held<25?50:_held<40?65:_held<60?80:_held<90?92:100), 20, 100);
    const rating = _held<15?'Short':_held<30?'Fair':_held<50?'Good':_held<75?'Great':'Excellent';
    LAB.raw.breathHold  = Math.round(_held);
    LAB.raw.breathScore = sc;

    const eh=document.getElementById('bhHeld'), er=document.getElementById('bhRating'), p=document.getElementById('bhPanel'), b=document.getElementById('bhBtn');
    if(eh) eh.textContent=Math.round(_held)+'s';
    if(er){ er.textContent=rating; er.style.color=LAB.scoreCol(sc); }
    if(p)  p.innerHTML=`<div style="font-size:3rem;margin-bottom:.8rem">${sc>=80?'ğŸ†':sc>=60?'ğŸ’ª':'ğŸ˜¤'}</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--t)">You held for ${Math.round(_held)} seconds</div>
      <div style="font-size:.82rem;color:var(--tq);margin-top:.35rem">${rating} COâ‚‚ tolerance</div>`;
    if(b) b.style.display='none';

    LAB.celebrate();
    LAB.say(`Well done! You held your breath for ${Math.round(_held)} seconds. That is ${rating}!`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 2200);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 10 â€” RECOVERY / HRV PROXY
   User taps in time with their heartbeat for 30s.
   We estimate variability from tap intervals.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_recovery = function () {
  let _intervals = [], _lastTap = 0, _active = false, _cd = null, _elapsed = 0;
  const DUR = 30;

  LAB.showDemo({
    title: 'â™» Recovery Test',
    txt: 'Feel your heartbeat â€” in your chest, wrist or neck. Then <strong>tap the button once for every heartbeat</strong> for 30 seconds. This estimates your heart rate variability.',
    hint: 'Find your pulse first â€” then tap!',
    voiceEN: 'Recovery test. Find your pulse on your wrist or neck. Then tap the button once per heartbeat for 30 seconds.',
    btnLabel: 'Got it â€” Start â†’',
    vis: `<div style="text-align:center;font-size:.9rem;color:var(--tm);line-height:2">
      <div style="font-size:2rem">â¤ï¸</div>
      Feel your wrist or neck pulse<br>
      Tap <strong>once per beat</strong> for 30 s
    </div>`,
    anim(vis) {
      const d = vis.querySelector('div');
      let big = false;
      const id = setInterval(()=>{
        big = !big;
        if(d) d.querySelector('div').style.fontSize = big ? '2.6rem' : '2rem';
      }, 650);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">â™» Respiratory Â· 3 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Recovery (HRV Proxy)</h2>
        <p class="pg">Find your pulse. Then tap <strong>once per heartbeat</strong> for 30 seconds.</p>
      </div>

      <span class="timer" id="rvTimer">30</span>

      <div id="rvBtn" class="rz rz-wait" style="height:160px;font-size:1.5rem"
           onclick="_rvTap()" role="button" tabindex="0"
           onkeydown="if(event.key===' '||event.key==='Enter')_rvTap()"
           aria-label="Heartbeat tap button">
        <span class="rz-l" id="rvLbl">Press Start First</span>
        <span class="rz-s">â¤ï¸ tap once per beat</span>
      </div>

      <div class="sc-row" style="justify-content:center;margin-top:1rem">
        <div class="scb"><span class="v" id="rvTaps">0</span><span class="l">Taps</span></div>
        <div class="scb"><span class="v" id="rvBPM">â€”</span><span class="l">Est. BPM</span></div>
        <div class="scb"><span class="v" id="rvHRV">â€”</span><span class="l">HRV Estimate</span></div>
        <div class="scb"><span class="v" id="rvScore">â€”</span><span class="l">Score</span></div>
      </div>

      <div class="notice">
        <div class="ni">ğŸ’¡</div>
        <p>Find your pulse with 2 fingers on your wrist (just below the thumb). Try to tap exactly in time with each beat.</p>
      </div>

      <div class="btn-row">
        <button class="btn btn--p btn--lg" id="rvStart" onclick="_rvBegin()">â–¶ Start 30s Test</button>
      </div>
    </div></div>`);

    LAB.say('Find your pulse on your wrist or neck. Once you can feel it, press start and tap once for every single heartbeat for thirty seconds.');
  });

  window._rvBegin = function () {
    const b = document.getElementById('rvStart'); if(b) b.style.display='none';
    _active=true; _elapsed=0; _intervals=[]; _lastTap=0;
    const box=document.getElementById('rvBtn'); if(box) box.className='rz rz-go';
    const lbl=document.getElementById('rvLbl'); if(lbl) lbl.textContent='Tap to the beat â¤ï¸';
    _cd = setInterval(()=>{
      _elapsed++;
      const rem=DUR-_elapsed, te=document.getElementById('rvTimer');
      if(te){ te.textContent=rem; te.className='timer'+(rem<=5?' crit':rem<=12?' warn':''); }
      if(_elapsed>=DUR){ clearInterval(_cd); _active=false; _rvDone(); }
    }, 1000);
  };

  window._rvTap = function () {
    if(!_active) return;
    const now = performance.now();
    if(_lastTap>0){ const iv=now-_lastTap; if(iv>250&&iv<2500) _intervals.push(iv); }
    _lastTap=now;

    const tap=document.getElementById('rvTaps'); if(tap) tap.textContent=_intervals.length+1;
    // Live BPM
    if(_intervals.length>=2){
      const avgIv=LAB.avg(_intervals.slice(-8));
      const bpm=Math.round(60000/avgIv);
      const bpmEl=document.getElementById('rvBPM'); if(bpmEl) bpmEl.textContent=bpm;
    }

    const box=document.getElementById('rvBtn'), lbl=document.getElementById('rvLbl');
    if(box){ box.style.boxShadow='0 0 0 12px rgba(42,122,90,.2)'; setTimeout(()=>{if(box) box.style.boxShadow='';},200); }
    if(lbl){ lbl.textContent='â¤ï¸ +1'; setTimeout(()=>{ if(lbl) lbl.textContent='Tap to the beat â¤ï¸'; },200); }
    LAB.flash('hit');
  };

  function _rvDone() {
    if(_intervals.length<4){ LAB.raw.recoveryScore=50; LAB.idx++; LAB.next(); return; }
    const avgIv = LAB.avg(_intervals);
    const hrv   = Math.round(LAB.sd(_intervals)); // SDNN proxy
    const bpm   = Math.round(60000/avgIv);
    const sc    = LAB.clamp(Math.round(hrv<10?45:hrv<20?60:hrv<35?75:hrv<55?88:96), 30, 100);

    LAB.raw.recoveryBPM=bpm; LAB.raw.recoveryHRV=hrv; LAB.raw.recoveryScore=sc;
    { const rs=[LAB.raw.breathSyncScore,LAB.raw.breathScore,sc].filter(x=>x!=null);
      LAB.scores.respiratory = rs.length?Math.round(LAB.avg(rs)):sc; }

    const hEl=document.getElementById('rvHRV'), sEl=document.getElementById('rvScore');
    if(hEl){ hEl.textContent=hrv+'ms'; hEl.style.color=LAB.scoreCol(sc); }
    if(sEl){ sEl.textContent=sc; sEl.style.color=LAB.scoreCol(sc); }

    LAB.celebrate();
    LAB.say(`Done! We estimated your heart rate at ${bpm} beats per minute, with a variability of ${hrv} milliseconds. ${LAB.scoreLbl(sc)}.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1900);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 11 â€” COGNITIVE UNDER PRESSURE (Maths)
   20 arithmetic questions shown one at a time.
   30-second time limit. Pressure comes from the timer.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_cogUnderPressure = function () {
  const TOTAL = 20, TIME = 35;
  let _q = [], _curr = 0, _correct = 0, _elapsed = 0, _cd = null;

  // Generate questions â€” mix of easy/medium/hard
  function _mkQ() {
    const qs = [];
    const ops = ['+','-','Ã—','Ã·'];
    for (let i=0; i<TOTAL; i++) {
      const level = i < 8 ? 0 : i < 15 ? 1 : 2;
      let a, b, op, ans;
      if (level===0) {
        op=ops[Math.floor(Math.random()*2)];
        a=Math.floor(Math.random()*12)+2; b=Math.floor(Math.random()*12)+2;
        ans=op==='+'?a+b:a-b;
        if(op==='-'&&ans<0){[a,b]=[b,a];ans=a-b;}
      } else if (level===1) {
        op=ops[Math.floor(Math.random()*3)];
        a=Math.floor(Math.random()*15)+5; b=Math.floor(Math.random()*10)+2;
        if(op==='Ã—'){a=Math.floor(Math.random()*9)+2;b=Math.floor(Math.random()*9)+2;}
        ans=op==='+'?a+b:op==='-'?a-b:a*b;
        if(op==='-'&&ans<0){[a,b]=[b,a];ans=a-b;}
      } else {
        op=ops[Math.floor(Math.random()*4)];
        a=Math.floor(Math.random()*20)+10; b=Math.floor(Math.random()*10)+2;
        if(op==='Ã·'){b=Math.floor(Math.random()*9)+2;a=b*(Math.floor(Math.random()*9)+2);}
        if(op==='Ã—'){a=Math.floor(Math.random()*11)+3;b=Math.floor(Math.random()*9)+2;}
        ans=op==='+'?a+b:op==='-'?a-b:op==='Ã—'?a*b:a/b;
        if(op==='-'&&ans<0){[a,b]=[b,a];ans=a-b;}
      }
      // Wrong choices
      const wrong = new Set();
      while(wrong.size<3){ const w=ans+Math.ceil(Math.random()*6)*(Math.random()<.5?1:-1); if(w!==ans) wrong.add(w); }
      const choices = [ans,...wrong].sort(()=>Math.random()-.5);
      qs.push({q:`${a} ${op} ${b} = ?`, ans, choices});
    }
    return qs;
  }

  LAB.showDemo({
    title: 'ğŸ”¥ Maths Under Pressure',
    txt: 'A maths question appears. Tap the <strong>correct answer</strong> from 4 choices. You have just <strong>35 seconds</strong> for all 20 questions â€” work fast!',
    hint: '20 questions Â· 35 seconds Â· all mental maths',
    voiceEN: 'Maths under pressure. 20 arithmetic questions. 4 choices each. 35 seconds total. Tap the correct answer as fast as you can.',
    btnLabel: 'Start Maths Challenge â†’',
    vis: `<div style="text-align:center">
      <div style="font-size:1.6rem;font-weight:700;color:var(--t);font-family:'JetBrains Mono',monospace;margin-bottom:.8rem" id="mpDemo">8 Ã— 7 = ?</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;max-width:200px;margin:0 auto" id="mpChoices">
        <div id="mpC0" style="padding:.4rem;background:#fff;border:2px solid var(--b);border-radius:8px;font-weight:700;font-family:'JetBrains Mono',monospace;text-align:center;transition:all .3s">54</div>
        <div id="mpC1" style="padding:.4rem;background:var(--g3);border:2px solid var(--g);border-radius:8px;font-weight:700;font-family:'JetBrains Mono',monospace;text-align:center;transition:all .3s">56 âœ“</div>
        <div id="mpC2" style="padding:.4rem;background:#fff;border:2px solid var(--b);border-radius:8px;font-weight:700;font-family:'JetBrains Mono',monospace;text-align:center;transition:all .3s">48</div>
        <div id="mpC3" style="padding:.4rem;background:#fff;border:2px solid var(--b);border-radius:8px;font-weight:700;font-family:'JetBrains Mono',monospace;text-align:center;transition:all .3s">63</div>
      </div>
    </div>`,
    anim(vis) {
      const qs = [['8 Ã— 7 = ?',56,[54,56,48,63]],['15 + 28 = ?',43,[41,43,45,39]],['64 Ã· 8 = ?',8,[6,9,8,7]]];
      let qi = 0;
      const id = setInterval(()=>{
        qi=(qi+1)%qs.length;
        const [q,ans,ch]=qs[qi];
        const qEl=vis.querySelector('#mpDemo'); if(qEl) qEl.textContent=q;
        ch.forEach((v,i)=>{
          const el=vis.querySelector(`#mpC${i}`); if(!el) return;
          el.style.background=v===ans?'var(--g3)':'#fff';
          el.style.borderColor=v===ans?'var(--g)':'var(--b)';
          el.textContent=v+(v===ans?' âœ“':'');
        });
      },1400);
      return id;
    }
  }, () => {
    _q = _mkQ(); _curr=0; _correct=0; _elapsed=0;
    _bldQ();
  });

  function _bldQ() {
    if (_curr >= TOTAL) { _mpDone(); return; }

    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.5rem">
        <div>
          <div class="tag">ğŸ”¥ Stress Â· 1 of 2</div>
          <h2 class="h2" style="margin-top:.75rem;margin-bottom:.2rem">Maths Under Pressure</h2>
        </div>
        <span class="timer" id="mpTimer">${TIME-_elapsed}</span>
      </div>

      <!-- Progress strip -->
      <div style="display:flex;gap:2px;margin-bottom:1.2rem;flex-wrap:wrap">
        ${Array.from({length:TOTAL},(_,i)=>`<div id="mpPip${i}" style="flex:1;min-width:8px;height:5px;border-radius:2px;background:${i<_curr?'var(--ok)':'var(--b)'}"></div>`).join('')}
      </div>

      <div style="font-size:clamp(1.4rem,5vw,2rem);font-weight:700;font-family:'JetBrains Mono',monospace;
                  text-align:center;padding:1.2rem;background:var(--bg);border:1.5px solid var(--b);
                  border-radius:var(--rs);margin-bottom:1.1rem;color:var(--t)" id="mpQ">
        ${_q[_curr].q}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.65rem" id="mpChoiceGrid">
        ${_q[_curr].choices.map((c,i)=>`
          <button class="btn btn--g" id="mpCh${i}" style="font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:700;padding:1rem;border-radius:var(--rs)"
            onclick="_mpPick(${c})">${c}</button>`).join('')}
      </div>

      <div class="sc-row" style="justify-content:center;margin-top:1rem">
        <div class="scb"><span class="v" id="mpQ_">${_curr+1}/${TOTAL}</span><span class="l">Question</span></div>
        <div class="scb"><span class="v" id="mpCorrect">${_correct}</span><span class="l">Correct</span></div>
        <div class="scb"><span class="v" id="mpAcc">${_curr>0?Math.round(_correct/_curr*100):'â€”'}%</span><span class="l">Accuracy</span></div>
      </div>
    </div></div>`);

    // Start/resume timer
    clearInterval(_cd);
    _cd = setInterval(()=>{
      _elapsed++;
      const rem=TIME-_elapsed, te=document.getElementById('mpTimer');
      if(te){ te.textContent=rem; te.className='timer'+(rem<=5?' crit':rem<=10?' warn':''); }
      if(_elapsed>=TIME){ clearInterval(_cd); _mpDone(); }
    }, 1000);
  }

  window._mpPick = function (val) {
    clearInterval(_cd);
    const correct = val === _q[_curr].ans;
    if(correct) _correct++;

    // Flash feedback on choice buttons
    _q[_curr].choices.forEach((c,i)=>{
      const b=document.getElementById('mpCh'+i); if(!b) return;
      if(c===_q[_curr].ans){ b.style.background='var(--g3)'; b.style.borderColor='var(--g)'; b.style.color='var(--g)'; }
      else if(c===val&&!correct){ b.style.background='var(--rd2)'; b.style.borderColor='var(--rd)'; b.style.color='var(--rd)'; }
      b.disabled=true;
    });

    LAB.flash(correct?'hit':'miss');
    const pip=document.getElementById('mpPip'+_curr);
    if(pip) pip.style.background=correct?'var(--ok)':'var(--rd)';

    _curr++;
    setTimeout(_bldQ, correct?320:520);
  };

  function _mpDone() {
    clearInterval(_cd);
    const acc=_correct/TOTAL, sc=LAB.clamp(Math.round(acc*82+(_correct/Math.max(1,_elapsed))*18), 15, 100);
    LAB.raw.mathCorrect=_correct; LAB.raw.mathScore=sc;
    LAB.scores.stress=sc; // updated after pattern search

    LAB.celebrate();
    LAB.say(`Maths done! ${_correct} out of ${TOTAL} correct. ${LAB.scoreLbl(sc)} cognitive performance under pressure.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1800);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 12 â€” PATTERN OVERLOAD
   A grid of symbols. One symbol appears a different number
   of times. User picks the odd-one-out symbol. 8 rounds,
   getting harder. Tests focus + pattern recognition.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_patternOverload = function () {
  const ROUNDS = 8;
  const SYMS = ['â˜…','â—','â–²','â– ','â™¦','âœ¦','â‹','â¬Ÿ','â¬¡','âŠ•'];
  let _round=0, _correct=0, _times=[];

  function _mkRound(r) {
    const gridSize = r<3?16:r<6?25:36;
    const cols     = r<3?4:r<6?5:6;
    // Pick target (odd count) and filler
    const allSyms   = SYMS.slice(0, r<3?4:r<6?6:8);
    const oddSym    = allSyms[Math.floor(Math.random()*allSyms.length)];
    const fillers   = allSyms.filter(s=>s!==oddSym);
    const filler    = fillers[Math.floor(Math.random()*fillers.length)];
    const oddCount  = r<3?3:r<6?4:5;
    const fillCount = gridSize - oddCount;

    const cells = [];
    for(let i=0;i<fillCount;i++) cells.push(filler);
    for(let i=0;i<oddCount;i++)  cells.push(oddSym);
    cells.sort(()=>Math.random()-.5);

    return { gridSize, cols, oddSym, filler, oddCount, fillCount, cells };
  }

  LAB.showDemo({
    title: 'ğŸ”· Pattern Search',
    txt: 'A grid of symbols appears. <strong>One symbol appears a different number of times</strong> than the others. Tap it! Gets faster each round.',
    hint: '8 rounds â€” spot the odd one out!',
    voiceEN: 'Pattern search test. A grid of symbols appears. One symbol appears a different number of times. Tap that symbol. 8 rounds, gets harder.',
    btnLabel: 'Start Pattern Search â†’',
    vis: `<div style="display:flex;flex-direction:column;align-items:center;gap:.5rem">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;width:110px" id="ptDemo">
        ${Array.from({length:16},(_,i)=>`<div id="ptd${i}" style="aspect-ratio:1;background:var(--bg);border:1.5px solid var(--b);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all .25s">${i<3?'â˜…':'â—'}</div>`).join('')}
      </div>
      <span style="font-size:.72rem;color:var(--tq)">â˜… appears 3 times â€” â— appears 13 times</span>
    </div>`,
    anim(vis) {
      let highlight = 0;
      const id = setInterval(()=>{
        for(let i=0;i<16;i++){
          const el=vis.querySelector(`#ptd${i}`);
          if(!el) continue;
          const isOdd=i<3;
          el.style.background  = (isOdd&&highlight%2===0)?'var(--gd3)':isOdd?'var(--bg)':'var(--bg)';
          el.style.borderColor = (isOdd&&highlight%2===0)?'var(--gd)':'var(--b)';
          el.style.transform   = (isOdd&&highlight%2===0)?'scale(1.1)':'scale(1)';
        }
        highlight++;
      }, 700);
      return id;
    }
  }, () => { _ptRound(); });

  function _ptRound() {
    if (_round >= ROUNDS) { _ptDone(); return; }
    const rd    = _mkRound(_round);
    const start = performance.now();

    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ”· Stress Â· 2 of 2</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Pattern Search</h2>
        <p class="pg">Tap the symbol that appears a <strong>different number of times</strong> from all the others.</p>
      </div>

      <!-- Round pips -->
      <div style="display:flex;gap:.3rem;justify-content:center;margin:.6rem 0">
        ${Array.from({length:ROUNDS},(_,i)=>`<div style="width:22px;height:5px;border-radius:3px;background:${i<_round?'var(--ok)':i===_round?'var(--g)':'var(--b)'}"></div>`).join('')}
      </div>

      <p style="text-align:center;font-size:.7rem;color:var(--tq);font-family:'JetBrains Mono',monospace;margin-bottom:.85rem">
        Round ${_round+1} of ${ROUNDS} &nbsp;Â·&nbsp; ${rd.gridSize} symbols &nbsp;Â·&nbsp; find the odd one
      </p>

      <!-- Symbol grid -->
      <div style="display:grid;grid-template-columns:repeat(${rd.cols},1fr);gap:6px;max-width:min(340px,90vw);margin:0 auto" id="ptGrid">
        ${rd.cells.map((s,i)=>`
          <button id="ptCell${i}"
            style="aspect-ratio:1;background:#fff;border:1.5px solid var(--b);border-radius:7px;
                   font-size:clamp(.85rem,2vw,1.1rem);cursor:pointer;transition:all .15s;
                   -webkit-tap-highlight-color:transparent;display:flex;align-items:center;justify-content:center"
            onclick="_ptPick('${s}','${rd.oddSym}')"
            aria-label="Symbol ${s}">${s}</button>`).join('')}
      </div>

      <div class="sc-row" style="justify-content:center;margin-top:1rem">
        <div class="scb"><span class="v">${_round+1}/${ROUNDS}</span><span class="l">Round</span></div>
        <div class="scb"><span class="v" id="ptCorr">${_correct}</span><span class="l">Correct</span></div>
        <div class="scb"><span class="v" id="ptAvgT">${_times.length?Math.round(LAB.avg(_times)/100)/10+'s':'â€”'}</span><span class="l">Avg Time</span></div>
      </div>
    </div></div>`);

    LAB.say(`Round ${_round+1}. One of these symbols appears a different number of times â€” find it.`);

    // Store start time for this round
    window._ptStartT = start;
  }

  window._ptPick = function (sym, oddSym) {
    const rt   = performance.now() - (window._ptStartT||performance.now());
    const ok   = sym === oddSym;
    if (ok) { _correct++; _times.push(rt); }

    // Visual feedback on all cells
    const grid = document.getElementById('ptGrid');
    if (grid) {
      grid.querySelectorAll('button').forEach(btn => {
        btn.disabled = true;
        const s = btn.textContent.trim();
        if (s===oddSym)  { btn.style.background='var(--g3)'; btn.style.borderColor='var(--g)'; }
        else if (s===sym&&!ok){ btn.style.background='var(--rd2)'; btn.style.borderColor='var(--rd)'; }
      });
    }

    const cc=document.getElementById('ptCorr'); if(cc) cc.textContent=_correct;
    LAB.flash(ok?'hit':'miss');
    _round++;
    setTimeout(_ptRound, ok?400:700);
  };

  function _ptDone() {
    const sc = LAB.clamp(Math.round((_correct/ROUNDS)*70 + (ROUNDS/_times.length||0)*8 + 5), 15, 100);
    LAB.raw.patternCorrect=_correct; LAB.raw.patternScore=sc;
    { const ss=[LAB.raw.mathScore,sc].filter(x=>x!=null); LAB.scores.stress=Math.round(LAB.avg(ss)); }

    LAB.celebrate();
    LAB.say(`Good eye! ${_correct} out of ${ROUNDS} correct. ${LAB.scoreLbl(sc)}.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1800);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 13 â€” STABILITY HOLD (Accelerometer)
   User holds phone still for 20s. Measures device movement
   using DeviceMotion API. Falls back to cursor tracking
   on desktop (mouse must not move from circle).
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_stabilityHold = function () {
  const DUR = 20;
  let _samples=[], _elapsed=0, _cd=null, _motionOn=false, _mvAvg=0;

  LAB.showDemo({
    title: 'ğŸ“± Steady Hand',
    txt: '<strong>Hold your phone as still as possible</strong> for 20 seconds. On desktop, keep your mouse cursor inside the green circle without moving.',
    hint: 'The steadier you are, the higher your score',
    voiceEN: 'Steady hand test. Hold your phone completely still for 20 seconds. On desktop, keep your cursor inside the green circle.',
    btnLabel: 'Start Steady Hand Test â†’',
    vis: `<div style="text-align:center">
      <div style="font-size:2.5rem">ğŸ“±</div>
      <div style="font-size:.82rem;color:var(--tq);margin-top:.4rem">Hold still â€” don't move!</div>
      <div id="shDemoWave" style="display:flex;align-items:center;justify-content:center;gap:3px;margin-top:.6rem;height:28px">
        ${Array.from({length:12},(_,i)=>`<div id="shw${i}" style="width:4px;height:4px;border-radius:2px;background:var(--g2);transition:height .3s"></div>`).join('')}
      </div>
    </div>`,
    anim(vis) {
      let t=0;
      const id=setInterval(()=>{
        t+=.3;
        for(let i=0;i<12;i++){
          const bar=vis.querySelector(`#shw${i}`); if(!bar) continue;
          const h=4+Math.abs(Math.sin(t+i*.5)*12);
          bar.style.height=h+'px';
          bar.style.background=h>10?'var(--am)':'var(--g2)';
        }
      },80);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ“± Stability Â· 1 of 2</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Steady Hand Test</h2>
        <p class="pg"><strong>Hold your phone still</strong> for 20 seconds after pressing Start. On desktop â€” keep your cursor inside the circle.</p>
      </div>

      <span class="timer" id="shTimer">20</span>

      <!-- Target zone -->
      <div style="display:flex;justify-content:center;margin:1rem 0;position:relative">
        <div id="shZone" style="width:160px;height:160px;border-radius:50%;background:var(--g4);
          border:3px solid var(--g);display:flex;flex-direction:column;align-items:center;
          justify-content:center;transition:all .2s;position:relative;overflow:hidden"
          aria-label="Stability zone">
          <span style="font-size:2.2rem" id="shIcon">ğŸ“±</span>
          <span style="font-size:.62rem;font-family:'JetBrains Mono',monospace;color:var(--tq);margin-top:.25rem" id="shZoneLbl">Press Start</span>
          <!-- Motion wave bars -->
          <div style="display:flex;align-items:flex-end;gap:2px;position:absolute;bottom:12px" id="shWave">
            ${Array.from({length:10},()=>`<div style="width:4px;height:3px;border-radius:2px 2px 0 0;background:var(--g2);transition:height .12s"></div>`).join('')}
          </div>
        </div>
      </div>

      <div class="sc-row" style="justify-content:center">
        <div class="scb"><span class="v" id="shMove">â€”</span><span class="l">Movement</span></div>
        <div class="scb"><span class="v" id="shStab">â€”</span><span class="l">Stability %</span></div>
      </div>

      <div class="notice">
        <div class="ni">ğŸ’¡</div>
        <p>Rest your elbow on a surface. Breathe slowly. Try not to even blink too hard.</p>
      </div>

      <div class="btn-row">
        <button class="btn btn--p btn--lg" id="shStart" onclick="_shBegin()">â–¶ Start 20s Hold</button>
      </div>
    </div></div>`);

    LAB.say('Press start, then hold your phone as still as you possibly can for twenty seconds. Rest your elbow on something if that helps.');
  });

  window._shBegin = function () {
    const b=document.getElementById('shStart'); if(b) b.style.display='none';
    _samples=[]; _elapsed=0;

    // Try DeviceMotion
    if (typeof DeviceMotionEvent !== 'undefined') {
      // Request permission on iOS 13+
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(r=>{
          if(r==='granted') { window.addEventListener('devicemotion',_shMotion); _motionOn=true; }
          else _shMouseFallback();
        }).catch(_shMouseFallback);
      } else {
        window.addEventListener('devicemotion',_shMotion); _motionOn=true;
      }
    } else {
      _shMouseFallback();
    }

    _cd=setInterval(()=>{
      _elapsed++;
      const rem=DUR-_elapsed, te=document.getElementById('shTimer');
      if(te){ te.textContent=rem; te.className='timer'+(rem<=5?' crit':rem<=10?' warn':''); }
      if(_elapsed>=DUR){ clearInterval(_cd); if(_motionOn) window.removeEventListener('devicemotion',_shMotion); _shDone(); }
    },1000);

    const lbl=document.getElementById('shZoneLbl'); if(lbl) lbl.textContent='Stay still!';
    const icon=document.getElementById('shIcon'); if(icon) icon.textContent='ğŸ¤«';
  };

  function _shMotion(e) {
    const acc=e.accelerationIncludingGravity;
    if(!acc) return;
    const mag=Math.sqrt((acc.x||0)**2+(acc.y||0)**2+(acc.z||0)**2);
    _samples.push(mag);
    _mvAvg=_mvAvg*.85+Math.abs(mag-9.8)*.15;
    _shUpdateUI(_mvAvg);
  }

  function _shMouseFallback() {
    // Desktop: track mouse leaving a circle
    const zone=document.getElementById('shZone');
    const lbl=document.getElementById('shZoneLbl'); if(lbl) lbl.textContent='Keep cursor here';
    const icon=document.getElementById('shIcon'); if(icon) icon.textContent='ğŸ–±ï¸';

    // Simulate slight stability by sampling periodically
    const fallbackInterval=setInterval(()=>{
      if(_elapsed>=DUR){ clearInterval(fallbackInterval); return; }
      // Inject a moderate sample â€” assume good stability unless user moves mouse
      _samples.push(0.1+Math.random()*0.2);
    },100);

    if(zone){
      zone.addEventListener('mousemove',e=>{
        _mvAvg=_mvAvg*.7+0.8*.3; // each move = shake
        _shUpdateUI(_mvAvg);
        _samples.push(_mvAvg);
      });
    }
  }

  function _shUpdateUI(mv) {
    const stability=Math.max(0,Math.round(100-mv*60));
    const se=document.getElementById('shStab'), me=document.getElementById('shMove');
    if(se){ se.textContent=stability+'%'; se.style.color=LAB.scoreCol(stability); }
    if(me){ me.textContent=mv.toFixed(2)+'g'; }

    // Animate wave bars
    const wave=document.getElementById('shWave');
    if(wave){ wave.querySelectorAll('div').forEach(bar=>{
      const h=3+mv*20+Math.random()*3;
      bar.style.height=Math.min(h,24)+'px';
      bar.style.background=mv>1?'var(--rd)':mv>.4?'var(--am)':'var(--g2)';
    });}

    const zone=document.getElementById('shZone');
    if(zone){ zone.style.borderColor=mv>1?'var(--rd)':mv>.4?'var(--am)':'var(--g)'; }
  }

  function _shDone() {
    let sc=60;
    if(_samples.length>5){
      const avgMv=LAB.avg(_samples.map(s=>Math.abs(s-9.8)||s));
      sc=LAB.clamp(Math.round(100-avgMv*55),15,100);
    }
    LAB.raw.stabilityScore=sc;
    LAB.celebrate();
    LAB.say(`That is it! Your steadiness score is ${sc}. ${LAB.scoreLbl(sc)}.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1800);
  }
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 14 â€” MICRO TREMOR (SVG Drawing)
   User must trace a zig-zag path on a canvas.
   Deviation from the path = tremor score.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_microTremor = function () {
  let _drawing=false, _pts=[], _started=false, _pathPts=[];

  // Reference path (zig-zag in normalised 0-1 coords)
  const PATH = [{x:.1,y:.5},{x:.25,y:.2},{x:.4,y:.8},{x:.55,y:.2},{x:.7,y:.8},{x:.85,y:.2},{x:.9,y:.5}];

  LAB.showDemo({
    title: 'âœ Tremor Drawing',
    txt: 'You will see a zig-zag path on screen. <strong>Trace along it with your finger or mouse</strong> as smoothly and accurately as you can. We measure how steady your hand is.',
    hint: 'Go slowly â€” accuracy matters more than speed',
    voiceEN: 'Tremor drawing test. A zig-zag path appears. Trace along it as smoothly as you can with your finger. Steady and slow.',
    btnLabel: 'Start Drawing Test â†’',
    vis: `<div style="text-align:center">
      <svg width="200" height="70" viewBox="0 0 200 70" style="border:1.5px solid var(--b);border-radius:8px;background:#fff">
        <polyline points="${PATH.map(p=>`${p.x*200},${p.y*70}`).join(' ')}"
          stroke="var(--g)" stroke-width="2.5" fill="none" stroke-dasharray="5,3" stroke-linecap="round"/>
        <text x="8" y="62" font-size="9" fill="var(--tq)" font-family="monospace">Follow this â†’</text>
      </svg>
    </div>`,
    anim(vis) {
      // Animate a dot moving along the path
      const svg=vis.querySelector('svg');
      if(!svg) return null;
      const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('r','5'); dot.setAttribute('fill','var(--gd)');
      svg.appendChild(dot);
      let t=0;
      const id=setInterval(()=>{
        t=(t+.02)%1;
        const segI=Math.floor(t*(PATH.length-1));
        const segT=(t*(PATH.length-1))-segI;
        const p1=PATH[Math.min(segI,PATH.length-2)], p2=PATH[Math.min(segI+1,PATH.length-1)];
        const x=p1.x+(p2.x-p1.x)*segT, y=p1.y+(p2.y-p1.y)*segT;
        dot.setAttribute('cx', (x*200).toFixed(1));
        dot.setAttribute('cy', (y*70).toFixed(1));
      },40);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">âœ Stability Â· 2 of 2</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Tremor Drawing</h2>
        <p class="pg"><strong>Trace along the dashed path</strong> with your finger or mouse. Start from the left circle, end at the right.</p>
      </div>

      <!-- Drawing canvas -->
      <div style="position:relative;touch-action:none;margin:1rem 0;border-radius:var(--rs);overflow:hidden">
        <canvas id="trCanvas" width="800" height="240"
          style="width:100%;height:auto;background:#fff;border:2px solid var(--b);border-radius:var(--rs);cursor:crosshair;display:block;touch-action:none"
          aria-label="Drawing canvas"></canvas>
      </div>

      <div class="sc-row" style="justify-content:center">
        <div class="scb"><span class="v" id="trDev">â€”</span><span class="l">Deviation</span></div>
        <div class="scb"><span class="v" id="trScore">â€”</span><span class="l">Steadiness</span></div>
        <div class="scb"><span class="v" id="trStatus">Waiting</span><span class="l">Status</span></div>
      </div>

      <div class="notice">
        <div class="ni">ğŸ’¡</div>
        <p>Rest your wrist on a surface. Use one slow, continuous stroke. The test scores when you lift your finger.</p>
      </div>

      <div class="btn-row">
        <button class="btn btn--g" onclick="_trClear()">â†º Clear &amp; Retry</button>
        <button class="btn btn--p" id="trNext" style="display:none" onclick="LAB.idx++;LAB.next()">Continue â†’</button>
      </div>
    </div></div>`);

    LAB.say('Trace along the dotted path as smoothly as you can. Start from the green circle on the left. Slow and steady.');

    setTimeout(_trSetup, 200);
  });

  function _trSetup() {
    const canvas=document.getElementById('trCanvas'); if(!canvas) return;
    const ctx=canvas.getContext('2d');
    const W=canvas.width, H=canvas.height;

    // Draw reference path
    function drawPath() {
      ctx.clearRect(0,0,W,H);
      ctx.setLineDash([10,6]);
      ctx.strokeStyle='rgba(42,122,90,.35)';
      ctx.lineWidth=6;
      ctx.lineCap='round';
      ctx.beginPath();
      PATH.forEach((p,i)=>{ i===0?ctx.moveTo(p.x*W,p.y*H):ctx.lineTo(p.x*W,p.y*H); });
      ctx.stroke();
      ctx.setLineDash([]);

      // Start/end circles
      ctx.fillStyle='var(--g)';
      ctx.beginPath(); ctx.arc(PATH[0].x*W,PATH[0].y*H,10,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(PATH[PATH.length-1].x*W,PATH[PATH.length-1].y*H,10,0,Math.PI*2); ctx.fill();

      // Labels
      ctx.fillStyle='#fff'; ctx.font='bold 11px JetBrains Mono,monospace'; ctx.textAlign='center';
      ctx.fillText('START',PATH[0].x*W,PATH[0].y*H+4);
      ctx.fillText('END',PATH[PATH.length-1].x*W,PATH[PATH.length-1].y*H+4);
    }

    drawPath();

    function getXY(e) {
      const r=canvas.getBoundingClientRect();
      const scaleX=W/r.width, scaleY=H/r.height;
      if(e.touches) return {x:(e.touches[0].clientX-r.left)*scaleX, y:(e.touches[0].clientY-r.top)*scaleY};
      return {x:(e.clientX-r.left)*scaleX, y:(e.clientY-r.top)*scaleY};
    }

    function onStart(e) {
      e.preventDefault(); const p=getXY(e);
      _drawing=true; _pts=[p]; _started=true;
      ctx.strokeStyle='rgba(42,122,90,.65)'; ctx.lineWidth=3; ctx.lineCap='round'; ctx.setLineDash([]);
      ctx.beginPath(); ctx.moveTo(p.x,p.y);
      const st=document.getElementById('trStatus'); if(st) st.textContent='Drawingâ€¦';
    }
    function onMove(e) {
      e.preventDefault(); if(!_drawing) return;
      const p=getXY(e); _pts.push(p);
      ctx.lineTo(p.x,p.y); ctx.stroke();
    }
    function onEnd(e) {
      e.preventDefault(); if(!_drawing) return;
      _drawing=false;
      if(_pts.length>8) _trScore(W,H);
    }

    canvas.addEventListener('mousedown',onStart); canvas.addEventListener('mousemove',onMove);
    canvas.addEventListener('mouseup',onEnd);    canvas.addEventListener('mouseleave',onEnd);
    canvas.addEventListener('touchstart',onStart,{passive:false});
    canvas.addEventListener('touchmove',onMove,{passive:false});
    canvas.addEventListener('touchend',onEnd);
  }

  function _trScore(W,H) {
    // For each user point, find distance to nearest point on reference path
    let totalDev=0;
    _pts.forEach(p=>{
      let minD=Infinity;
      for(let i=0;i<PATH.length-1;i++){
        const ax=PATH[i].x*W, ay=PATH[i].y*H, bx=PATH[i+1].x*W, by=PATH[i+1].y*H;
        const dx=bx-ax, dy=by-ay;
        const len2=dx*dx+dy*dy;
        const t=len2>0?Math.max(0,Math.min(1,((p.x-ax)*dx+(p.y-ay)*dy)/len2)):0;
        const d=Math.hypot(p.x-(ax+t*dx), p.y-(ay+t*dy));
        if(d<minD) minD=d;
      }
      totalDev+=minD;
    });
    const avgDev=totalDev/_pts.length;
    const sc=LAB.clamp(Math.round(100-avgDev*1.4),10,100);

    LAB.raw.tremorDev=Math.round(avgDev); LAB.raw.tremorScore=sc;
    { const stab=[LAB.raw.stabilityScore,sc].filter(x=>x!=null); LAB.scores.stability=Math.round(LAB.avg(stab)); }

    const dv=document.getElementById('trDev'), sv=document.getElementById('trScore'), st=document.getElementById('trStatus');
    if(dv){ dv.textContent=Math.round(avgDev)+'px'; }
    if(sv){ sv.textContent=sc; sv.style.color=LAB.scoreCol(sc); }
    if(st){ st.textContent=LAB.scoreLbl(sc); st.style.color=LAB.scoreCol(sc); }

    const nb=document.getElementById('trNext'); if(nb) nb.style.display='flex';

    LAB.celebrate();
    LAB.say(`Drawing done. Average deviation ${Math.round(avgDev)} pixels. ${LAB.scoreLbl(sc)} hand steadiness.`);
  }

  window._trClear = function () {
    _pts=[]; _drawing=false; _started=false;
    const c=document.getElementById('trCanvas'), s=document.getElementById('trScore'), dv=document.getElementById('trDev'), st=document.getElementById('trStatus'), nb=document.getElementById('trNext');
    if(s) s.textContent='â€”'; if(dv) dv.textContent='â€”'; if(st) st.textContent='Waiting';
    if(nb) nb.style.display='none';
    if(c){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); _trSetup(); }
  };
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 15 â€” SLEEP EFFICIENCY
   Quick questionnaire: bedtime, wake time, interruptions.
   Computes sleep efficiency and quality score.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_sleepEfficiency = function () {
  LAB.showDemo({
    title: 'ğŸ’¤ Sleep Check',
    txt: 'Answer 5 quick questions about your sleep last night. We calculate a sleep quality score based on your answers.',
    hint: 'Honest answers = accurate score',
    voiceEN: 'Sleep check. Answer 5 short questions about your sleep last night. Be honest for the most accurate result.',
    btnLabel: 'Start Sleep Check â†’',
    vis: `<div style="text-align:center;font-size:2rem;margin-bottom:.5rem">ğŸ’¤</div>
    <div style="font-size:.82rem;color:var(--tq);text-align:center">5 quick questions<br>about last night's sleep</div>`,
    anim(vis) {
      const icons=['ğŸ’¤','ğŸ˜´','ğŸŒ™','â°','ğŸ›'];
      let i=0; const d=vis.querySelector('div');
      const id=setInterval(()=>{ i=(i+1)%icons.length; if(d) d.textContent=icons[i]; },800);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">ğŸ’¤ Lifestyle Â· 1 of 2</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Sleep Quality Check</h2>
        <p class="pg">Answer about your sleep last night. Takes about 1 minute.</p>
      </div>

      <div class="fld">
        <label class="lbl" for="slBed">What time did you go to bed?</label>
        <input class="inp" type="time" id="slBed" value="22:30">
      </div>
      <div class="fld">
        <label class="lbl" for="slWake">What time did you wake up?</label>
        <input class="inp" type="time" id="slWake" value="06:30">
      </div>

      <div class="fld">
        <label class="lbl">How long did it take to fall asleep?</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
          ${[['Under 10 min',5],['10â€“20 min',15],['20â€“40 min',30],['Over 40 min',50]].map(([l,v],i)=>`
            <div class="slOpt" id="slS${i}" onclick="LAB.pickOpt('slSleep',${i},${v})" role="radio" aria-checked="false" tabindex="0"
                 onkeydown="if(event.key==='Enter')LAB.pickOpt('slSleep',${i},${v})"
                 style="padding:.62rem .8rem;background:#fff;border:2px solid var(--b);border-radius:var(--rs);cursor:pointer;transition:.2s;font-size:.82rem;color:var(--tm)">
              ${l}</div>`).join('')}
        </div>
      </div>

      <div class="fld">
        <label class="lbl">How many times did you wake up during the night?</label>
        <select class="sel" id="slWakes">
          <option value="0">0 times â€” slept through</option>
          <option value="1">1 time</option>
          <option value="2">2 times</option>
          <option value="3">3 times</option>
          <option value="4" selected>4 or more times</option>
        </select>
      </div>

      <div class="fld">
        <label class="lbl">How rested do you feel this morning?</label>
        <input type="range" class="rng" id="slRest" min="1" max="10" value="6" oninput="document.getElementById('slRestV').textContent=this.value">
        <div class="rng-l"><span>Not at all</span><span id="slRestV" style="color:var(--g);font-weight:700">6</span><span>Fully rested</span></div>
      </div>

      <div class="btn-row">
        <button class="btn btn--p btn--lg" onclick="_slCalc()">Calculate Sleep Score â†’</button>
      </div>
    </div></div>`);

    LAB.say('Answer the 5 sleep questions honestly.');
  });

  window._slCalc = function () {
    const bed  = document.getElementById('slBed')?.value  || '22:30';
    const wake = document.getElementById('slWake')?.value || '06:30';
    const wakes= parseInt(document.getElementById('slWakes')?.value||'2');
    const rest = parseInt(document.getElementById('slRest')?.value||'6');
    const sleepOnset = LAB.fval('slSleep', 15);

    // Parse duration
    const [bh,bm]=bed.split(':').map(Number);  const [wh,wm]=wake.split(':').map(Number);
    let mins=(wh*60+wm)-(bh*60+bm); if(mins<0) mins+=1440;
    const hours=mins/60;

    // Score components
    const durScore = hours<5?25:hours<6?45:hours<7?65:hours<8?85:hours<9?100:88;
    const onsetScore= sleepOnset<=10?100:sleepOnset<=20?80:sleepOnset<=30?58:35;
    const wakeScore = wakes===0?100:wakes===1?85:wakes===2?65:wakes===3?45:25;
    const restScore = rest*10;

    const sc = LAB.clamp(Math.round(durScore*.35+onsetScore*.2+wakeScore*.25+restScore*.2), 10, 100);
    LAB.raw.sleepHours=Math.round(hours*10)/10; LAB.raw.sleepScore=sc;

    LAB.celebrate();
    LAB.say(`Sleep check done. You slept about ${Math.round(hours*10)/10} hours. ${LAB.scoreLbl(sc)} sleep quality.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1800);
  };
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 16 â€” LIFESTYLE LOAD
   Short questionnaire covering 6 lifestyle dimensions.
   Produces composite lifestyle score.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_lifestyleLoad = function () {
  LAB.showDemo({
    title: 'âš– Lifestyle Score',
    txt: 'Answer 6 quick questions about your daily habits â€” water intake, exercise, diet, stress, screen time and social time. Takes about 2 minutes.',
    hint: 'No wrong answers â€” just be honest with yourself',
    voiceEN: 'Lifestyle score. Answer 6 questions about your daily habits. Water, exercise, diet, stress, screen time and social connections.',
    btnLabel: 'Start Lifestyle Check â†’',
    vis: `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;max-width:180px;margin:0 auto">
      ${['ğŸ’§','ğŸƒ','ğŸ¥—','ğŸ˜¤','ğŸ“±','ğŸ‘¥'].map(e=>`<div style="aspect-ratio:1;background:var(--g3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.4rem">${e}</div>`).join('')}
    </div>`,
    anim(vis) {
      const els = vis.querySelectorAll('div > div');
      let i=0;
      const id=setInterval(()=>{
        els.forEach((el,j)=>{ el.style.background=j===i?'var(--g3)':el.style.background='var(--bg)'; el.style.transform=j===i?'scale(1.15)':'scale(1)'; });
        i=(i+1)%els.length;
      },600);
      return id;
    }
  }, () => {
    const questions = [
      { id:'liWater', icon:'ğŸ’§', label:'How much water do you drink daily?',
        opts:[['Under 1 litre',25],['1â€“1.5 litres',55],['1.5â€“2.5 litres',82],['Over 2.5 litres',100]] },
      { id:'liEx', icon:'ğŸƒ', label:'How often do you exercise or move actively?',
        opts:[['Rarely / never',20],['1â€“2x a week',50],['3â€“4x a week',80],['Daily',100]] },
      { id:'liDiet', icon:'ğŸ¥—', label:'How healthy is your daily diet overall?',
        opts:[['Mostly junk / processed',20],['Some healthy, some not',50],['Mostly healthy',78],['Very healthy',100]] },
      { id:'liStr', icon:'ğŸ˜¤', label:'How is your stress level on most days?',
        opts:[['Very high â€” often overwhelmed',20],['High â€” often tense',45],['Moderate â€” manageable',72],['Low â€” usually calm',100]] },
      { id:'liScr', icon:'ğŸ“±', label:'How many hours of non-work screen time daily?',
        opts:[['Over 5 hours',25],['3â€“5 hours',55],['1â€“3 hours',80],['Under 1 hour',100]] },
      { id:'liSoc', icon:'ğŸ‘¥', label:'How connected do you feel to friends and family?',
        opts:[['Very isolated',20],['Somewhat connected',55],['Mostly connected',80],['Very connected',100]] },
    ];

    LAB.render(`<div class="mwrap"><div class="card card--pop">
      <div class="step-head">
        <div class="tag">âš– Lifestyle Â· 2 of 2</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.4rem">Lifestyle Score</h2>
        <p class="pg">Tap your honest answer for each question.</p>
      </div>

      ${questions.map(q=>`
        <div class="fld">
          <label class="lbl">${q.icon} ${q.label}</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.45rem">
            ${q.opts.map(([l,v],i)=>`
              <div onclick="LAB.pickOpt('${q.id}',${i},${v})" role="radio" aria-checked="false" tabindex="0"
                   onkeydown="if(event.key==='Enter')LAB.pickOpt('${q.id}',${i},${v})"
                   id="oc_${q.id}_${i}"
                   style="padding:.6rem .75rem;background:#fff;border:2px solid var(--b);border-radius:var(--rs);cursor:pointer;transition:.2s;font-size:.79rem;color:var(--tm);display:flex;align-items:center;gap:.4rem">
                <div id="od_${q.id}_${i}" style="width:13px;height:13px;border-radius:50%;border:2px solid var(--b);flex-shrink:0;transition:.2s"></div>
                ${l}
              </div>`).join('')}
          </div>
        </div>`).join('')}

      <div class="btn-row">
        <button class="btn btn--p btn--lg" onclick="_liCalc()">Calculate Lifestyle Score â†’</button>
      </div>
    </div></div>`);

    LAB.say('Tap your honest answer for each question.');
  });

  window._liCalc = function () {
    const ids=['liWater','liEx','liDiet','liStr','liScr','liSoc'];
    const vals=ids.map(id=>LAB.fval(id,50));
    const sc=LAB.clamp(Math.round(LAB.avg(vals)),10,100);
    LAB.raw.lifestyleBreakdown=vals;
    LAB.raw.lifestyleScore=sc;
    LAB.scores.lifestyle=sc;

    LAB.celebrate();
    LAB.say(`Lifestyle score: ${sc} out of 100. ${LAB.scoreLbl(sc)}.`);
    setTimeout(() => { LAB.idx++; LAB.next(); }, 1800);
  };
};

console.log('[WellnessLab v2 Part 3] Loaded â€” Respiratory (3) + Stress (2) + Stability (2) + Sleep + Lifestyle ready.');
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â• PART 4 START â•â•â•â•â•â•â•â•â•â•â• -->

<script>
'use strict';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 17 â€” HORMONAL RHYTHM  (Female)
   Short 5-question cycle awareness check.
   Assesses regularity, symptoms, mood patterns.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_hormonalRhythm = function () {
  LAB.showDemo({
    title: 'ğŸŒ¸ Hormonal Rhythm',
    txt: '5 short questions about your monthly cycle. <strong>Completely private</strong> â€” nothing is stored anywhere. Takes under 2 minutes.',
    hint: 'Private Â· not stored Â· just for your score',
    voiceEN: 'Hormonal rhythm check. Five quick questions about your monthly cycle. All completely private.',
    btnLabel: 'Start â€” 2 Minutes â†’',
    vis: `<div style="text-align:center">
      <div id="hrDemoIcon" style="font-size:2.4rem;transition:all .5s">ğŸŒ¸</div>
      <div style="font-size:.75rem;color:var(--tq);margin-top:.35rem">Private Â· Secure Â· Not Stored</div>
    </div>`,
    anim(vis) {
      const icons=['ğŸŒ¸','ğŸŒ™','ğŸ’«','ğŸŒ¿','ğŸŒ¸'];
      let i=0; const el=vis.querySelector('#hrDemoIcon');
      const id=setInterval(()=>{ i=(i+1)%icons.length; if(el){ el.style.opacity='0'; setTimeout(()=>{ el.textContent=icons[i]; el.style.opacity='1'; },250); } },1000);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--gd card--pop" style="border-color:rgba(201,120,0,.2)">
      <div class="step-head">
        <div class="tag tag--pk">ğŸŒ¸ Female Â· 1 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.35rem">Hormonal Rhythm Check</h2>
        <p class="pg">5 quick questions. All answers stay on your device only.</p>
      </div>

      <div class="fld">
        <label class="lbl">How regular is your monthly cycle?</label>
        ${LAB.optGrid('hrReg',[
          {l:'Very regular (Â±2 days)',v:100},
          {l:'Mostly regular (Â±5 days)',v:75},
          {l:'Somewhat irregular',v:45},
          {l:'Very irregular / absent',v:20}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How severe are your pre-period symptoms (cramps, mood, bloating)?</label>
        ${LAB.optGrid('hrSymp',[
          {l:'Mild â€” barely noticeable',v:100},
          {l:'Moderate â€” manageable',v:72},
          {l:'Severe â€” affects daily life',v:40},
          {l:'Very severe / debilitating',v:18}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How is your energy in the week before your period?</label>
        ${LAB.optGrid('hrEnPre',[
          {l:'Normal â€” no change',v:100},
          {l:'Slightly lower',v:75},
          {l:'Noticeably lower',v:50},
          {l:'Very low / exhausted',v:25}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How is your mood across your cycle?</label>
        ${LAB.optGrid('hrMood',[
          {l:'Stable throughout',v:100},
          {l:'Minor changes',v:78},
          {l:'Notable mood swings',v:48},
          {l:'Significant mood changes',v:22}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How long does your period typically last?</label>
        ${LAB.optGrid('hrDur',[
          {l:'3â€“5 days (typical)',v:100},
          {l:'2â€“3 days or 5â€“7 days',v:78},
          {l:'Under 2 days',v:55},
          {l:'Over 7 days',v:35}
        ])}
      </div>

      <div class="btn-row">
        <button class="btn btn--gd btn--lg" onclick="_hrCalc()">Calculate â†’</button>
      </div>
    </div></div>`);

    LAB.say('Tap your answer for each question. All data stays on your device.');
  });

  window._hrCalc = function () {
    const ids=['hrReg','hrSymp','hrEnPre','hrMood','hrDur'];
    const vals=ids.map(id=>LAB.fval(id,60));
    const sc=LAB.clamp(Math.round(LAB.avg(vals)),10,100);
    LAB.raw.hormonalScore=sc; LAB.raw.hormonalBreakdown=vals;
    LAB.celebrate();
    LAB.say(`Hormonal rhythm check done. Score: ${sc}. ${LAB.scoreLbl(sc)}.`);
    setTimeout(()=>{ LAB.idx++; LAB.next(); },1800);
  };
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 18 â€” ENERGY & IRON  (Female)
   Screens for common iron-deficiency symptoms.
   Short, focused, actionable.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_energyIron = function () {
  LAB.showDemo({
    title: 'âš¡ Energy & Iron Check',
    txt: '4 quick questions about energy, fatigue and common iron-deficiency signs. Gets you a simple score and practical advice.',
    hint: 'Iron deficiency is very common â€” worth checking',
    voiceEN: 'Energy and iron check. Four questions about your energy levels and iron deficiency symptoms.',
    btnLabel: 'Start Energy Check â†’',
    vis: `<div style="text-align:center">
      <div style="font-size:2rem" id="eiIcon">âš¡</div>
      <div style="font-size:.75rem;color:var(--tq);margin-top:.3rem">Energy Â· Iron Â· Fatigue</div>
    </div>`,
    anim(vis) {
      const icons=['âš¡','ğŸ©¸','ğŸ˜´','ğŸ’ª'];
      let i=0; const el=vis.querySelector('#eiIcon');
      const id=setInterval(()=>{ i=(i+1)%4; if(el) el.textContent=icons[i]; },800);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--gd card--pop" style="border-color:rgba(201,120,0,.2)">
      <div class="step-head">
        <div class="tag tag--pk">ğŸŒ¸ Female Â· 2 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.35rem">Energy & Iron</h2>
        <p class="pg">4 questions about fatigue and iron symptoms. Honest answers give the best result.</p>
      </div>

      <div class="fld">
        <label class="lbl">How is your energy level on most days?</label>
        ${LAB.optGrid('eiEn',[
          {l:'High â€” feel great',v:100},
          {l:'Moderate â€” okay',v:72},
          {l:'Low â€” often tired',v:42},
          {l:'Very low â€” exhausted daily',v:15}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">Do you experience any of these? (pick closest)</label>
        ${LAB.optGrid('eiSymp',[
          {l:'None of these',v:100},
          {l:'Occasional cold hands/feet or dizziness',v:68},
          {l:'Frequent headaches or pale skin',v:42},
          {l:'Hair loss, brittle nails, or breathlessness',v:18}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How heavy is your monthly flow?</label>
        ${LAB.optGrid('eiFlow',[
          {l:'Light to normal',v:100},
          {l:'Slightly heavy',v:72},
          {l:'Heavy â€” changes frequently',v:45},
          {l:'Very heavy / flooding',v:18}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How is your diet in iron-rich foods? (meat, beans, spinach, lentils)</label>
        ${LAB.optGrid('eiDiet',[
          {l:'Rich â€” eat these regularly',v:100},
          {l:'Moderate',v:70},
          {l:'Low â€” rarely eat these',v:40},
          {l:'Very low / vegetarian with no iron focus',v:22}
        ])}
      </div>

      <div class="btn-row">
        <button class="btn btn--gd btn--lg" onclick="_eiCalc()">Calculate â†’</button>
      </div>
    </div></div>`);

    LAB.say('Answer 4 questions about your energy and iron levels.');
  });

  window._eiCalc = function () {
    const ids=['eiEn','eiSymp','eiFlow','eiDiet'];
    const vals=ids.map(id=>LAB.fval(id,60));
    const sc=LAB.clamp(Math.round(LAB.avg(vals)),10,100);
    LAB.raw.ironScore=sc;
    LAB.celebrate();
    LAB.say(`Energy and iron check done. Score: ${sc}.`);
    setTimeout(()=>{ LAB.idx++; LAB.next(); },1800);
  };
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   MODULE 19 â€” FEMALE COMBINED: Sleep & Comfort  (Female)
   Merges sleep-cycle quality + pelvic comfort into one
   short module. Replaces 3 long boring modules with 1.
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.mod_femCombined = function () {
  LAB.showDemo({
    title: 'ğŸŒ™ Sleep & Comfort',
    txt: '5 questions combining sleep-cycle quality and physical comfort â€” specific to female health patterns.',
    hint: 'Combines sleep cycle + comfort in one short check',
    voiceEN: 'Sleep and comfort check. Five questions about sleep quality linked to your cycle and physical comfort.',
    btnLabel: 'Start â€” Final Female Module â†’',
    vis: `<div style="text-align:center;font-size:1.8rem" id="fcIcon">ğŸŒ™</div>`,
    anim(vis) {
      const icons=['ğŸŒ™','ğŸ›Œ','ğŸŒ¸','ğŸ’†','ğŸŒ™'];
      let i=0; const el=vis.querySelector('#fcIcon');
      const id=setInterval(()=>{ i=(i+1)%icons.length; if(el) el.textContent=icons[i]; },900);
      return id;
    }
  }, () => {
    LAB.render(`<div class="mwrap"><div class="card card--gd card--pop" style="border-color:rgba(201,120,0,.2)">
      <div class="step-head">
        <div class="tag tag--pk">ğŸŒ¸ Female Â· 3 of 3</div>
        <h2 class="h2" style="margin-top:.75rem;margin-bottom:.35rem">Sleep & Comfort</h2>
        <p class="pg">Final female module â€” 5 questions, under 2 minutes.</p>
      </div>

      <div class="fld">
        <label class="lbl">Does your sleep quality change with your cycle?</label>
        ${LAB.optGrid('fcSlCyc',[
          {l:'No change â€” stable sleep',v:100},
          {l:'Slight changes',v:78},
          {l:'Noticeable worsening before period',v:48},
          {l:'Significant disruption for many days',v:22}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How often do you experience pelvic pain or discomfort?</label>
        ${LAB.optGrid('fcPelv',[
          {l:'Rarely or never',v:100},
          {l:'Only during period â€” mild',v:75},
          {l:'Often during period â€” moderate',v:45},
          {l:'Frequent or severe / outside period too',v:18}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How is your bladder comfort? (urgency, leaks, pain)</label>
        ${LAB.optGrid('fcBlad',[
          {l:'No issues',v:100},
          {l:'Occasional urgency',v:75},
          {l:'Frequent urgency or mild leaks',v:48},
          {l:'Pain, frequent leaks, or infections',v:22}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">How often do you feel bloated or have digestive discomfort?</label>
        ${LAB.optGrid('fcBloa',[
          {l:'Rarely',v:100},
          {l:'Around my period only',v:75},
          {l:'Several days per month',v:50},
          {l:'Most days',v:25}
        ])}
      </div>

      <div class="fld">
        <label class="lbl">Overall, how would you rate your physical wellbeing this month?</label>
        <input type="range" class="rng" id="fcWell" min="1" max="10" value="7"
               oninput="document.getElementById('fcWellV').textContent=this.value+'/10'">
        <div class="rng-l"><span>Very poor</span><span id="fcWellV" style="color:var(--gd);font-weight:700">7/10</span><span>Excellent</span></div>
      </div>

      <div class="btn-row">
        <button class="btn btn--gd btn--lg" onclick="_fcCalc()">Calculate & See Results â†’</button>
      </div>
    </div></div>`);

    LAB.say('Answer 5 final questions. After this, your full results will appear.');
  });

  window._fcCalc = function () {
    const ids=['fcSlCyc','fcPelv','fcBlad','fcBloa'];
    const vals=ids.map(id=>LAB.fval(id,65));
    const well=(parseInt(document.getElementById('fcWell')?.value||'7')/10)*100;
    vals.push(well);
    const sc=LAB.clamp(Math.round(LAB.avg(vals)),10,100);
    LAB.raw.femCombinedScore=sc;
    const femScores=[LAB.raw.hormonalScore,LAB.raw.ironScore,sc].filter(x=>x!=null);
    LAB.scores.hormonal=Math.round(LAB.avg(femScores));
    LAB.celebrate();
    LAB.say('Female modules complete! Loading your full results now.');
    setTimeout(()=>{ LAB.idx++; LAB.next(); },1800);
  };
};


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD + RECOMMENDATIONS + PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
LAB.showDashboard = function () {
  /* â”€â”€ Compute composite scores only from completed tests â”€â”€ */
  // avg() returns null if the array is empty (all skipped) â€” domain stays null
  const domAvg = (...keys) => { const v=keys.map(k=>LAB.raw[k]).filter(x=>x!=null); return v.length?Math.round(LAB.avg(v)):null; };
  if (LAB.scores.cognitive  == null) LAB.scores.cognitive   = domAvg('rxScore','ftScore','memScore','attScore');
  if (LAB.scores.eye        == null) LAB.scores.eye          = domAvg('cbScore','acuityScore','csScore');
  if (LAB.scores.respiratory== null) LAB.scores.respiratory = domAvg('breathSyncScore','breathScore','recoveryScore');
  if (LAB.scores.stress     == null) LAB.scores.stress       = domAvg('mathScore','patternScore');
  if (LAB.scores.stability  == null) LAB.scores.stability    = domAvg('stabilityScore','tremorScore');
  if (LAB.scores.lifestyle  == null) LAB.scores.lifestyle    = LAB.raw.lifestyleScore ?? null;

  /* â”€â”€ Build recs â”€â”€ */
  const recs = LAB._buildRecs();
  const isFem = LAB.gender==='female';
  const hormScore = isFem ? (LAB.scores.hormonal ?? null) : null;

  /* â”€â”€ Overall wellness â€” only completed domains count â”€â”€ */
  const mainScores=[LAB.scores.cognitive,LAB.scores.eye,LAB.scores.respiratory,
                    LAB.scores.stress,LAB.scores.stability,LAB.scores.lifestyle];
  if(isFem&&hormScore) mainScores.push(hormScore);
  const completedScores = mainScores.filter(x => x != null);
  const overall = completedScores.length ? Math.round(LAB.avg(completedScores)) : null;
  const completedDomains = completedScores.length;

  /* â”€â”€ Score domains â”€â”€ */
  const domains=[
    {key:'cognitive',  icon:'ğŸ§ ', label:'Cognitive',   col:'#2A7A5A'},
    {key:'eye',        icon:'ğŸ‘',  label:'Eye Health',  col:'#2563EB'},
    {key:'respiratory',icon:'ğŸŒ¬', label:'Respiratory', col:'#059669'},
    {key:'stress',     icon:'ğŸ”¥', label:'Stress',      col:'#C97010'},
    {key:'stability',  icon:'ğŸ“±', label:'Stability',   col:'#7C3AED'},
    {key:'lifestyle',  icon:'âš–',  label:'Lifestyle',   col:'#C0392B'},
    ...(isFem&&hormScore?[{key:'hormonal',icon:'ğŸŒ¸',label:'Hormonal',col:'#B83060'}]:[]),
  ];

  LAB.setStatus('idle','Results Ready');
  LAB.el('progBar').style.display='none';

  LAB.render(`
  <div class="mwrap">

    <!-- â•â• Hero â•â• -->
    <div style="text-align:center;padding:clamp(2rem,5vw,3.5rem) 0 1.5rem">
      <div style="display:inline-flex;align-items:center;gap:.45rem;padding:.32rem .9rem;
                  background:var(--g3);border:1px solid rgba(42,122,90,.28);border-radius:50px;
                  font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--ok);
                  letter-spacing:.09em;text-transform:uppercase;margin-bottom:1.1rem">
        âœ… Assessment Complete
      </div>
      <h2 class="h1" style="margin-bottom:.6rem">Your Wellness Results</h2>
      <p class="pg" style="max-width:400px;margin:0 auto 1.5rem">
        ${completedDomains > 0 ? 'Based on ' + (isFem?'19':'16') + ' activities across cognitive, eye, respiratory, stability and lifestyle health.' : 'You skipped all activities â€” no data to score. Complete at least one test to see results.'}
      </p>

      <!-- Overall ring -->
      <div style="display:inline-flex;flex-direction:column;align-items:center;gap:.5rem;
                  background:#fff;border:1.5px solid var(--b);border-radius:var(--r);
                  padding:1.6rem 2.2rem;box-shadow:var(--shm);margin-bottom:1.8rem">
        <canvas id="overallRing" width="140" height="140"></canvas>
        <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:var(--t);line-height:1"
             id="overallNum">${overall !== null ? overall : 'â€”'}</div>
        <div style="font-size:.65rem;font-family:'JetBrains Mono',monospace;text-transform:uppercase;
                    letter-spacing:.1em;color:var(--tq)">Overall Wellness</div>
        <div style="font-size:.85rem;font-weight:700;color:${overall !== null ? LAB.scoreCol(overall) : 'var(--tq)'}">
          ${overall !== null ? LAB.scoreLbl(overall) : 'No tests completed'}</div>
      </div>
    </div>

    <!-- â•â• Score grid â•â• -->
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.9rem;margin-bottom:2.5rem" id="scoreGrid">
      ${domains.map(d=>{
        const sc = LAB.scores[d.key] ?? null;
        const skipped = sc === null;
        return `<div style="background:${skipped?'var(--bg)':'#fff'};border:1.5px solid var(--b);border-radius:var(--r);
                            padding:1.4rem 1rem;text-align:center;box-shadow:var(--sh);
                            transition:all .26s;cursor:default;position:relative;overflow:hidden;
                            opacity:${skipped?'0.55':'1'}"
                     onmouseenter="this.style.transform='translateY(-4px)';this.style.boxShadow='var(--shm)'"
                     onmouseleave="this.style.transform='none';this.style.boxShadow='var(--sh)'">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;background:${skipped?'var(--b)':d.col};border-radius:3px 3px 0 0"></div>
          <canvas id="ring_${d.key}" width="80" height="80" style="display:block;margin:0 auto .7rem"></canvas>
          <div style="font-size:.6rem;font-family:'JetBrains Mono',monospace;font-weight:700;
                      text-transform:uppercase;letter-spacing:.1em;color:var(--tq);margin-bottom:.22rem">${d.icon} ${d.label}</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.55rem;font-weight:700;
                      line-height:1;color:${skipped?'var(--tq)':d.col}">${skipped ? 'â€”' : sc}</div>
          <div style="font-size:.68rem;color:${skipped?'var(--tq)':LAB.scoreCol(sc)};font-weight:600;margin-top:.18rem">
            ${skipped ? 'Skipped' : LAB.scoreLbl(sc)}</div>
        </div>`;
      }).join('')}
    </div>

    <!-- â•â• Detail breakdown â•â• -->
    <div class="card" style="margin-bottom:2rem">
      <h3 class="h3" style="margin-bottom:1.1rem">ğŸ“Š Activity Breakdown</h3>
      <div style="display:grid;gap:.5rem">
        ${LAB._buildBreakdownRows()}
      </div>
    </div>

    <!-- â•â• Flags â•â• -->
    ${LAB._buildFlagBox()}

    <!-- â•â• Recommendations â•â• -->
    <div style="margin-bottom:2rem">
      <h3 class="h3" style="margin-bottom:.4rem">ğŸ’¡ Personalised Recommendations</h3>
      <p class="pg" style="margin-bottom:1.2rem">Based on your scores â€” things worth paying attention to.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.9rem">
        ${recs.map(r=>`
          <div style="background:#fff;border:1.5px solid var(--b);border-radius:var(--r);
                      overflow:hidden;transition:all .24s"
               onmouseenter="this.style.borderColor='${r.col}';this.style.transform='translateY(-3px)';this.style.boxShadow='var(--shm)'"
               onmouseleave="this.style.borderColor='var(--b)';this.style.transform='none';this.style.boxShadow='none'">
            <div style="height:5px;background:${r.col}"></div>
            <div style="padding:.9rem">
              <div style="font-size:1.5rem;margin-bottom:.4rem">${r.icon}</div>
              <div style="font-weight:700;color:var(--t);font-size:.88rem;margin-bottom:.3rem">${r.title}</div>
              <div style="font-size:.75rem;color:var(--tq);line-height:1.6;margin-bottom:.65rem">${r.body}</div>
              <div style="font-size:.72rem;font-weight:600;color:${r.col};background:${r.col}18;
                          padding:.3rem .65rem;border-radius:50px;display:inline-block">${r.action}</div>
            </div>
          </div>`).join('')}
      </div>
    </div>

    <!-- â•â• Tips â•â• -->
    <div class="card" style="margin-bottom:2rem">
      <h3 class="h3" style="margin-bottom:1rem">ğŸŒ¿ General Wellness Tips</h3>
      ${LAB._buildTips(overall)}
    </div>

    <!-- â•â• Disclaimer â•â• -->
    <div style="background:var(--g4);border:1px solid rgba(42,122,90,.16);border-radius:var(--rs);
                padding:1rem 1.2rem;font-size:.73rem;color:var(--tq);line-height:1.78;margin-bottom:2rem">
      <strong style="color:var(--g)">Important:</strong> These results are wellness indicators only â€” they are <strong>not</strong> a medical diagnosis.
      The activities measure performance proxies, not clinical outcomes. If any score concerns you, please speak to a qualified healthcare professional.
      No data has been sent anywhere â€” everything was calculated on your device.
    </div>


    <!-- â•â• Shah Hayaat Products â•â• -->
    <div style="margin-bottom:2rem">
      <div style="display:inline-flex;align-items:center;gap:.5rem;padding:.28rem .85rem;
                  background:linear-gradient(90deg,rgba(42,122,90,.12),rgba(201,120,0,.1));
                  border:1px solid rgba(42,122,90,.22);border-radius:50px;
                  font-size:.6rem;font-weight:700;color:var(--g);
                  letter-spacing:.1em;text-transform:uppercase;margin-bottom:.9rem">
        ğŸŒ¿ Shah Hayaat Certified Ayurvedic Products
      </div>
      <h3 class="h3" style="margin-bottom:.35rem">Products Matched to Your Results</h3>
      <p class="pg" style="margin-bottom:1.3rem;font-size:.82rem">
        These products from the Shah Hayaat range are selected based on your specific scores.
        WHO-GMP Â· ISO 9001:2015 Â· HACCP Certified.
        Tap <strong style="color:#25D366">Order on WhatsApp</strong> to place an order instantly.
      </p>

      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.85rem" id="shProductGrid">
        ${LAB._buildProductCards()}
      </div>
      <div style="text-align:center;margin-top:1.2rem">
        <a href="https://yasirhashmi02-dev.github.io/Shahhayaat02/products.html"
           target="_blank" style="display:inline-flex;align-items:center;gap:.4rem;
           color:var(--g);font-weight:600;font-size:.8rem;text-decoration:none;
           padding:.45rem 1.1rem;border:1.5px solid rgba(42,122,90,.3);border-radius:50px;
           transition:.22s" onmouseenter="this.style.background='var(--g3)'" onmouseleave="this.style.background='transparent'">
          ğŸŒ¿ View all 12 Shah Hayaat products â†’
        </a>
      </div>
    </div>

    <!-- â•â• Expert Consultation via WhatsApp â•â• -->
    <div style="background:linear-gradient(135deg,#F0FBF5,#E8F5EE);border:1.5px solid rgba(42,122,90,.25);
                border-radius:var(--r);padding:1.4rem 1.6rem;margin-bottom:2rem;
                box-shadow:0 4px 18px rgba(42,122,90,.1)">
      <div style="display:flex;flex-wrap:wrap;align-items:flex-start;gap:1.1rem">
        <div style="font-size:2.4rem;flex-shrink:0;line-height:1">ğŸ©º</div>
        <div style="flex:1;min-width:180px">
          <div style="font-weight:700;color:var(--t);font-size:1rem;margin-bottom:.25rem">
            Talk to a Shah Hayaat Expert
          </div>
          <p style="font-size:.8rem;color:var(--tm);line-height:1.65;margin-bottom:.9rem">
            Have questions about your results? Our wellness consultants can review your report, 
            answer your questions, and guide you to the right products or next steps.
            <strong style="color:var(--g)">Free 15-minute consultation.</strong>
          </p>
          <div style="display:flex;flex-wrap:wrap;gap:.6rem">
            <button onclick="LAB.whatsappShare()" 
                    style="display:inline-flex;align-items:center;gap:.5rem;
                           background:#25D366;color:#fff;border:none;
                           padding:.7rem 1.3rem;border-radius:50px;font-weight:700;
                           font-size:.9rem;cursor:pointer;box-shadow:0 4px 14px rgba(37,211,102,.35);
                           transition:all .22s;-webkit-tap-highlight-color:transparent"
                    onmouseenter="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 22px rgba(37,211,102,.45)'"
                    onmouseleave="this.style.transform='none';this.style.boxShadow='0 4px 14px rgba(37,211,102,.35)'">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
              Share Report on WhatsApp
            </button>
            <a href="tel:+917051056287"
               style="display:inline-flex;align-items:center;gap:.45rem;
                      background:#fff;color:var(--g);border:2px solid rgba(42,122,90,.3);
                      padding:.65rem 1.2rem;border-radius:50px;font-weight:700;
                      font-size:.85rem;text-decoration:none;
                      transition:all .22s;box-shadow:0 2px 8px rgba(42,122,90,.1)"
               onmouseenter="this.style.borderColor='var(--g)';this.style.background='var(--g3)'"
               onmouseleave="this.style.borderColor='rgba(42,122,90,.3)';this.style.background='#fff'">
              ğŸ“ Call Expert
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• Actions â•â• -->
    <div class="card" style="margin-bottom:1.4rem;padding:1.25rem 1.4rem">
      <h3 class="h3" style="margin-bottom:.5rem;font-size:.95rem">ğŸ“„ Download Your PDF Report</h3>
      <p class="pg" style="margin-bottom:.85rem;font-size:.82rem">Add your name to appear on the report â€” or leave it blank.</p>
      <div class="fld" style="margin-bottom:.85rem">
        <label class="lbl" for="pdfNameInp">Your name (optional)</label>
        <input class="inp" type="text" id="pdfNameInp" placeholder="e.g. Ahmed Khan"
               maxlength="60" autocomplete="name" style="font-size:1rem">
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:.75rem">
        <button class="btn btn--p btn--lg" onclick="LAB.generatePDF()">ğŸ“„ Download PDF Report</button>
        <button class="btn btn--g" onclick="LAB.goWelcome()">â†º New Assessment</button>
        <a href="index.html" class="btn btn--g">â† Shah Hayaat Home</a>
      </div>
    </div>

  </div>`);

  /* â”€â”€ Draw all rings after render â”€â”€ */
  setTimeout(()=>{
    if (overall !== null) LAB._drawRing('overallRing', overall, '#2A7A5A', 64);
    else {
      // Draw empty grey ring
      const c=document.getElementById('overallRing'); if(c){const ctx=c.getContext('2d');ctx.beginPath();ctx.arc(70,70,64,0,Math.PI*2);ctx.strokeStyle='#E4EAE4';ctx.lineWidth=10;ctx.stroke();}
    }
    domains.forEach(d=>{
      const sc=LAB.scores[d.key]??null;
      if(sc!==null) LAB._drawRing('ring_'+d.key, sc, d.col, 36);
      else {
        const c=document.getElementById('ring_'+d.key); if(c){const ctx=c.getContext('2d');ctx.beginPath();ctx.arc(40,40,36,0,Math.PI*2);ctx.strokeStyle='#E4EAE4';ctx.lineWidth=7;ctx.stroke();}
      }
    });
  },80);

  LAB.celebrate();
  LAB.say(overall !== null
    ? `You have completed all the activities! Your overall wellness score is ${overall} out of a hundred â€” that is ${LAB.scoreLbl(overall)}. Scroll down to see your results and personalised recommendations.`
    : 'You have reached the end, but no tests were completed. Go back and try at least a few activities to get your wellness score.');
};


/* â”€â”€ Donut ring helper â”€â”€ */
LAB._drawRing = function(canvasId, score, color, radius) {
  const canvas=document.getElementById(canvasId); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  const lineW=radius>40?10:7;
  const r=radius;
  ctx.clearRect(0,0,W,H);

  // Background arc
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle='#E8F5EE'; ctx.lineWidth=lineW; ctx.stroke();

  // Score arc (animated)
  const end=-Math.PI/2+((score/100)*Math.PI*2);
  ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,end);
  ctx.strokeStyle=color; ctx.lineWidth=lineW; ctx.lineCap='round'; ctx.stroke();

  // Score text (only for big ring)
  if(radius>40){
    ctx.fillStyle=color; ctx.font=`bold ${Math.round(radius*.48)}px 'JetBrains Mono',monospace`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(score,cx,cy);
  }
};


/* â”€â”€ Breakdown rows â”€â”€ */
LAB._buildBreakdownRows = function() {
  const rows=[
    {label:'âš¡ Reaction Speed',      val:LAB.raw.rxAvg?LAB.raw.rxAvg+'ms avg':'â€”',      score:LAB.raw.rxScore},
    {label:'ğŸ“‰ Fatigue Drift',        val:LAB.raw.ftDrift!==undefined?LAB.raw.ftDrift+'ms drift':'â€”', score:LAB.raw.ftScore},
    {label:'ğŸ§© Memory Span',          val:LAB.raw.memSpan?LAB.raw.memSpan+' items':'â€”',  score:LAB.raw.memScore},
    {label:'ğŸ‘ Attention',            val:LAB.raw.attHits!==undefined?LAB.raw.attHits+' hits':'â€”', score:LAB.raw.attScore},
    {label:'ğŸ¨ Colour Blindness',     val:LAB.raw.cbCorrect!==undefined?LAB.raw.cbCorrect+'/'+LAB.raw.cbTotal+' correct':'â€”', score:LAB.raw.cbScore},
    {label:'ğŸ“ Visual Acuity',        val:LAB.raw.acuityRow>=0?'Row '+(LAB.raw.acuityRow+1)+' seen':'â€”', score:LAB.raw.acuityScore},
    {label:'â¬œ Contrast Sensitivity', val:LAB.raw.csLevel!==undefined?'Level '+LAB.raw.csLevel+'/6':'â€”', score:LAB.raw.csScore},
    {label:'ğŸŒ¬ Breath Sync',          val:'Auto-timed',                                  score:LAB.raw.breathSyncScore},
    {label:'â± Breath Hold',           val:LAB.raw.breathHold?LAB.raw.breathHold+'s held':'â€”', score:LAB.raw.breathScore},
    {label:'â™» Recovery (HRV)',        val:LAB.raw.recoveryBPM?LAB.raw.recoveryBPM+' BPM':'â€”', score:LAB.raw.recoveryScore},
    {label:'ğŸ”¥ Maths Challenge',      val:LAB.raw.mathCorrect!==undefined?LAB.raw.mathCorrect+'/20':'â€”', score:LAB.raw.mathScore},
    {label:'ğŸ”· Pattern Search',       val:LAB.raw.patternCorrect!==undefined?LAB.raw.patternCorrect+'/8':'â€”', score:LAB.raw.patternScore},
    {label:'ğŸ“± Steady Hand',          val:'Motion analysis',                             score:LAB.raw.stabilityScore},
    {label:'âœ Tremor Drawing',        val:LAB.raw.tremorDev!==undefined?LAB.raw.tremorDev+'px dev':'â€”', score:LAB.raw.tremorScore},
    {label:'ğŸ’¤ Sleep',                val:LAB.raw.sleepHours?LAB.raw.sleepHours+'h':'â€”', score:LAB.raw.sleepScore},
    {label:'âš– Lifestyle',            val:'6 dimensions',                                score:LAB.raw.lifestyleScore},
  ];
  if(LAB.gender==='female'){
    rows.push(
      {label:'ğŸŒ¸ Hormonal Rhythm',score:LAB.raw.hormonalScore},
      {label:'âš¡ Energy & Iron',  score:LAB.raw.ironScore},
      {label:'ğŸŒ™ Sleep & Comfort',score:LAB.raw.femCombinedScore},
    );
  }
  return rows.map(r=>{
    const sc=r.score!=null?r.score:null;
    return `<div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;
                        padding:.52rem .2rem;border-bottom:1px solid var(--b)">
      <span style="font-size:.82rem;color:var(--tm);flex:1">${r.label}</span>
      ${r.val?`<span style="font-size:.7rem;color:var(--tq);font-family:'JetBrains Mono',monospace;margin-right:.5rem">${r.val}</span>`:''}
      <span style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;
                   color:${sc!=null?LAB.scoreCol(sc):'var(--tq)'};min-width:30px;text-align:right">
        ${sc!=null?sc:'â€”'}
      </span>
    </div>`;
  }).join('');
};


/* â”€â”€ Flag boxes (eye/iris warnings) â”€â”€ */
LAB._buildFlagBox = function() {
  const flags=[];
  if(LAB.raw.cbFlag) flags.push({icon:'ğŸ¨',title:'Colour Perception',msg:'You may have difficulty distinguishing some colours. Consider a clinical colour blindness test.',col:'var(--bl)'});
  if(LAB.raw.acuityFlag) flags.push({icon:'ğŸ“',title:'Visual Acuity',msg:'Your near-screen vision appears limited. An eye examination is recommended.',col:'var(--am)'});
  if((LAB.scores.respiratory||100)<45) flags.push({icon:'ğŸŒ¬',title:'Respiratory',msg:'Your breathing scores are lower than ideal. Speak to a doctor if you have breathing difficulties.',col:'var(--am)'});
  if((LAB.scores.cognitive||100)<40) flags.push({icon:'ğŸ§ ',title:'Cognitive',msg:'Some cognitive scores were low. Fatigue, stress and poor sleep are common causes. See a doctor if persistent.',col:'var(--am)'});
  if(!flags.length) return '';
  return `<div style="margin-bottom:1.8rem">
    <h3 class="h3" style="margin-bottom:.8rem">âš  Things to Look Into</h3>
    ${flags.map(f=>`<div style="display:flex;align-items:flex-start;gap:.75rem;padding:.85rem 1rem;
                     background:#fff;border:1.5px solid ${f.col};border-radius:var(--rs);margin-bottom:.55rem">
      <span style="font-size:1.1rem">${f.icon}</span>
      <div><strong style="font-size:.85rem;color:var(--t)">${f.title}</strong>
        <p style="font-size:.78rem;color:var(--tm);margin:.15rem 0 0;line-height:1.6">${f.msg}</p></div>
    </div>`).join('')}
  </div>`;
};


/* â”€â”€ Recommendations engine â”€â”€ */
LAB._buildRecs = function() {
  const S=LAB.scores, R=LAB.raw;
  const recs=[];

  // Cognitive
  if((S.cognitive||100)<60)
    recs.push({icon:'ğŸ§©',title:'Brain Training',body:'Daily cognitive challenges â€” puzzles, memory games, or learning a new skill â€” can meaningfully improve processing speed and working memory.',action:'Try 10 min/day',col:'#2A7A5A'});
  if((R.rxAvg||0)>400)
    recs.push({icon:'âš¡',title:'Faster Reactions',body:'Your reaction time is above average. Regular aerobic exercise and reducing screen fatigue before tests can shorten it.',action:'Aerobic exercise',col:'#059669'});

  // Eye
  if(R.cbFlag)
    recs.push({icon:'ğŸ¨',title:'Colour Vision Test',body:'A clinical Ishihara test at an optometrist can confirm colour blindness type and severity in 10 minutes.',action:'Book an eye test',col:'#2563EB'});
  if(R.acuityFlag)
    recs.push({icon:'ğŸ‘“',title:'Eye Examination',body:'Your screen-acuity result was below the typical reading threshold. An optometrist can check for refractive errors.',action:'Book eye exam',col:'#2563EB'});
  if(!R.cbFlag&&!R.acuityFlag&&(S.eye||100)>=70)
    recs.push({icon:'ğŸ‘',title:'Eye Health',body:'Your eye health indicators look good. Maintain the 20-20-20 rule: every 20 minutes, look at something 20 feet away for 20 seconds.',action:'20-20-20 rule',col:'#7C3AED'});

  // Respiratory
  if((R.breathHold||100)<25)
    recs.push({icon:'ğŸ«',title:'Breathing Exercises',body:'Short breath-hold time can indicate high COâ‚‚ sensitivity or anxiety. Box breathing (4-4-4-4) practiced daily builds tolerance.',action:'Box breathing daily',col:'#059669'});
  if((S.respiratory||100)<55)
    recs.push({icon:'ğŸŒ¬',title:'Lung Capacity',body:'Regular aerobic activity â€” walking, swimming or cycling â€” is the most effective way to improve respiratory efficiency over time.',action:'30 min aerobic/day',col:'#059669'});

  // Stress
  if((S.stress||100)<55)
    recs.push({icon:'ğŸ”¥',title:'Stress Management',body:'High stress reduces cognitive performance under pressure. Mindfulness, consistent sleep and limiting caffeine can improve scores.',action:'Try mindfulness',col:'#C97010'});

  // Stability
  if((R.tremorDev||0)>35)
    recs.push({icon:'âœ',title:'Fine Motor Stability',body:'Higher tremor deviation can result from caffeine, poor sleep or stress. Reducing stimulants and practising steady-hand tasks helps.',action:'Reduce caffeine',col:'#7C3AED'});

  // Sleep
  if((R.sleepHours||8)<6)
    recs.push({icon:'ğŸ’¤',title:'Sleep Duration',body:'You slept under 6 hours. Chronic sleep deprivation affects every health dimension measured here. 7â€“9 hours is the recommended range.',action:'Aim for 7â€“9 hrs',col:'#0369A1'});
  if((R.sleepScore||100)<55)
    recs.push({icon:'ğŸŒ™',title:'Sleep Quality',body:'Poor sleep quality affects cognitive, hormonal, and physical health. A consistent bedtime and limiting blue light after 9pm are impactful first steps.',action:'Consistent bedtime',col:'#0369A1'});

  // Lifestyle
  const liBrk=R.lifestyleBreakdown||[];
  if(liBrk[0]<55)
    recs.push({icon:'ğŸ’§',title:'Hydration',body:'You indicated low water intake. Even mild dehydration reduces cognitive performance, mood and energy. Aim for at least 2 litres per day.',action:'Drink 2L water/day',col:'#0284C7'});
  if(liBrk[1]<55)
    recs.push({icon:'ğŸƒ',title:'Physical Activity',body:'Regular movement is the single most evidence-backed intervention for overall health. Even 30 minutes of brisk walking daily makes a measurable difference.',action:'30 min walk daily',col:'#059669'});
  if(liBrk[3]<55)
    recs.push({icon:'ğŸ˜¤',title:'Stress Load',body:'You reported high day-to-day stress. Beyond affecting scores, chronic stress has serious long-term health effects. Consider talking to someone you trust.',action:'Talk to someone',col:'#C97010'});

  // Female specific
  if(LAB.gender==='female'){
    if((R.hormonalScore||100)<55)
      recs.push({icon:'ğŸŒ¸',title:'Hormonal Balance',body:'Irregular cycles or severe PMS can indicate hormonal imbalances. A gynaecologist or GP can run simple blood panels to check.',action:'See a gynaecologist',col:'#B83060'});
    if((R.ironScore||100)<55)
      recs.push({icon:'ğŸ©¸',title:'Iron Levels',body:'Your responses suggest possible iron deficiency, which is very common in women. A simple blood test can confirm. Iron-rich foods and vitamin C absorption help.',action:'Get blood test',col:'#B83060'});
  }

  // Always include a positive
  if((S.cognitive||0)>=75)
    recs.push({icon:'ğŸ†',title:'Strong Cognition',body:'Your cognitive scores are excellent! Keep challenging your brain with varied activities â€” novelty is key to maintaining sharpness.',action:'Keep it up!',col:'#2A7A5A'});

  // Cap at 8 recommendations
  return recs.slice(0,8);
};


/* â”€â”€ General tips based on overall score â”€â”€ */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHAH HAYAAT PRODUCTS â€” Real product catalog, score-driven
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* All 12 real Shah Hayaat products */
LAB.SH_PRODUCTS = {
  brainchamp:   { name:'Brain Champ',    price:175, tag:'ğŸ§  Brain & Focus',     tagColor:'#2A7A5A',
    desc:'Brahmi, Ashwagandha & Shankhpushpi blend to boost memory, cut brain fog and sharpen focus.',
    benefits:'Improves memory Â· Reduces mental fatigue Â· Manages stress' },
  shahzyme:     { name:'Shah Zyme',      price:165, tag:'ğŸ« Digestion',          tagColor:'#059669',
    desc:'Herbal digestive enzyme syrup for gas, bloating and sluggish digestion after meals.',
    benefits:'Relieves bloating Â· Improves absorption Â· Stimulates appetite' },
  bloodstorm:   { name:'Blood Storm',    price:165, tag:'ğŸ©¸ Blood & Energy',     tagColor:'#C0392B',
    desc:'Iron-rich Ayurvedic tonic to raise haemoglobin, fight anaemia and restore vitality.',
    benefits:'Raises haemoglobin Â· Combats anaemia Â· Restores energy' },
  coughxpro:    { name:'Cough X Pro',    price:90,  tag:'ğŸ˜®â€ğŸ’¨ Respiratory',       tagColor:'#0891B2',
    desc:'Tulsi & Mulethi syrup to soothe airways, clear mucus and relieve chronic cough.',
    benefits:'Soothes throat Â· Reduces congestion Â· Anti-inflammatory' },
  musaffakhoon: { name:'Musaffa Khoon',  price:165, tag:'âœ¨ Skin Care',           tagColor:'#7C3AED',
    desc:'Classical blood purifier â€” clears acne, psoriasis and dull skin from the root cause.',
    benefits:'Purifies blood Â· Clears acne Â· Promotes glow' },
  panasip:      { name:'PanaSip',        price:165, tag:'ğŸ”¥ Acidity',            tagColor:'#EA580C',
    desc:'Cooling herbal antacid to neutralise acid, heal ulcers and stop heartburn naturally.',
    benefits:'Neutralises acid Â· Soothes inflammation Â· Heals ulcers' },
  livohayaat:   { name:'Livo Hayaat',    price:349, tag:'ğŸŸ¤ Liver Health',       tagColor:'#92400E',
    desc:'Hepatoprotective formula with Bhumi Amla & Kutki to detox liver and normalise enzymes.',
    benefits:'Regenerates liver cells Â· Reduces fatty liver Â· Antioxidant' },
  diaease:      { name:'Dia-Ease',       price:695, tag:'ğŸ¬ Diabetes Care',      tagColor:'#0F766E',
    desc:'Karela, Jamun & Gurmar combination to support healthy blood sugar balance naturally.',
    benefits:'Supports blood sugar Â· Improves insulin sensitivity Â· Safe' },
  orthohayaat:  { name:'Ortho Hayaat',   price:649, tag:'ğŸ¦´ Joint Care',         tagColor:'#7C3AED',
    desc:'Shallaki & Guggul anti-inflammatory blend for joint pain, arthritis and mobility.',
    benefits:'Reduces joint pain Â· Improves mobility Â· Strengthens bones' },
  utrohayaat:   { name:'Utro Hayaat',    price:625, tag:'ğŸŒ¸ Female Health',      tagColor:'#BE185D',
    desc:'Ashoka & Shatavari tonic to regulate cycles, relieve period pain and balance hormones.',
    benefits:'Regulates cycles Â· Relieves period pain Â· Hormonal balance' },
  passionpulse: { name:'Passion Pulse',  price:599, tag:'âš¡ Male Vitality',      tagColor:'#1D4ED8',
    desc:'Ashwagandha, Shilajit & Safed Musli for stamina, libido and male reproductive health.',
    benefits:'Enhances stamina Â· Improves libido Â· Supports testosterone' },
  fevodol:      { name:'Fevodol',        price:165, tag:'ğŸ›¡ Immunity',            tagColor:'#2A7A5A',
    desc:'Giloy & Tulsi immunity booster to fight fever, infections and strengthen body defences.',
    benefits:'Boosts immunity Â· Antipyretic Â· Anti-infective' },
};

LAB._buildProductCards = function () {
  const S = LAB.scores, R = LAB.raw, P = LAB.SH_PRODUCTS;
  const isFem = LAB.gender === 'female';
  const isMale = LAB.gender === 'male';
  const selected = [];

  // â”€â”€â”€ Score-driven selection â€” real products, accurate mapping â”€â”€â”€

  // Cognitive low â†’ Brain Champ
  if ((S.cognitive ?? 100) < 75 || (R.memSpan ?? 9) < 5 || (R.rxAvg ?? 0) > 350)
    selected.push({ ...P.brainchamp, id:'brainchamp', reason:'Your cognitive score suggests memory or focus support.' });

  // Respiratory low â†’ Cough X Pro
  if ((S.respiratory ?? 100) < 70 || (R.breathHold ?? 999) < 25)
    selected.push({ ...P.coughxpro, id:'coughxpro', reason:'Breathing scores indicate respiratory support may help.' });

  // Stress low / sleep poor â†’ Blood Storm (energy) + lifestyle
  if ((S.stress ?? 100) < 70 || (R.sleepHours ?? 8) < 6)
    selected.push({ ...P.bloodstorm, id:'bloodstorm', reason:'Low energy or stress scores detected.' });

  // Liver / lifestyle â†’ Livo Hayaat
  if ((S.lifestyle ?? 100) < 65)
    selected.push({ ...P.livohayaat, id:'livohayaat', reason:'Lifestyle scores suggest a detox and liver support.' });

  // Stability / tremor low â†’ Ortho Hayaat
  if ((S.stability ?? 100) < 65 || (R.tremorDev ?? 0) > 30)
    selected.push({ ...P.orthohayaat, id:'orthohayaat', reason:'Motor stability scores point to joint/nerve support.' });

  // Eye health low â†’ Musaffa Khoon (circulation/blood purifier helps eyes)
  if ((S.eye ?? 100) < 70 || R.cbFlag || R.acuityFlag)
    selected.push({ ...P.musaffakhoon, id:'musaffakhoon', reason:'Blood purification supports eye health and clarity.' });

  // Female health
  if (isFem && (S.hormonal ?? 100) < 75)
    selected.push({ ...P.utrohayaat, id:'utrohayaat', reason:'Hormonal rhythm scores indicate female tonic support.' });

  // Female energy/iron
  if (isFem && (R.ironScore ?? 100) < 70)
    selected.push({ ...P.bloodstorm, id:'bloodstorm', reason:'Iron and energy indicators suggest blood support.' });

  // Male vitality
  if (isMale && (S.stress ?? 100) < 65)
    selected.push({ ...P.passionpulse, id:'passionpulse', reason:'Stress and energy scores may benefit from vitality support.' });

  // Immunity â€” always show if any score below 60
  const anyLow = Object.values(S).some(v => v != null && v < 60);
  if (anyLow)
    selected.push({ ...P.fevodol, id:'fevodol', reason:'Multiple low scores â€” immunity support recommended.' });

  // Deduplicate
  const seen = new Set();
  const unique = selected.filter(p => { if (seen.has(p.id)) return false; seen.add(p.id); return true; });

  // Always add at least Brain Champ and 1 more if nothing was selected
  if (unique.length === 0) {
    unique.push({ ...P.brainchamp, id:'brainchamp', reason:'General wellness maintenance.' });
    unique.push({ ...P.fevodol,    id:'fevodol',    reason:'Strengthen your immune defences.' });
  }

  // Cap at 6 cards
  const show = unique.slice(0, 6);

  const WA = '917051056287';

  return show.map(p => {
    const waMsg = encodeURIComponent(`Hi Shah Hayaat! I completed the Wellness Lab assessment and would like to order *${p.name}* (â‚¹${p.price}). Please help me place my order.`);
    return `
    <div style="background:#fff;border:1.5px solid var(--b);border-radius:var(--r);overflow:hidden;
                box-shadow:0 2px 10px rgba(0,0,0,.05);
                transition:transform .22s cubic-bezier(.4,0,.2,1),box-shadow .22s;display:flex;flex-direction:column"
         onmouseenter="this.style.transform='translateY(-5px)';this.style.boxShadow='0 14px 32px rgba(0,0,0,.1)'"
         onmouseleave="this.style.transform='none';this.style.boxShadow='0 2px 10px rgba(0,0,0,.05)'">
      <div style="height:3px;background:${p.tagColor}"></div>
      <div style="padding:.9rem 1rem;flex:1;display:flex;flex-direction:column;gap:.4rem">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:.4rem">
          <span style="font-size:.58rem;font-weight:700;color:${p.tagColor};background:${p.tagColor}18;
                       padding:.2rem .55rem;border-radius:50px;white-space:nowrap">${p.tag}</span>
          <span style="font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;
                       color:var(--g);white-space:nowrap">â‚¹${p.price}</span>
        </div>
        <div style="font-weight:700;font-size:.92rem;color:var(--t);line-height:1.25">${p.name}</div>
        <div style="font-size:.74rem;color:var(--tq);line-height:1.58;flex:1">${p.desc}</div>
        <div style="font-size:.64rem;color:var(--g);font-weight:600;margin-top:.1rem">âœ“ ${p.benefits.replace(/Â·/g,'&nbsp;&nbsp;Â·&nbsp;')}</div>
        ${p.reason ? `<div style="font-size:.62rem;color:var(--am);font-style:italic;margin-top:.15rem">ğŸ’¡ ${p.reason}</div>` : ''}
      </div>
      <div style="padding:.7rem 1rem;border-top:1px solid var(--b);display:flex;gap:.5rem;flex-wrap:wrap">
        <a href="https://wa.me/${WA}?text=${waMsg}" target="_blank" rel="noopener"
           style="flex:1;display:inline-flex;align-items:center;justify-content:center;gap:.35rem;
                  background:#25D366;color:#fff;border-radius:50px;padding:.45rem .7rem;
                  font-size:.72rem;font-weight:700;text-decoration:none;white-space:nowrap;
                  transition:opacity .18s" onmouseenter="this.style.opacity='.85'" onmouseleave="this.style.opacity='1'">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
          Order on WhatsApp
        </a>
        <a href="https://yasirhashmi02-dev.github.io/Shahhayaat02/product-detail.html?id=${p.id}"
           target="_blank" rel="noopener"
           style="display:inline-flex;align-items:center;padding:.45rem .7rem;
                  background:var(--g3);color:var(--g);border-radius:50px;
                  font-size:.72rem;font-weight:700;text-decoration:none;white-space:nowrap;
                  transition:background .18s" onmouseenter="this.style.background='var(--g2)'" onmouseleave="this.style.background='var(--g3)'">
          Details â†’
        </a>
      </div>
    </div>`;
  }).join('');
};


/* â”€â”€â”€ WhatsApp Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
LAB.whatsappShare = function () {
  const S = LAB.scores, R = LAB.raw;
  const allDomains = [S.cognitive, S.eye, S.respiratory, S.stress, S.stability, S.lifestyle];
  if (LAB.gender === 'female' && S.hormonal != null) allDomains.push(S.hormonal);
  const completed = allDomains.filter(x => x != null);
  const overall   = completed.length ? Math.round(LAB.avg(completed)) : null;
  const name      = (document.getElementById('pdfNameInp')?.value || '').trim();
  const now       = new Date().toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'});

  let msg = `*Shah Hayaat Wellness Lab â€” Personal Report*
`;
  msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
  if (name) msg += `ğŸ‘¤ *Name:* ${name}
`;
  msg += `ğŸ“… *Date:* ${now}
`;
  msg += `ğŸ”¬ *Tests completed:* ${completed.length} of 6 domains

`;
  msg += `*Overall Wellness Score: ${overall !== null ? overall + ' / 100' : 'Incomplete'}*
`;
  if (overall !== null) msg += `Rating: ${LAB.scoreLbl(overall)}
`;
  msg += `
ğŸ“Š *Domain Breakdown:*
`;
  if (S.cognitive   != null) msg += `ğŸ§  Cognitive:     ${S.cognitive}/100
`;
  if (S.eye         != null) msg += `ğŸ‘  Eye Health:    ${S.eye}/100
`;
  if (S.respiratory != null) msg += `ğŸŒ¬  Respiratory:   ${S.respiratory}/100
`;
  if (S.stress      != null) msg += `ğŸ”¥ Stress/Mental: ${S.stress}/100
`;
  if (S.stability   != null) msg += `ğŸ“± Motor Stab.:   ${S.stability}/100
`;
  if (S.lifestyle   != null) msg += `âš–  Lifestyle:     ${S.lifestyle}/100
`;
  if (S.hormonal    != null) msg += `ğŸŒ¸ Hormonal:      ${S.hormonal}/100
`;
  msg += `
Hi Shah Hayaat team â€” I would love to get your expert advice on these results and which products might help me. Please let me know when you are available for a consultation.
`;
  msg += `
_Report from: Shah Hayaat Wellness Lab_
_https://yasirhashmi02-dev.github.io/Shahhayaat02/wellness-lab.html_`;

  const url = `https://wa.me/917051056287?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank', 'noopener,noreferrer');
};

LAB._buildTips = function(overall) {
  const tips=[
    {icon:'ğŸ’§',text:'<strong>Drink water first thing.</strong> Starting the day with 400â€“500ml of water rehydrates your brain after sleep and improves morning alertness.'},
    {icon:'ğŸš¶',text:'<strong>Walk after meals.</strong> A 10-minute walk after eating improves blood sugar regulation, digestion and afternoon energy â€” no gym required.'},
    {icon:'ğŸ“µ',text:'<strong>No screens 45 min before bed.</strong> Blue light delays melatonin release. This single habit measurably improves sleep depth over 2â€“3 weeks.'},
    {icon:'ğŸŒ¬',text:'<strong>Box breathing for stress.</strong> Inhale 4s Â· Hold 4s Â· Exhale 4s Â· Hold 4s. Two minutes of this activates the parasympathetic system immediately.'},
    {icon:'ğŸ¥—',text:'<strong>Eat colourfully.</strong> The most practical nutrition advice: aim for 5â€“6 different colours of vegetables/fruits per day. Diversity beats quantity.'},
    {icon:'ğŸ˜´',text:'<strong>Consistent wake time.</strong> Waking at the same time every day (even weekends) is the fastest way to fix sleep quality â€” stronger effect than bedtime.'},
    {icon:'ğŸ§ ',text:'<strong>Learn something new.</strong> Daily exposure to novel cognitive challenges â€” a language, an instrument, a puzzle type â€” builds cognitive reserve that protects brain health long-term.'},
  ];
  if(overall<55) tips.push({icon:'ğŸ©º',text:'<strong>Consider a health check-up.</strong> Several of your scores were below average. A general check-up with your doctor is a sensible next step.'});
  return tips.map(t=>`
    <div style="display:flex;align-items:flex-start;gap:.75rem;padding:.72rem 0;border-bottom:1px solid var(--b)">
      <span style="font-size:1.05rem;flex-shrink:0;margin-top:.05rem">${t.icon}</span>
      <p style="font-size:.82rem;color:var(--tm);line-height:1.7;margin:0">${t.text}</p>
    </div>`).join('');
};


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHITE PDF REPORT GENERATOR
   Uses browser print â€” opens a clean printable page.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
LAB.generatePDF = function () {
  const S=LAB.scores, R=LAB.raw, isFem=LAB.gender==='female';
  const mainScores=[S.cognitive,S.eye,S.respiratory,S.stress,S.stability,S.lifestyle,...(isFem&&S.hormonal?[S.hormonal]:[])].filter(x=>x!=null);
  const completedForPDF=mainScores.filter(x=>x!=null);
  const overall=completedForPDF.length?Math.round(LAB.avg(completedForPDF)):null;
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  const recs=LAB._buildRecs();
  const userName=(document.getElementById('pdfNameInp')?.value||'').trim();

  const scoreRows=[
    ['ğŸ§  Cognitive',   S.cognitive||'â€”'],
    ['ğŸ‘ Eye Health',  S.eye||'â€”'],
    ['ğŸŒ¬ Respiratory', S.respiratory||'â€”'],
    ['ğŸ”¥ Stress',      S.stress||'â€”'],
    ['ğŸ“± Stability',   S.stability||'â€”'],
    ['âš– Lifestyle',   S.lifestyle||'â€”'],
    ...(isFem&&S.hormonal?[['ğŸŒ¸ Hormonal',S.hormonal]]:[] ),
  ];

  const detailRows=[
    ['âš¡ Reaction Speed',     R.rxAvg?R.rxAvg+'ms avg':'Skipped', R.rxScore],
    ['ğŸ“‰ Fatigue Drift',       R.ftDrift!==undefined?R.ftDrift+'ms drift':'Skipped', R.ftScore],
    ['ğŸ§© Memory Span',         R.memSpan?R.memSpan+' items':'Skipped', R.memScore],
    ['ğŸ‘ Attention',           R.attHits!==undefined?R.attHits+' hits':'Skipped', R.attScore],
    ['ğŸ¨ Colour Blindness',    R.cbCorrect!==undefined?R.cbCorrect+'/'+R.cbTotal:'Skipped', R.cbScore],
    ['ğŸ“ Visual Acuity',       R.acuityRow>=0?'Row '+(R.acuityRow+1):'Skipped', R.acuityScore],
    ['â¬œ Contrast Sensitivity',R.csLevel!==undefined?'Level '+R.csLevel+'/6':'Skipped', R.csScore],
    ['ğŸŒ¬ Breath Sync',         'Completed', R.breathSyncScore],
    ['â± Breath Hold',          R.breathHold?R.breathHold+'s held':'Skipped', R.breathScore],
    ['â™» Recovery (HRV)',       R.recoveryBPM?R.recoveryBPM+' BPM':'Skipped', R.recoveryScore],
    ['ğŸ”¥ Maths Challenge',     R.mathCorrect!==undefined?R.mathCorrect+'/20':'Skipped', R.mathScore],
    ['ğŸ”· Pattern Search',      R.patternCorrect!==undefined?R.patternCorrect+'/8':'Skipped', R.patternScore],
    ['ğŸ“± Steady Hand',         'Completed', R.stabilityScore],
    ['âœ Tremor Drawing',       R.tremorDev!==undefined?R.tremorDev+'px deviation':'Skipped', R.tremorScore],
    ['ğŸ’¤ Sleep Quality',        R.sleepHours?R.sleepHours+'h':'Skipped', R.sleepScore],
    ['âš– Lifestyle Score',      '6 dimensions', R.lifestyleScore],
    ...(isFem?[
      ['ğŸŒ¸ Hormonal Rhythm','Questionnaire',R.hormonalScore],
      ['âš¡ Energy & Iron','Questionnaire',R.ironScore],
      ['ğŸŒ™ Sleep & Comfort','Questionnaire',R.femCombinedScore],
    ]:[]),
  ];

  const barOf=(sc)=>{
    if(sc==null) return '<span style="color:#888;font-size:11px">Skipped</span>';
    const col=sc>=80?'#1A8C52':sc>=55?'#C97010':'#C0392B';
    return `<div style="display:flex;align-items:center;gap:6px">
      <div style="flex:1;height:8px;background:#E8F5EE;border-radius:4px;overflow:hidden">
        <div style="width:${sc}%;height:100%;background:${col};border-radius:4px"></div>
      </div>
      <span style="font-size:12px;font-weight:700;color:${col};min-width:28px;text-align:right">${sc}</span>
    </div>`;
  };

  const html=`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shah Hayaat Wellness Report â€” ${dateStr}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:#fff;color:#1C2E1C;line-height:1.7;font-size:14px;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  @page{size:A4;margin:16mm 14mm}
  @media print{.no-print{display:none!important}.page-break{page-break-before:always}}
  .no-print{position:fixed;bottom:20px;right:20px;display:flex;gap:10px;z-index:100}
  .pbtn{padding:10px 22px;border-radius:50px;font-weight:700;font-size:13px;cursor:pointer;border:none}
  .pbtn-p{background:#2A7A5A;color:#fff}
  .pbtn-g{background:#fff;border:2px solid #D4E8DC;color:#3A5A3A}
  /* Layout */
  .page{max-width:780px;margin:0 auto;padding:0 4px}
  /* Header */
  .report-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;
    background:linear-gradient(135deg,#1A4731,#2A7A5A);border-radius:12px;margin-bottom:22px;color:#fff}
  .hdr-logo{display:flex;align-items:center;gap:12px}
  .hdr-logo img{width:44px;height:44px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover}
  .hdr-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;line-height:1.1}
  .hdr-sub{font-size:11px;opacity:.75;letter-spacing:.08em;text-transform:uppercase;margin-top:2px}
  .hdr-meta{text-align:right;font-size:11px;opacity:.8;line-height:1.8}
  /* Overall score */
  .overall-row{display:flex;align-items:center;gap:20px;padding:18px 20px;
    background:#F3F7F3;border:1.5px solid #D4E8DC;border-radius:12px;margin-bottom:22px}
  .overall-num{font-family:'Playfair Display',serif;font-size:52px;font-weight:700;
    color:#2A7A5A;line-height:1;min-width:80px;text-align:center}
  .overall-info{flex:1}
  .overall-lbl{font-size:11px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;
    letter-spacing:.1em;color:#6A8A6A;margin-bottom:4px}
  .overall-rating{font-size:18px;font-weight:700;color:#2A7A5A;margin-bottom:6px}
  .overall-sub{font-size:12px;color:#3A5A3A}
  /* Section headers */
  .sec-hdr{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:#1C2E1C;
    border-bottom:2.5px solid #2A7A5A;padding-bottom:6px;margin:22px 0 14px}
  /* Score grid */
  .score-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:22px}
  .score-card{background:#fff;border:1.5px solid #D4E8DC;border-radius:10px;padding:14px;text-align:center;position:relative;overflow:hidden}
  .score-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--c)}
  .sc-icon{font-size:20px;margin-bottom:6px}
  .sc-name{font-size:10px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;
    letter-spacing:.08em;color:#6A8A6A;margin-bottom:4px}
  .sc-num{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;color:var(--c);line-height:1}
  .sc-lbl{font-size:11px;font-weight:600;color:var(--c);margin-top:2px}
  /* Detail table */
  .dtable{width:100%;border-collapse:collapse;font-size:12.5px;margin-bottom:22px}
  .dtable th{background:#F3F7F3;padding:8px 10px;text-align:left;font-size:11px;
    font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:#6A8A6A;
    border-bottom:2px solid #D4E8DC}
  .dtable td{padding:7px 10px;border-bottom:1px solid #E8F5EE;vertical-align:middle}
  .dtable tr:hover td{background:#FAFBF8}
  .tag-skip{background:#F5F5F5;color:#888;font-size:11px;padding:2px 8px;border-radius:50px}
  /* Recs */
  .rec-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:22px}
  .rec-card{background:#fff;border:1.5px solid #D4E8DC;border-radius:10px;overflow:hidden}
  .rec-top{height:4px}
  .rec-body{padding:11px 12px}
  .rec-title{font-weight:700;font-size:13px;margin-bottom:4px;color:#1C2E1C}
  .rec-text{font-size:11.5px;color:#3A5A3A;line-height:1.6;margin-bottom:7px}
  .rec-action{font-size:11px;font-weight:700;padding:3px 10px;border-radius:50px;display:inline-block}
  /* Tips */
  .tip-row{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #E8F5EE;font-size:12.5px;color:#3A5A3A;line-height:1.6}
  .tip-icon{font-size:14px;flex-shrink:0;margin-top:2px}
  /* Disclaimer */
  .disc{background:#F3F7F3;border:1px solid #D4E8DC;border-radius:8px;padding:12px 14px;
    font-size:11px;color:#6A8A6A;line-height:1.75;margin-top:18px}
  .disc strong{color:#2A7A5A}
  /* Footer */
  .rpt-footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;
    padding-top:12px;border-top:1px solid #D4E8DC;font-size:10.5px;color:#6A8A6A}
</style>
</head>
<body>
<div class="no-print" style="display:flex;gap:8px;flex-wrap:wrap;bottom:16px;right:16px;position:fixed;z-index:100">
  <button class="pbtn pbtn-p" onclick="window.print()">ğŸ–¨ Print / Save PDF</button>
  <button class="pbtn" style="background:#25D366;color:#fff" onclick="window.opener&&window.opener.LAB&&window.opener.LAB.whatsappShare()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="white" style="vertical-align:middle;margin-right:4px"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    Share on WhatsApp
  </button>
  <button class="pbtn pbtn-g" onclick="window.close()">âœ• Close</button>
</div>
<div class="page">

  <!-- Header -->
  <div class="report-hdr">
    <div class="hdr-logo">
      <img src="https://raw.githubusercontent.com/yasirhashmi02-dev/Shahhayaat02/main/logo.jpg" alt="Shah Hayaat">
      <div>
        <div class="hdr-title">Shah Hayaat Wellness Lab</div>
        <div class="hdr-sub">Personal Wellness Intelligence Report</div>
      </div>
    </div>
    <div class="hdr-meta">
      ${userName?`<div style="font-size:13px;font-weight:600;letter-spacing:.01em;margin-bottom:3px">Prepared for: ${userName}</div>`:''}
      <div>${dateStr}</div>
      <div>${isFem?'19':'16'} Activities Completed</div>
      <div style="margin-top:4px;font-size:10px;opacity:.6">Private Â· All data processed locally Â· Nothing stored</div>
    </div>
  </div>

  <!-- Overall Score -->
  <div class="overall-row">
    <div class="overall-num">${overall}</div>
    <div class="overall-info">
      ${userName?`<div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:#6A8A6A;text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">${userName}</div>`:''}
      <div class="overall-lbl">Overall Wellness Score</div>
      <div class="overall-rating">${LAB.scoreLbl(overall)} â€” ${overall}/100</div>
      <div class="overall-sub">Combined from ${isFem?'7':'6'} health domains across ${isFem?'19':'16'} wellness activities.</div>
      <div style="margin-top:8px;height:10px;background:#D4E8DC;border-radius:5px;overflow:hidden">
        <div style="width:${overall}%;height:100%;background:${LAB.scoreCol(overall)};border-radius:5px"></div>
      </div>
    </div>
  </div>

  <!-- Domain Scores -->
  <div class="sec-hdr">Health Domain Scores</div>
  <div class="score-grid">
    ${scoreRows.map(([name,sc])=>{
      const col=sc!=='â€”'?LAB.scoreCol(Number(sc)):'#888';
      return `<div class="score-card" style="--c:${col}">
        <div class="sc-name">${name}</div>
        <div class="sc-num">${sc}</div>
        <div class="sc-lbl">${sc!=='â€”'?LAB.scoreLbl(Number(sc)):'Skipped'}</div>
      </div>`;
    }).join('')}
  </div>

  <!-- Activity Detail -->
  <div class="sec-hdr">Activity Results</div>
  <table class="dtable">
    <thead><tr>
      <th>Activity</th><th>Result</th><th style="min-width:160px">Score</th>
    </tr></thead>
    <tbody>
      ${detailRows.map(([name,val,sc])=>`
        <tr>
          <td style="font-weight:500">${name}</td>
          <td style="color:#6A8A6A;font-size:12px">${val}</td>
          <td>${barOf(sc)}</td>
        </tr>`).join('')}
    </tbody>
  </table>

  <!-- Flags -->
  ${(()=>{
    const f=[];
    if(R.cbFlag) f.push('ğŸ¨ Colour perception â€” consider a clinical eye test');
    if(R.acuityFlag) f.push('ğŸ“ Visual acuity â€” screen vision below typical threshold');
    if((S.respiratory||100)<45) f.push('ğŸŒ¬ Respiratory scores are low â€” speak to a doctor if you have breathing difficulties');
    if(!f.length) return '';
    return `<div style="background:#FFF8ED;border:1.5px solid rgba(201,120,0,.3);border-radius:10px;padding:12px 14px;margin-bottom:18px">
      <div style="font-weight:700;font-size:13px;color:#C97010;margin-bottom:8px">âš  Items Worth Investigating</div>
      ${f.map(t=>`<div style="font-size:12.5px;color:#3A5A3A;padding:4px 0;border-bottom:1px solid rgba(201,120,0,.15)">${t}</div>`).join('')}
    </div>`;
  })()}

  <!-- Recommendations -->
  <div class="page-break"></div>
  <div class="sec-hdr">Personalised Recommendations</div>
  <div class="rec-grid">
    ${recs.map(r=>`
      <div class="rec-card">
        <div class="rec-top" style="background:${r.col}"></div>
        <div class="rec-body">
          <div style="font-size:18px;margin-bottom:5px">${r.icon}</div>
          <div class="rec-title">${r.title}</div>
          <div class="rec-text">${r.body}</div>
          <div class="rec-action" style="background:${r.col}20;color:${r.col}">${r.action}</div>
        </div>
      </div>`).join('')}
  </div>

  <!-- Tips -->
  <div class="sec-hdr">General Wellness Tips</div>
  ${LAB._buildTips(overall).replace(/<div style="display:flex.*?padding:.72rem 0;border-bottom:1px solid var\(--b\)">/g,
    '<div class="tip-row">').replace(/<span style="font-size:1\.05rem;flex-shrink:0;margin-top:\.05rem">/g,
    '<span class="tip-icon">').replace(/var\(--tm\)/g,'#3A5A3A').replace(/var\(--t\)/g,'#1C2E1C')}

  <!-- Disclaimer -->
  <div class="disc">
    <strong>Important Disclaimer:</strong> This report is a wellness indicator only and does not constitute medical advice or diagnosis.
    The activities measure performance proxies under screen-based conditions. Results can be affected by fatigue, stress, lighting, device type and many other factors.
    If any result concerns you, please consult a qualified healthcare professional.
    <strong>No data has been transmitted.</strong> All calculations were performed locally in your browser. This PDF was generated on your device.
  </div>

  <!-- Footer -->
  <div class="rpt-footer">
    <span>Shah Hayaat Wellness Lab &nbsp;Â·&nbsp; shahhayaat.com</span>
    <span>Generated ${dateStr} &nbsp;Â·&nbsp; Confidential &nbsp;Â·&nbsp; For personal use only</span>
  </div>

</div>
</body>
</html>`;

  const win=window.open('','_blank','width=900,height=700');
  if(!win){ alert('Please allow pop-ups to generate the PDF.'); return; }
  win.document.write(html);
  win.document.close();
  win.focus();
};

console.log('[WellnessLab v2 Part 4] Complete â€” Female (3) + Dashboard + Recs + White PDF loaded.');
</script>

</body>
</html>
